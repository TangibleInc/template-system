{"version":3,"file":"paginator.min.js","sources":["../src/range.ts","../src/index.ts"],"sourcesContent":["/**\n * Pagination algorithm\n *\n * Based on ideas from: https://gist.github.com/kottenator/9d936eb3e4e3c3e02598\n */\n\nconst getRange = (start, end) => {\n  return Array(end - start + 1)\n    .fill()\n    .map((v, i) => i + start)\n}\n\nexport const generatePageRange = (currentPage, totalPages) => {\n  let delta\n\n  if (totalPages <= 7) {\n    // delta === 7: [1 2 3 4 5 6 7]\n    delta = 7\n  } else {\n    // delta === 2: [1 ... 4 5 6 ... 10]\n    // delta === 4: [1 2 3 4 5 ... 10]\n    delta = currentPage > 4 && currentPage < totalPages - 3 ? 2 : 4\n  }\n\n  const range = {\n    start: Math.round(currentPage - delta / 2),\n    end: Math.round(currentPage + delta / 2),\n  }\n\n  if (range.start - 1 === 1 || range.end + 1 === totalPages) {\n    range.start += 1\n    range.end += 1\n  }\n\n  let pages =\n    currentPage > delta\n      ? getRange(\n          Math.min(range.start, totalPages - delta),\n          Math.min(range.end, totalPages)\n        )\n      : getRange(1, Math.min(totalPages, delta + 1))\n\n  const dots = '...' // '&hellip;' or 'â€¦'\n  const withDots = (value, pair) =>\n    pages.length + 1 !== totalPages ? pair : [value]\n\n  if (pages[0] !== 1) {\n    pages = withDots(1, [1, dots]).concat(pages)\n  }\n\n  if (pages[pages.length - 1] < totalPages) {\n    pages = pages.concat(withDots(totalPages, [dots, totalPages]))\n  }\n\n  return pages\n}\n\n// Quick test\n// for (let i = 1, l = 10; i <= l; i++)\n//   console.log(`Selected page ${i}:`, generatePageRange(i, l));\n","import { generatePageRange } from './range'\n\nconst {\n  jQuery: $,\n  Tangible: { ajax },\n} = window\n\nfunction activatePaginators() {\n  $('.tangible-paginator-target').each(function () {\n    createPaginator($(this))\n  })\n}\n\n$(activatePaginators)\n\n// Export for dynamically loaded content\nwindow.Tangible.activatePaginators = activatePaginators\n// window.Tangible.activatePaginator = activatePaginator__deprecated\n\n/**\n * Create paginator\n */\n\nfunction createPaginator($target) {\n  const targetId = $target.data('tangiblePaginatorTargetId')\n  const targetData = $target.data('tangiblePaginatorTargetData') || {}\n\n  // console.log('Create paginator', targetId, targetData)\n\n  // @see /tags/loop/paginate/loop.php\n  const { state, template, hash, context, context_hash } = targetData\n\n  if (!state || !template) return\n\n  const additionalSettings = {}\n\n  // Subscribers are updated on paginator state change\n  const $subscribers = $(`.tangible-paginator-subscribe--${targetId}`)\n\n  function setState(newState) {\n    Object.assign(state, newState)\n    render(state)\n  }\n\n  const $fields = {}\n  let $loading\n  let $buttonsContainer\n\n  $subscribers.each(function () {\n    const $subscriber = $(this)\n    const actionName = $subscriber.data('tangiblePaginatorSubscribeAction')\n\n    switch (actionName) {\n      case 'fields':\n        $subscriber.find('[data-tangible-paginator-field]').each(function () {\n          const $field = $(this)\n          const fieldName = $field.data('tangiblePaginatorField')\n\n          $fields[fieldName] = $field\n        })\n\n        // console.log('Fields subscribed', Object.keys($fields))\n\n        break\n      case 'loading':\n        $loading = $subscriber\n        break\n      case 'buttons':\n        $buttonsContainer = $subscriber\n        renderPaginationButtons($buttonsContainer, state, setState)\n\n        /**\n         * Pass additional settings, such as scroll_top\n         * @see /tags/loop/paginate/buttons.php\n         */\n\n        const subscribeSettings = $subscriber.data(\n          'tangiblePaginatorSubscribeSettings'\n        )\n        if (\n          typeof subscribeSettings === 'object' &&\n          !Array.isArray(subscribeSettings)\n        ) {\n          Object.assign(additionalSettings, subscribeSettings)\n        }\n        break\n      default:\n        console.warn('Unknown subscriber action', actionName)\n        break\n    }\n  })\n\n  function updateFields(state) {\n    Object.keys($fields).forEach(function (fieldName) {\n      $fields[fieldName].text(state[fieldName])\n    })\n  }\n\n  const cachedPages = {} // pageNumber: content\n\n  // Keep track of last rendered page\n  state.last_rendered_page = state.current_page\n\n  // Page rendered on server-side\n  cachedPages[state.current_page] = $target.html()\n\n  function render(state) {\n    updateFields(state)\n\n    if ($buttonsContainer) {\n      renderPaginationButtons($buttonsContainer, state)\n    }\n\n    // Fetch page via AJAX\n\n    // Same page?\n    if (state.last_rendered_page === state.current_page) return\n    state.last_rendered_page = state.current_page\n\n    const afterLoaded = function () {\n      // Scroll to top\n      if (additionalSettings.scroll_top) {\n        const targetTop = $target.offset().top\n\n        if (!additionalSettings.scroll_animate) {\n          // Jump with no animation\n          $([document.documentElement, document.body]).scrollTop(targetTop)\n          return\n        }\n\n        const duration =\n          typeof additionalSettings.scroll_animate === 'number'\n            ? additionalSettings.scroll_animate\n            : 300\n\n        $([document.documentElement, document.body]).animate(\n          {\n            scrollTop: targetTop,\n          },\n          duration\n        )\n      }\n    }\n\n    // Cached\n    if (typeof cachedPages[state.current_page] !== 'undefined') {\n      $target.html(cachedPages[state.current_page])\n      afterLoaded()\n      return\n    }\n\n    const loadingClass = 'tangible-paginator-target-loading'\n    const currentPage = state.current_page\n\n    const startLoading = function () {\n      $target.addClass(loadingClass)\n\n      // TODO: Option to fade in/out loading indicator\n\n      if ($loading) $loading.show()\n    }\n\n    const finishLoading = function () {\n      $target.removeClass(loadingClass)\n\n      if ($loading) $loading.hide()\n\n      afterLoaded()\n    }\n\n    startLoading()\n\n    // Prevent repeated requests to same page\n    cachedPages[currentPage] = ''\n\n    // @see /ajax/index.php\n    ajax('tangible_template_render', {\n      template,\n      page: currentPage,\n      hash,\n      context,\n      context_hash,\n    })\n      .then((result) => {\n        // console.log('Fetch page result', result)\n\n        cachedPages[currentPage] = result\n        $target.html(result)\n        finishLoading()\n      })\n      .catch((error) => {\n        console.error('Fetch page error', error)\n\n        delete cachedPages[currentPage]\n\n        finishLoading()\n      })\n  }\n}\n\nfunction renderPaginationButtons($buttonsContainer, state, setState) {\n  const { current_page: currentPage, total_pages: totalPages } = state\n\n  const pageNumbers = generatePageRange(currentPage, totalPages)\n\n  // Add new buttons, or replace existing ones\n\n  const $existingButtons = $buttonsContainer.children()\n\n  pageNumbers.forEach(function (num, index) {\n    const $button = $('<button />')\n\n    $button.text(num)\n    $button.addClass('tangible-paginator-button')\n\n    if (num === '...') {\n      $button.prop('disabled', true)\n    } else {\n      $button.attr('data-tangible-paginator-action', 'page')\n      $button.attr('data-tangible-paginator-page', num)\n\n      if (num == currentPage) {\n        $button.addClass('active')\n      }\n    }\n\n    if ($existingButtons.eq(index).length) {\n      $existingButtons.eq(index).replaceWith($button)\n      return\n    }\n\n    $buttonsContainer.append($button)\n  })\n\n  if (!setState) return\n\n  // First-time render: Bind event handler\n\n  $buttonsContainer.on(\n    'click',\n    '[data-tangible-paginator-action]',\n    function () {\n      const $button = $(this)\n      const actionName = $button.data('tangiblePaginatorAction')\n\n      switch (actionName) {\n        case 'page': {\n          const page = parseInt($button.data('tangiblePaginatorPage'), 10)\n\n          if (isNaN(page) || page <= 0 || page > state.total_pages) return\n\n          state.current_page = page\n          break\n        }\n        case 'first_page':\n          state.current_page = 1\n          break\n        case 'last_page':\n          state.current_page = state.total_pages\n          break\n        case 'next_page':\n          if (state.current_page === state.total_pages) return\n          state.current_page++\n          break\n        case 'previous_page':\n          if (state.current_page === 1) return\n          state.current_page--\n          break\n        default:\n          return\n      }\n\n      setState(state)\n    }\n  )\n\n  return $buttonsContainer\n}\n"],"names":["getRange","__name","start","end","v","i","generatePageRange","currentPage","totalPages","delta","range","pages","dots","withDots","value","pair","$","ajax","activatePaginators","createPaginator","$target","targetId","targetData","state","template","hash","context","context_hash","additionalSettings","$subscribers","setState","newState","render","$fields","$loading","$buttonsContainer","$subscriber","actionName","$field","fieldName","renderPaginationButtons","subscribeSettings","updateFields","cachedPages","afterLoaded","targetTop","duration","loadingClass","startLoading","finishLoading","result","error","pageNumbers","$existingButtons","num","index","$button","page"],"mappings":"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"}