var Ne=Object.defineProperty;var c=(T,P)=>Ne(T,"name",{value:P,configurable:!0});(function(){"use strict";(function(){const e={env:{NODE_ENV:"production"}};try{if(process){process.env=Object.assign({},process.env),Object.assign(process.env,e);return}}catch(t){}globalThis.process={env:e}})();const{Tangible:{ajax:T}}=window,P="tangible_loops_and_logic__template_import_export__";var R=Object.defineProperty,ae=Object.defineProperties,re=Object.getOwnPropertyDescriptors,C=Object.getOwnPropertySymbols,ne=Object.prototype.hasOwnProperty,le=Object.prototype.propertyIsEnumerable,M=c((e,t,a)=>t in e?R(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,"u$2"),y=c((e,t)=>{for(var a in t||(t={}))ne.call(t,a)&&M(e,a,t[a]);if(C)for(var a of C(t))le.call(t,a)&&M(e,a,t[a]);return e},"a$1"),E=c((e,t)=>ae(e,re(t)),"d$1"),oe=c((e,t)=>R(e,"name",{value:t,configurable:!0}),"m$2");function D({mode:e,inputStateRef:t,setInputState:a}){const{importData:l}=t.current;if(!l||!l.post_types){console.warn("Import data not found",l);return}const s=E(y({},l),{post_types:{},handle_duplicates:e});for(const{id:m,title:n,post_type:r}of t.current.duplicatesFound){const g=l.post_types[r].filter(p=>p.id===m)[0];if(!g){console.warn("Corresponding post not found",m,r,n);continue}s.post_types[r]||(s.post_types[r]=[]),s.post_types[r].push(g)}a(E(y({},t.current),{importData:{},importedData:{},duplicatesFound:[],duplicatesHandledMessage:"",message:""})),T(P+"import",s).then(m=>{const n=E(y({},s),{old_to_new_id:y(y({},t.current.old_to_new_id||{}),m.old_to_new_id||{})});console.log("Imported duplicates",n),a(E(y({},t.current),{importing:!1,importData:{},importedData:n,duplicatesFound:[],duplicatesHandledMessage:"",message:m.post_count+" template"+(m.post_count!==1?"s":"")+" imported"}))}).catch(m=>{a(E(y({},t.current),{duplicatesHandledMessage:"Error: "+m.message}))})}c(D,"F"),oe(D,"handleDuplicates");var q=Object.defineProperty,ce=Object.defineProperties,ie=Object.getOwnPropertyDescriptors,H=Object.getOwnPropertySymbols,se=Object.prototype.hasOwnProperty,pe=Object.prototype.propertyIsEnumerable,L=c((e,t,a)=>t in e?q(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,"I"),O=c((e,t)=>{for(var a in t||(t={}))se.call(t,a)&&L(e,a,t[a]);if(H)for(var a of H(t))pe.call(t,a)&&L(e,a,t[a]);return e},"l$1"),h=c((e,t)=>ce(e,ie(t)),"u$1"),w=c((e,t)=>q(e,"name",{value:t,configurable:!0}),"c$1");const $=w((...e)=>console.log("[Importer]",...e),"log"),{FileReader:ue}=window,N={tangible_template:"Templates",tangible_style:"Styles",tangible_script:"Scripts",tangible_layout:"Layouts",tangible_block:"Blocks"},me=w(({useInput:e=!0,directImportData:t})=>{const[a,l]=Tangible.Preact.useState({importing:!1,importData:{},importedData:{},message:"",duplicatesFound:[],duplicatesHandledMessage:""}),s=w(()=>{l(h(O({},r.current),{importing:!0,importData:{},importedData:{},duplicatesFound:[],duplicatesHandledMessage:"",message:"Importing.."}))},"preImport"),m=w(p=>l(h(O({},r.current),{importing:!1,importData:{},importedData:{},duplicatesFound:[],duplicatesHandledMessage:"",message:"Error: "+p})),"onError"),n=w(p=>{l(h(O({},r.current),{importData:p})),T(P+"import",p).then(o=>{$("Import success",o);const{importData:u}=r.current,b={post_types:Object.keys(u.post_types).reduce((i,d)=>{const f=o.duplicates_found.filter(v=>v.post_type===d).map(v=>v.id);return i[d]=u.post_types[d].filter(v=>f.indexOf(v.id)<0),i},{}),old_to_new_id:o.old_to_new_id||{}};$("Imported minus duplicates",b),l(h(O({},r.current),{importing:!1,duplicatesFound:o.duplicates_found,importData:o.duplicates_found.length?u:{},importedData:b,message:o.post_count+" template"+(o.post_count!==1?"s":"")+" imported"+(o.failed_post_count?" - "+o.failed_post_count+" template"+(o.failed_post_count!==1?"s":"")+" failed":"")}))}).catch(o=>{console.error(o),m(o.message)})},"importJSON");Tangible.Preact.useEffect(()=>{!t||(s(),n(t))},[]);const r=Tangible.Preact.useRef();r.current=a;const g=Tangible.Preact.useRef();return Tangible.Preact.createElement("div",{id:"importer"},e&&Tangible.Preact.createElement("p",null,Tangible.Preact.createElement("input",{type:"file",hidden:!0,ref:g,accept:".json,text/json",onChange:({target:{files:p}})=>{const o=p[0],u=new ue;s(),u.onload=function(b){const i=b.target.result;try{const d=JSON.parse(i);$("Import data",d),n(d)}catch(d){$("Invalid JSON",i),m("Invalid JSON")}},u.onerror=function(b){m(b.message)},u.readAsText(o)}}),Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",disabled:a.importing,onClick:()=>{g.current&&g.current.click()}},"Import")),a.message&&Tangible.Preact.createElement("p",null,a.message),Object.keys(a.importedData.post_types||{}).map(p=>a.importedData.post_types[p]&&a.importedData.post_types[p].length>0&&Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("div",null,Tangible.Preact.createElement("b",null,N[p]||"Templates")),Tangible.Preact.createElement("ul",null,a.importedData.post_types[p].map((o,u)=>Tangible.Preact.createElement("li",{key:`post-${u}`},a.importedData.old_to_new_id&&a.importedData.old_to_new_id[o.id]?Tangible.Preact.createElement("a",{href:`post.php?post=${a.importedData.old_to_new_id[o.id]}&action=edit`},o.title):o.title))))),a.duplicatesFound.length>0&&Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("p",{style:{fontWeight:"bold",color:"red"}},a.duplicatesFound.length," duplicate template",a.duplicatesFound!==1?"s":""," found"),Object.keys(N).map(p=>{const o=a.duplicatesFound.filter(u=>u.post_type===p);if(o.length)return Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("div",null,Tangible.Preact.createElement("b",null,N[p]||"Templates")),Tangible.Preact.createElement("ul",null,o.map((u,b)=>Tangible.Preact.createElement("li",{key:`duplicate-post-${b}`},u.title))))}),Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",onClick:()=>{D({mode:"overwrite",inputStateRef:r,setInputState:l})}},"Overwrite"),"\xA0",Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",onClick:()=>{D({mode:"keep_both",inputStateRef:r,setInputState:l})}},"Keep both"),"\xA0",Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",onClick:()=>{l(h(O({},r.current),{importing:!1,importData:{},importedData:{},duplicatesFound:[],duplicatesHandledMessage:"",message:""}))}},"Skip"),a.duplicatesHandledMessage&&Tangible.Preact.createElement("p",null,a.duplicatesHandledMessage)))},"Importer");var J=Object.defineProperty,A=Object.getOwnPropertySymbols,de=Object.prototype.hasOwnProperty,ge=Object.prototype.propertyIsEnumerable,B=c((e,t,a)=>t in e?J(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,"o$2"),be=c((e,t)=>{for(var a in t||(t={}))de.call(t,a)&&B(e,a,t[a]);if(A)for(var a of A(t))ge.call(t,a)&&B(e,a,t[a]);return e},"f$1"),fe=c((e,t)=>J(e,"name",{value:t,configurable:!0}),"g$2");const{jQuery:ye}=window,k=fe(({labelForEmptyValue:e="",options:t=[],value:a="",onChange:l,multiSelect:s,style:m})=>{const n=Tangible.Preact.useRef();if(Tangible.Preact.useEffect(()=>{const r=ye(n.current);n.current.$el=r,l(a),r.tangibleSelect({minimumResultsForSearch:5}),s&&(r.val(a),r.trigger("change")),r.on("change",function(p){if(!s){l(p.target.value);return}if(!n.current)return;const o=r.select2("data").map(u=>u.id);l(o)});const g=n.current.select2=r.data("select2");return()=>{g&&g.destroy()}},[]),n.current&&n.current.$el)if(s){const r=n.current.$el.val();a.length!==r.length&&t.length&&setImmediate(function(){n.current.$el.val(a),n.current.$el.trigger("change")})}else n.current.value!==a&&(n.current.$el.val(a),n.current.$el.trigger("change"));return Tangible.Preact.createElement("select",{ref:n,autoComplete:"off",multiple:s,style:be({display:"none",width:"160px"},m)},e&&Tangible.Preact.createElement("option",{value:"",disabled:!0,selected:a==null},e),t.map((r,g)=>Tangible.Preact.createElement("option",{key:`option-${g}`,value:r.value,selected:r.value===a},r.label)))},"Select");var V=Object.defineProperty,U=Object.getOwnPropertySymbols,ve=Object.prototype.hasOwnProperty,Te=Object.prototype.propertyIsEnumerable,z=c((e,t,a)=>t in e?V(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,"d"),F=c((e,t)=>{for(var a in t||(t={}))ve.call(t,a)&&z(e,a,t[a]);if(U)for(var a of U(t))Te.call(t,a)&&z(e,a,t[a]);return e},"c"),Pe=c((e,t)=>V(e,"name",{value:t,configurable:!0}),"s$1");const{isTangibleBlockEditorInstalled:_e=!1}=window.Tangible,Ee=Pe(({rule:e,ruleIndex:t,exportRulesRef:a,setExportRules:l,templateTypeItemOptionsRef:s,ensureTemplateTypeItemOptions:m})=>Tangible.Preact.createElement("div",{className:"export-rule"},Tangible.Preact.createElement("div",{className:"export-rule-part"},Tangible.Preact.createElement(k,F({},{labelForEmptyValue:"Select template type",options:[{label:"Template",value:"tangible_template"},{label:"Style",value:"tangible_style"},{label:"Script",value:"tangible_script"},{label:"Layout",value:"tangible_layout"},..._e?[{label:"Block",value:"tangible_block"}]:[]],value:e.field,onChange(n){e.field=n,a.current[t]=e,l(a.current)}}))),e.field&&Tangible.Preact.createElement("div",{className:"export-rule-part"},Tangible.Preact.createElement(k,F({},{options:[{label:"All",value:"all"},{label:"Include",value:"include"},{label:"Exclude",value:"exclude"}],value:e.operator,onChange(n){e.operator=n,n==="all"&&(e.values=[]),a.current[t]=e,l(a.current),n!=="all"&&m(e.field)},style:{width:"auto"}}))),e.field&&e.operator!=="all"&&s.current[e.field]&&Tangible.Preact.createElement("div",{className:"export-rule-part"},Tangible.Preact.createElement(k,F({},{options:s.current[e.field]instanceof Promise?[]:s.current[e.field],value:e.values,onChange(n){e.values=n,a.current[t]=e,l(a.current)},multiSelect:!0}))),Tangible.Preact.createElement("div",{className:"export-rule-part export-rule-part--remove-rule"},Tangible.Preact.createElement("div",{className:"icon",onClick:()=>{a.current.splice(t,1),l(a.current)}},Tangible.Preact.createElement("svg",{viewBox:"0 0 1792 1792",xmlns:"http://www.w3.org/2000/svg"},Tangible.Preact.createElement("path",{d:"M1490 1322q0 40-28 68l-136 136q-28 28-68 28t-68-28l-294-294-294 294q-28 28-68 28t-68-28l-136-136q-28-28-28-68t28-68l294-294-294-294q-28-28-28-68t28-68l136-136q28-28 68-28t68 28l294 294 294-294q28-28 68-28t68 28l136 136q28 28 28 68t-28 68l-294 294 294 294q28 28 28 68z"}))))),"ExportRule");var Oe=Object.defineProperty,K=c((e,t)=>Oe(e,"name",{value:t,configurable:!0}),"e$1");function Q(e){!window.localStorage||window.localStorage.setItem("exporterState",JSON.stringify(e))}c(Q,"saveStateToLocalStorage"),K(Q,"saveStateToLocalStorage");function W(){if(!window.localStorage)return;let e=window.localStorage.getItem("exporterState");if(e)try{return e=JSON.parse(e),e}catch(t){}}c(W,"getSavedStateFromLocalStorage"),K(W,"getSavedStateFromLocalStorage");var G=Object.defineProperty,he=Object.defineProperties,we=Object.getOwnPropertyDescriptors,X=Object.getOwnPropertySymbols,Se=Object.prototype.hasOwnProperty,xe=Object.prototype.propertyIsEnumerable,Y=c((e,t,a)=>t in e?G(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,"R"),_=c((e,t)=>{for(var a in t||(t={}))Se.call(t,a)&&Y(e,a,t[a]);if(X)for(var a of X(t))xe.call(t,a)&&Y(e,a,t[a]);return e},"s"),Z=c((e,t)=>he(e,we(t)),"f"),S=c((e,t)=>G(e,"name",{value:t,configurable:!0}),"l");const $e=!1,I=S((...e)=>$e,"log"),j=W(),ee=j&&j.name||"tangible-templates",Ie=j&&j.rules||[{field:"tangible_template",operator:"all",values:[]}],je=S(()=>{const e=Tangible.Preact.useRef(),[t,a]=Tangible.Preact.useState(Ie),l=Tangible.Preact.useRef();l.current=t;const s=S(i=>{a([...i])},"setExportRules"),[m,n]=Tangible.Preact.useState({}),r=Tangible.Preact.useRef();r.current=m;const[g,p]=Tangible.Preact.useState({exporting:!1,message:"",json:"",packageName:""}),o=Tangible.Preact.useRef();o.current=g;const u=S(i=>{p(_(_({},o.current),i))},"setExportState"),b=S(async i=>{if(r.current[i])return;I("ensureTemplateTypeItemOptions",i,r.current);const d=T(P+"get_template_type_item_options",{post_type:i}).then(f=>{I("ensureTemplateTypeItemOptions Success",f),n(Z(_({},r.current),{[i]:f}))}).catch(f=>{I("ensureTemplateTypeItemOptions Fail",f)});n(Z(_({},r.current),{[i]:d}))},"ensureTemplateTypeItemOptions");return Tangible.Preact.createElement("div",{id:"exporter"},Tangible.Preact.createElement("div",{className:"export-name"},"Package name:"," ",Tangible.Preact.createElement("input",{type:"text",name:"name",defaultValue:ee,ref:e})),Tangible.Preact.createElement("div",{className:"export-rules"},t.map((i,d)=>Tangible.Preact.createElement(Ee,_({key:`export-rule-${d}`},{rule:i,ruleIndex:d,exportRulesRef:l,setExportRules:s,templateTypeItemOptionsRef:r,ensureTemplateTypeItemOptions:b})))),Tangible.Preact.createElement("p",null,Tangible.Preact.createElement("button",{type:"button",className:"button button-secondary",onClick:()=>{l.current.push({field:"tangible_template",operator:"all",values:[]}),s(l.current)}},"Add export rule")),l.current.length>0&&Tangible.Preact.createElement("p",null,Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",disabled:g.exporting,onClick:()=>{const i=e.current&&e.current.value||ee;Q({name:i,rules:l.current}),I("Export start",l.current),u({exporting:!0,message:"Exporting.."}),T(P+"export",{export_rules:l.current}).then(d=>{console.log("Export success",d),u({exporting:!1,message:""});const f=_({package_name:i},d),v=new Date().toISOString().slice(0,10).replace(/-/g,""),x=document.createElement("a");x.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(f,null,2)),x.download=`${i}-${v}.json`,x.style.display="none",document.body.appendChild(x),x.click()}).catch(d=>{console.error(d),u({exporting:!1,message:"Error: "+d.message})})}},"Export"),g.message&&Tangible.Preact.createElement("span",{style:{paddingLeft:"1rem"}},g.message)))},"Exporter"),{Tangible:{Preact:De}}=window,te=document.getElementById("tangible_template_import_export_form");te.addEventListener("submit",function(e){e.preventDefault()}),De.render(Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("h1",{className:"wp-heading-inline"},"Import"),Tangible.Preact.createElement(me,null),Tangible.Preact.createElement("hr",null),Tangible.Preact.createElement("h1",{className:"wp-heading-inline"},"Export"),Tangible.Preact.createElement(je,null)),te)})();
//# sourceMappingURL=template-import-export.min.js.map
