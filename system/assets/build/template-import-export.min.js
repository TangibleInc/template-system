var we=Object.defineProperty;var s=(O,k)=>we(O,"name",{value:k,configurable:!0});(function(){"use strict";(function(){const e={NODE_ENV:"production"};try{if(process){process.env=Object.assign({},process.env),Object.assign(process.env,e);return}}catch{}globalThis.process={env:e}})();async function O(e,a=document.createElement("img")){return new Promise((t,n)=>{const l=s(()=>{URL.revokeObjectURL(a.src),a.removeEventListener("load",l),t(a)},"listener");a.addEventListener("load",l),a.src=URL.createObjectURL(e)})}s(O,"blobToImageElement");function k(e){const{context:a,width:t,height:n}=J(e);return a.getImageData(0,0,t,n).data}s(k,"getImageData");function J(e){const a=document.createElement("canvas"),t=a.getContext("2d"),n=a.width=e.naturalWidth,l=a.height=e.naturalHeight;return t?.drawImage(e,0,0),{canvas:a,context:t,width:n,height:l}}s(J,"imageElementToCanvas");function q(e,a){for(let t=0,n=e.length;t<3;t++)a[t]=n/Math.pow(256,t)%256|0;a[3]=255;for(let t=4,n=0,l=a.length;t<l;t+=4,n+=3)a[t]=e[n]||0,a[t+1]=e[n+1]||0,a[t+2]=e[n+2]||0,a[t+3]=255;return a}s(q,"encodeDataIntoImage");function z(e){let a=0;for(let n=0;n<3;n++)a+=e[n]*Math.pow(256,n);const t=new Uint8Array(a);e:for(let n=4,l=0,u=e.length;l<u;n+=4,l+=3)for(let r=0;r<3;r++){if(l+r>=a)break e;t[l+r]=e[n+r]}return t.buffer}s(z,"decodeDataFromImage");async function V(e){const a=new Uint8Array(e);return new Promise((t,n)=>{const l=document.createElement("canvas"),u=l.getContext("2d"),r=Math.ceil(Math.sqrt(a.length/3+1));l.width=r,l.height=r;const o=u?.getImageData(0,0,r,r);q(a,o.data),u?.putImageData(o,0,0),l.toBlob(p=>{p?t(p):n(new Error("Canvas failed to create blob"))},"image/png")})}s(V,"encodeBinaryToBlob");async function W(e){if(!(e instanceof ArrayBuffer))throw new Error("Expected ArrayBuffer but got "+typeof e);const a=new Blob([e]),t=await O(a);return z(k(t))}s(W,"decodeBinaryFromPng");const{CompressionStream:K,DecompressionStream:Q,Response:P}=globalThis,R="gzip";async function G(e,a=R){const t=new K(a),n=new P(e).body?.pipeThrough(t);return await new P(n).arrayBuffer()}s(G,"compress");async function X(e,a=R){const t=new Q(a),n=new P(e).body?.pipeThrough(t);return new P(n)}s(X,"decompressAsResponse");async function Y(e,a=R){return(await X(e,a)).arrayBuffer()}s(Y,"decompressAsArrayBuffer");function Z(e){return new TextEncoder().encode(JSON.stringify(e)).buffer}s(Z,"valueToArrayBuffer");function ee(e){return JSON.parse(new TextDecoder().decode(e))}s(ee,"arrayBufferToValue");async function te(e){return await V(await G(Z(e)))}s(te,"encodeToBlob");async function ae(e){return ee(await ne(e))}s(ae,"decode");async function ne(e){return await Y(await W(e))}s(ne,"decodeBinary");function re(e,a="compressed.png"){const t=URL.createObjectURL(e),n=document.createElement("a");n.download=a,n.href=t,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t)}s(re,"downloadImage");const{Tangible:{ajax:w}}=window,x="tangible_template_import_export__";var le=Object.defineProperty,oe=s((e,a)=>le(e,"name",{value:a,configurable:!0}),"c");function N({mode:e,inputStateRef:a,setInputState:t}){const{importData:n}=a.current;if(!n||!n.post_types){console.warn("Import data not found",n);return}const l={...n,post_types:{},handle_duplicates:e};for(const{id:u,title:r,post_type:o}of a.current.duplicatesFound){const p=n.post_types[o].filter(m=>m.id===u)[0];if(!p){console.warn("Corresponding post not found",u,o,r);continue}l.post_types[o]||(l.post_types[o]=[]),l.post_types[o].push(p)}t({...a.current,importData:{},importedData:{},duplicatesFound:[],duplicatesHandledMessage:"",message:""}),w(x+"import",l).then(u=>{const r={...l,old_to_new_id:{...a.current.old_to_new_id||{},...u.old_to_new_id||{}}};console.log("Imported duplicates",r),t({...a.current,importing:!1,importData:{},importedData:r,duplicatesFound:[],duplicatesHandledMessage:"",message:u.post_count+" template"+(u.post_count!==1?"s":"")+" imported"})}).catch(u=>{t({...a.current,duplicatesHandledMessage:"Error: "+u.message})})}s(N,"m$2"),oe(N,"handleDuplicates");var ce=Object.defineProperty,v=s((e,a)=>ce(e,"name",{value:a,configurable:!0}),"l");const S=v((...e)=>console.log("[Importer]",...e),"log"),{FileReader:se}=window,j={tangible_template:"Templates",tangible_style:"Styles",tangible_script:"Scripts",tangible_layout:"Layouts",tangible_block:"Blocks"},ie=v(({useInput:e=!0,directImportData:a})=>{const[t,n]=Tangible.Preact.useState({importing:!1,importData:{},importedData:{},message:"",duplicatesFound:[],duplicatesHandledMessage:""}),l=Tangible.Preact.useRef();l.current=t;const u=v(()=>{n({...l.current,importing:!0,importData:{},importedData:{},duplicatesFound:[],duplicatesHandledMessage:"",message:"Importing.."})},"preImport"),r=v(m=>n({...l.current,importing:!1,importData:{},importedData:{},duplicatesFound:[],duplicatesHandledMessage:"",message:"Error: "+m}),"onError"),o=v(m=>{n({...l.current,importData:m}),w(x+"import",m).then(c=>{S("Import success",c);const{importData:g}=l.current,f={post_types:Object.keys(g.post_types).reduce((y,i)=>{const d=c.duplicates_found.filter(b=>b.post_type===i).map(b=>b.id);return y[i]=g.post_types[i].filter(b=>d.indexOf(b.id)<0),y},{}),old_to_new_id:c.old_to_new_id||{}};S("Imported minus duplicates",f),n({...l.current,importing:!1,duplicatesFound:c.duplicates_found,importData:c.duplicates_found.length?g:{},importedData:f,message:c.post_count+" template"+(c.post_count!==1?"s":"")+" imported"+(c.failed_post_count?" - "+c.failed_post_count+" template"+(c.failed_post_count!==1?"s":"")+" failed":"")})}).catch(c=>{console.error(c),r(c.message)})},"importJSON");Tangible.Preact.useEffect(()=>{a&&(u(),o(a))},[]);const p=Tangible.Preact.useRef();return Tangible.Preact.createElement("div",{id:"importer"},e&&Tangible.Preact.createElement("p",null,Tangible.Preact.createElement("input",{type:"file",hidden:!0,ref:p,accept:".json,text/json,.png,image/png",onChange:({target:{files:m}})=>{const c=m[0],g=c.name.endsWith(".png"),f=new se;u(),f.onload=function(y){const i=y.target.result;if(g){ae(i).then(d=>{o(d)}).catch(d=>{console.error(d),r(d.message)});return}try{const d=JSON.parse(i);S("Import data",d),o(d)}catch{S("Invalid JSON",i),r("Invalid JSON")}},f.onerror=function(y){r(y.message)},g?f.readAsArrayBuffer(c):f.readAsText(c)}}),Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",onClick:()=>{t.importing||p.current&&p.current.click()}},"Import")),t.message&&Tangible.Preact.createElement("p",null,t.message),Object.keys(t.importedData.post_types||{}).map(m=>t.importedData.post_types[m]&&t.importedData.post_types[m].length>0&&Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("div",null,Tangible.Preact.createElement("b",null,j[m]||"Templates")),Tangible.Preact.createElement("ul",null,t.importedData.post_types[m].map((c,g)=>Tangible.Preact.createElement("li",{key:`post-${g}`},t.importedData.old_to_new_id&&t.importedData.old_to_new_id[c.id]?Tangible.Preact.createElement("a",{href:`post.php?post=${t.importedData.old_to_new_id[c.id]}&action=edit`},c.title):c.title))))),t.duplicatesFound.length>0&&Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("p",{style:{fontWeight:"bold",color:"red"}},t.duplicatesFound.length," duplicate template",t.duplicatesFound!==1?"s":""," found"),Object.keys(j).map(m=>{const c=t.duplicatesFound.filter(g=>g.post_type===m);if(c.length)return Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("div",null,Tangible.Preact.createElement("b",null,j[m]||"Templates")),Tangible.Preact.createElement("ul",null,c.map((g,f)=>Tangible.Preact.createElement("li",{key:`duplicate-post-${f}`},g.title))))}),Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",onClick:()=>{N({mode:"overwrite",inputStateRef:l,setInputState:n})}},"Overwrite"),"\xA0",Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",onClick:()=>{N({mode:"keep_both",inputStateRef:l,setInputState:n})}},"Keep both"),"\xA0",Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",onClick:()=>{n({...l.current,importing:!1,importData:{},importedData:{},duplicatesFound:[],duplicatesHandledMessage:"",message:""})}},"Skip"),t.duplicatesHandledMessage&&Tangible.Preact.createElement("p",null,t.duplicatesHandledMessage)))},"Importer");var ue=Object.defineProperty,pe=s((e,a)=>ue(e,"name",{value:a,configurable:!0}),"o");const{jQuery:me}=window,F=pe(({labelForEmptyValue:e="",options:a=[],value:t="",onChange:n,multiSelect:l,style:u})=>{const r=Tangible.Preact.useRef();if(Tangible.Preact.useEffect(()=>{const o=me(r.current);r.current.$el=o,n(t),o.tangibleSelect({minimumResultsForSearch:5}),l&&(o.val(t),o.trigger("change")),o.on("change",function(m){if(!l){n(m.target.value);return}if(!r.current)return;const c=o.select2("data").map(g=>g.id);n(c)});const p=r.current.select2=o.data("select2");return()=>{p&&p.destroy()}},[]),r.current&&r.current.$el)if(l){const o=r.current.$el.val();t.length!==o.length&&a.length&&setTimeout(function(){r.current.$el.val(t),r.current.$el.trigger("change")},0)}else r.current.value!==t&&(r.current.$el.val(t),r.current.$el.trigger("change"));return Tangible.Preact.createElement("select",{ref:r,autoComplete:"off",multiple:l,style:{display:"none",width:"160px",...u}},e&&Tangible.Preact.createElement("option",{value:"",disabled:!0,selected:t==null},e),a.map((o,p)=>Tangible.Preact.createElement("option",{key:`option-${p}`,value:o.value,selected:o.value===t},o.label)))},"Select");var de=Object.defineProperty,ge=s((e,a)=>de(e,"name",{value:a,configurable:!0}),"v");const{templateSystemHasPlugin:E={}}=window.Tangible;console.log("hasPlugin",E);const be=ge(({rule:e,ruleIndex:a,exportRulesRef:t,setExportRules:n,templateTypeItemOptionsRef:l,ensureTemplateTypeItemOptions:u})=>Tangible.Preact.createElement("div",{className:"export-rule"},Tangible.Preact.createElement("div",{className:"export-rule-part"},Tangible.Preact.createElement(F,{labelForEmptyValue:"Select template type",options:[...E.blocks&&E.blocks_editor?[{label:"Block",value:"tangible_block"}]:[],...E.loops||E.template_system?[{label:"Template",value:"tangible_template"},{label:"Style",value:"tangible_style"},{label:"Script",value:"tangible_script"},{label:"Layout",value:"tangible_layout"}]:[]],value:e.field,onChange(r){e.field=r,t.current[a]=e,n(t.current)}})),e.field&&Tangible.Preact.createElement("div",{className:"export-rule-part"},Tangible.Preact.createElement(F,{options:[{label:"All",value:"all"},{label:"Include",value:"include"},{label:"Exclude",value:"exclude"}],value:e.operator,onChange(r){e.operator=r,r==="all"&&(e.values=[]),t.current[a]=e,n(t.current),r!=="all"&&u(e.field)},style:{width:"auto"}})),e.field&&e.operator!=="all"&&l.current[e.field]&&Tangible.Preact.createElement("div",{className:"export-rule-part"},Tangible.Preact.createElement(F,{options:l.current[e.field]instanceof Promise?[]:l.current[e.field],value:e.values,onChange(r){e.values=r,t.current[a]=e,n(t.current)},multiSelect:!0})),Tangible.Preact.createElement("div",{className:"export-rule-part export-rule-part--remove-rule"},Tangible.Preact.createElement("div",{className:"icon",onClick:()=>{t.current.splice(a,1),n(t.current)}},Tangible.Preact.createElement("svg",{viewBox:"0 0 1792 1792",xmlns:"http://www.w3.org/2000/svg"},Tangible.Preact.createElement("path",{d:"M1490 1322q0 40-28 68l-136 136q-28 28-68 28t-68-28l-294-294-294 294q-28 28-68 28t-68-28l-136-136q-28-28-28-68t28-68l294-294-294-294q-28-28-28-68t28-68l136-136q28-28 68-28t68 28l294 294 294-294q28-28 68-28t68 28l136 136q28 28 28 68t-28 68l-294 294 294 294q28 28 28 68z"}))))),"ExportRule");var fe=Object.defineProperty,C=s((e,a)=>fe(e,"name",{value:a,configurable:!0}),"e$1");function B(e){window.localStorage&&window.localStorage.setItem("exporterState",JSON.stringify(e))}s(B,"saveStateToLocalStorage"),C(B,"saveStateToLocalStorage");function L(){if(!window.localStorage)return;let e=window.localStorage.getItem("exporterState");if(e)try{return e=JSON.parse(e),e}catch{}}s(L,"getSavedStateFromLocalStorage"),C(L,"getSavedStateFromLocalStorage");var ye=Object.defineProperty,T=s((e,a)=>ye(e,"name",{value:a,configurable:!0}),"a");const Te=!1,I=T((...e)=>Te,"log"),D=L(),A=D&&D.name||"tangible-templates",ve=D&&D.rules||[{field:"tangible_template",operator:"all",values:[]}],Ee=T(()=>{const e=Tangible.Preact.useRef(),[a,t]=Tangible.Preact.useState(ve),n=Tangible.Preact.useRef();n.current=a;const l=T(i=>{t([...i])},"setExportRules"),[u,r]=Tangible.Preact.useState({}),o=Tangible.Preact.useRef();o.current=u;const[p,m]=Tangible.Preact.useState({exporting:!1,message:"",json:"",packageName:""}),c=Tangible.Preact.useRef();c.current=p;const g=T(i=>{m({...c.current,...i})},"setExportState"),f=T(async i=>{if(o.current[i])return;I("ensureTemplateTypeItemOptions",i,o.current);const d=w(x+"get_template_type_item_options",{post_type:i}).then(b=>{I("ensureTemplateTypeItemOptions Success",b),r({...o.current,[i]:b})}).catch(b=>{I("ensureTemplateTypeItemOptions Fail",b)});r({...o.current,[i]:d})},"ensureTemplateTypeItemOptions"),y=Tangible.Preact.useCallback((i="json")=>{const d=e.current&&e.current.value||A;B({name:d,rules:n.current}),I("Export start",n.current),g({exporting:!0,message:"Exporting.."});function b(h){console.error(h),g({exporting:!1,message:"Error: "+h.message})}s(b,"n"),T(b,"handleError"),w(x+"export",{export_rules:n.current}).then(h=>{console.log("Export success",h),g({exporting:!1,message:"Export success"});const H={package_name:d,...h},U=new Date().toISOString().slice(0,10).replace(/-/g,"");if(i==="png"){te(H).then(Pe=>{re(Pe,`${d}-${U}.png`)}).catch(b);return}const _=document.createElement("a");_.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(H,null,2)),_.download=`${d}-${U}.json`,_.style.display="none",document.body.appendChild(_),_.click()}).catch(b)});return Tangible.Preact.createElement("div",{id:"exporter"},Tangible.Preact.createElement("div",{className:"export-name"},"Package name:"," ",Tangible.Preact.createElement("input",{type:"text",name:"name",defaultValue:A,ref:e})),Tangible.Preact.createElement("div",{className:"export-rules"},a.map((i,d)=>Tangible.Preact.createElement(be,{key:`export-rule-${d}`,rule:i,ruleIndex:d,exportRulesRef:n,setExportRules:l,templateTypeItemOptionsRef:o,ensureTemplateTypeItemOptions:f}))),Tangible.Preact.createElement("p",null,Tangible.Preact.createElement("button",{type:"button",className:"button button-secondary",onClick:()=>{n.current.push({field:"tangible_template",operator:"all",values:[]}),l(n.current)}},"Add export rule")),n.current.length>0&&Tangible.Preact.createElement("p",null,Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",onClick:i=>{i.preventDefault(),!p.exporting&&y("png")}},"Export"),Tangible.Preact.createElement("a",{href:"#",style:"margin: 0 1rem",onClick:i=>{i.preventDefault(),!p.exporting&&y()}},"Export as JSON (Uncompressed)"),p.message&&Tangible.Preact.createElement("div",{style:{padding:".5rem 0"}},p.message)))},"Exporter"),{Tangible:{Preact:he,templateSystemHasPlugin:$={}}}=window,M=document.getElementById("tangible_template_import_export_form");M.addEventListener("submit",function(e){e.preventDefault()});const _e=$.loops||$.blocks_editor||$.template_system;he.render(Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("h1",{className:"wp-heading-inline"},"Import"),Tangible.Preact.createElement(ie,null),_e&&Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("hr",null),Tangible.Preact.createElement("h1",{className:"wp-heading-inline"},"Export"),Tangible.Preact.createElement(Ee,null))),M)})();
//# sourceMappingURL=template-import-export.min.js.map
