var ee=Object.defineProperty;var b=(_,y)=>ee(_,"name",{value:y,configurable:!0});(function(){"use strict";(function(){const e={NODE_ENV:"production"};try{if(process){process.env=Object.assign({},process.env),Object.assign(process.env,e);return}}catch{}globalThis.process={env:e}})();const{Tangible:{ajax:_}}=window,y="tangible_template_import_export__";var C=Object.defineProperty,H=b((e,n)=>C(e,"name",{value:n,configurable:!0}),"c$1");function I({mode:e,inputStateRef:n,setInputState:t}){const{importData:l}=n.current;if(!l||!l.post_types){console.warn("Import data not found",l);return}const i={...l,post_types:{},handle_duplicates:e};for(const{id:u,title:r,post_type:a}of n.current.duplicatesFound){const d=l.post_types[a].filter(s=>s.id===u)[0];if(!d){console.warn("Corresponding post not found",u,a,r);continue}i.post_types[a]||(i.post_types[a]=[]),i.post_types[a].push(d)}t({...n.current,importData:{},importedData:{},duplicatesFound:[],duplicatesHandledMessage:"",message:""}),_(y+"import",i).then(u=>{const r={...i,old_to_new_id:{...n.current.old_to_new_id||{},...u.old_to_new_id||{}}};console.log("Imported duplicates",r),t({...n.current,importing:!1,importData:{},importedData:r,duplicatesFound:[],duplicatesHandledMessage:"",message:u.post_count+" template"+(u.post_count!==1?"s":"")+" imported"})}).catch(u=>{t({...n.current,duplicatesHandledMessage:"Error: "+u.message})})}b(I,"m$4"),H(I,"handleDuplicates");var M=Object.defineProperty,P=b((e,n)=>M(e,"name",{value:n,configurable:!0}),"r$2");const h=P((...e)=>console.log("[Importer]",...e),"log"),{FileReader:q}=window,k={tangible_template:"Templates",tangible_style:"Styles",tangible_script:"Scripts",tangible_layout:"Layouts",tangible_block:"Blocks"},L=P(({useInput:e=!0,directImportData:n})=>{const[t,l]=Tangible.Preact.useState({importing:!1,importData:{},importedData:{},message:"",duplicatesFound:[],duplicatesHandledMessage:""}),i=P(()=>{l({...a.current,importing:!0,importData:{},importedData:{},duplicatesFound:[],duplicatesHandledMessage:"",message:"Importing.."})},"preImport"),u=P(s=>l({...a.current,importing:!1,importData:{},importedData:{},duplicatesFound:[],duplicatesHandledMessage:"",message:"Error: "+s}),"onError"),r=P(s=>{l({...a.current,importData:s}),_(y+"import",s).then(o=>{h("Import success",o);const{importData:p}=a.current,g={post_types:Object.keys(p.post_types).reduce((c,m)=>{const f=o.duplicates_found.filter(T=>T.post_type===m).map(T=>T.id);return c[m]=p.post_types[m].filter(T=>f.indexOf(T.id)<0),c},{}),old_to_new_id:o.old_to_new_id||{}};h("Imported minus duplicates",g),l({...a.current,importing:!1,duplicatesFound:o.duplicates_found,importData:o.duplicates_found.length?p:{},importedData:g,message:o.post_count+" template"+(o.post_count!==1?"s":"")+" imported"+(o.failed_post_count?" - "+o.failed_post_count+" template"+(o.failed_post_count!==1?"s":"")+" failed":"")})}).catch(o=>{console.error(o),u(o.message)})},"importJSON");Tangible.Preact.useEffect(()=>{n&&(i(),r(n))},[]);const a=Tangible.Preact.useRef();a.current=t;const d=Tangible.Preact.useRef();return Tangible.Preact.createElement("div",{id:"importer"},e&&Tangible.Preact.createElement("p",null,Tangible.Preact.createElement("input",{type:"file",hidden:!0,ref:d,accept:".json,text/json",onChange:({target:{files:s}})=>{const o=s[0],p=new q;i(),p.onload=function(g){const c=g.target.result;try{const m=JSON.parse(c);h("Import data",m),r(m)}catch{h("Invalid JSON",c),u("Invalid JSON")}},p.onerror=function(g){u(g.message)},p.readAsText(o)}}),Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",disabled:t.importing,onClick:()=>{d.current&&d.current.click()}},"Import")),t.message&&Tangible.Preact.createElement("p",null,t.message),Object.keys(t.importedData.post_types||{}).map(s=>t.importedData.post_types[s]&&t.importedData.post_types[s].length>0&&Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("div",null,Tangible.Preact.createElement("b",null,k[s]||"Templates")),Tangible.Preact.createElement("ul",null,t.importedData.post_types[s].map((o,p)=>Tangible.Preact.createElement("li",{key:`post-${p}`},t.importedData.old_to_new_id&&t.importedData.old_to_new_id[o.id]?Tangible.Preact.createElement("a",{href:`post.php?post=${t.importedData.old_to_new_id[o.id]}&action=edit`},o.title):o.title))))),t.duplicatesFound.length>0&&Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("p",{style:{fontWeight:"bold",color:"red"}},t.duplicatesFound.length," duplicate template",t.duplicatesFound!==1?"s":""," found"),Object.keys(k).map(s=>{const o=t.duplicatesFound.filter(p=>p.post_type===s);if(o.length)return Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("div",null,Tangible.Preact.createElement("b",null,k[s]||"Templates")),Tangible.Preact.createElement("ul",null,o.map((p,g)=>Tangible.Preact.createElement("li",{key:`duplicate-post-${g}`},p.title))))}),Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",onClick:()=>{I({mode:"overwrite",inputStateRef:a,setInputState:l})}},"Overwrite"),"\xA0",Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",onClick:()=>{I({mode:"keep_both",inputStateRef:a,setInputState:l})}},"Keep both"),"\xA0",Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",onClick:()=>{l({...a.current,importing:!1,importData:{},importedData:{},duplicatesFound:[],duplicatesHandledMessage:"",message:""})}},"Skip"),t.duplicatesHandledMessage&&Tangible.Preact.createElement("p",null,t.duplicatesHandledMessage)))},"Importer");var J=Object.defineProperty,A=b((e,n)=>J(e,"name",{value:n,configurable:!0}),"a");const{jQuery:B}=window,O=A(({labelForEmptyValue:e="",options:n=[],value:t="",onChange:l,multiSelect:i,style:u})=>{const r=Tangible.Preact.useRef();if(Tangible.Preact.useEffect(()=>{const a=B(r.current);r.current.$el=a,l(t),a.tangibleSelect({minimumResultsForSearch:5}),i&&(a.val(t),a.trigger("change")),a.on("change",function(s){if(!i){l(s.target.value);return}if(!r.current)return;const o=a.select2("data").map(p=>p.id);l(o)});const d=r.current.select2=a.data("select2");return()=>{d&&d.destroy()}},[]),r.current&&r.current.$el)if(i){const a=r.current.$el.val();t.length!==a.length&&n.length&&setImmediate(function(){r.current.$el.val(t),r.current.$el.trigger("change")})}else r.current.value!==t&&(r.current.$el.val(t),r.current.$el.trigger("change"));return Tangible.Preact.createElement("select",{ref:r,autoComplete:"off",multiple:i,style:{display:"none",width:"160px",...u}},e&&Tangible.Preact.createElement("option",{value:"",disabled:!0,selected:t==null},e),n.map((a,d)=>Tangible.Preact.createElement("option",{key:`option-${d}`,value:a.value,selected:a.value===t},a.label)))},"Select");var V=Object.defineProperty,z=b((e,n)=>V(e,"name",{value:n,configurable:!0}),"v");const{templateSystemHasPlugin:x={}}=window.Tangible,K=z(({rule:e,ruleIndex:n,exportRulesRef:t,setExportRules:l,templateTypeItemOptionsRef:i,ensureTemplateTypeItemOptions:u})=>Tangible.Preact.createElement("div",{className:"export-rule"},Tangible.Preact.createElement("div",{className:"export-rule-part"},Tangible.Preact.createElement(O,{labelForEmptyValue:"Select template type",options:[...x.blocks&&x.blocks_editor?[{label:"Block",value:"tangible_block"}]:[],...x.loops||x.template_system?[{label:"Template",value:"tangible_template"},{label:"Style",value:"tangible_style"},{label:"Script",value:"tangible_script"},{label:"Layout",value:"tangible_layout"}]:[]],value:e.field,onChange(r){e.field=r,t.current[n]=e,l(t.current)}})),e.field&&Tangible.Preact.createElement("div",{className:"export-rule-part"},Tangible.Preact.createElement(O,{options:[{label:"All",value:"all"},{label:"Include",value:"include"},{label:"Exclude",value:"exclude"}],value:e.operator,onChange(r){e.operator=r,r==="all"&&(e.values=[]),t.current[n]=e,l(t.current),r!=="all"&&u(e.field)},style:{width:"auto"}})),e.field&&e.operator!=="all"&&i.current[e.field]&&Tangible.Preact.createElement("div",{className:"export-rule-part"},Tangible.Preact.createElement(O,{options:i.current[e.field]instanceof Promise?[]:i.current[e.field],value:e.values,onChange(r){e.values=r,t.current[n]=e,l(t.current)},multiSelect:!0})),Tangible.Preact.createElement("div",{className:"export-rule-part export-rule-part--remove-rule"},Tangible.Preact.createElement("div",{className:"icon",onClick:()=>{t.current.splice(n,1),l(t.current)}},Tangible.Preact.createElement("svg",{viewBox:"0 0 1792 1792",xmlns:"http://www.w3.org/2000/svg"},Tangible.Preact.createElement("path",{d:"M1490 1322q0 40-28 68l-136 136q-28 28-68 28t-68-28l-294-294-294 294q-28 28-68 28t-68-28l-136-136q-28-28-28-68t28-68l294-294-294-294q-28-28-28-68t28-68l136-136q28-28 68-28t68 28l294 294 294-294q28-28 68-28t68 28l136 136q28 28 28 68t-28 68l-294 294 294 294q28 28 28 68z"}))))),"ExportRule");var Q=Object.defineProperty,N=b((e,n)=>Q(e,"name",{value:n,configurable:!0}),"e$1");function F(e){window.localStorage&&window.localStorage.setItem("exporterState",JSON.stringify(e))}b(F,"saveStateToLocalStorage"),N(F,"saveStateToLocalStorage");function R(){if(!window.localStorage)return;let e=window.localStorage.getItem("exporterState");if(e)try{return e=JSON.parse(e),e}catch{}}b(R,"getSavedStateFromLocalStorage"),N(R,"getSavedStateFromLocalStorage");var U=Object.defineProperty,v=b((e,n)=>U(e,"name",{value:n,configurable:!0}),"s");const W=!1,S=v((...e)=>W,"log"),w=R(),$=w&&w.name||"tangible-templates",G=w&&w.rules||[{field:"tangible_template",operator:"all",values:[]}],X=v(()=>{const e=Tangible.Preact.useRef(),[n,t]=Tangible.Preact.useState(G),l=Tangible.Preact.useRef();l.current=n;const i=v(c=>{t([...c])},"setExportRules"),[u,r]=Tangible.Preact.useState({}),a=Tangible.Preact.useRef();a.current=u;const[d,s]=Tangible.Preact.useState({exporting:!1,message:"",json:"",packageName:""}),o=Tangible.Preact.useRef();o.current=d;const p=v(c=>{s({...o.current,...c})},"setExportState"),g=v(async c=>{if(a.current[c])return;S("ensureTemplateTypeItemOptions",c,a.current);const m=_(y+"get_template_type_item_options",{post_type:c}).then(f=>{S("ensureTemplateTypeItemOptions Success",f),r({...a.current,[c]:f})}).catch(f=>{S("ensureTemplateTypeItemOptions Fail",f)});r({...a.current,[c]:m})},"ensureTemplateTypeItemOptions");return Tangible.Preact.createElement("div",{id:"exporter"},Tangible.Preact.createElement("div",{className:"export-name"},"Package name:"," ",Tangible.Preact.createElement("input",{type:"text",name:"name",defaultValue:$,ref:e})),Tangible.Preact.createElement("div",{className:"export-rules"},n.map((c,m)=>Tangible.Preact.createElement(K,{key:`export-rule-${m}`,rule:c,ruleIndex:m,exportRulesRef:l,setExportRules:i,templateTypeItemOptionsRef:a,ensureTemplateTypeItemOptions:g}))),Tangible.Preact.createElement("p",null,Tangible.Preact.createElement("button",{type:"button",className:"button button-secondary",onClick:()=>{l.current.push({field:"tangible_template",operator:"all",values:[]}),i(l.current)}},"Add export rule")),l.current.length>0&&Tangible.Preact.createElement("p",null,Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",disabled:d.exporting,onClick:()=>{const c=e.current&&e.current.value||$;F({name:c,rules:l.current}),S("Export start",l.current),p({exporting:!0,message:"Exporting.."}),_(y+"export",{export_rules:l.current}).then(m=>{console.log("Export success",m),p({exporting:!1,message:""});const f={package_name:c,...m},T=new Date().toISOString().slice(0,10).replace(/-/g,""),E=document.createElement("a");E.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(f,null,2)),E.download=`${c}-${T}.json`,E.style.display="none",document.body.appendChild(E),E.click()}).catch(m=>{console.error(m),p({exporting:!1,message:"Error: "+m.message})})}},"Export"),d.message&&Tangible.Preact.createElement("span",{style:{paddingLeft:"1rem"}},d.message)))},"Exporter"),{Tangible:{Preact:Y,templateSystemHasPlugin:D={}}}=window,j=document.getElementById("tangible_template_import_export_form");j.addEventListener("submit",function(e){e.preventDefault()});const Z=D.loops||D.blocks_editor||D.template_system;Y.render(Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("h1",{className:"wp-heading-inline"},"Import"),Tangible.Preact.createElement(L,null),Z&&Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("hr",null),Tangible.Preact.createElement("h1",{className:"wp-heading-inline"},"Export"),Tangible.Preact.createElement(X,null))),j)})();
//# sourceMappingURL=template-import-export.min.js.map
