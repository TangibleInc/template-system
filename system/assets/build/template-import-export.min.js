var Ie=Object.defineProperty;var i=(P,T)=>Ie(P,"name",{value:T,configurable:!0});(function(){"use strict";(function(){const e={env:{NODE_ENV:"production"}};try{if(process){process.env=Object.assign({},process.env),Object.assign(process.env,e);return}}catch(t){}globalThis.process={env:e}})();const{Tangible:{ajax:P}}=window,T="tangible_template_import_export__";var R=Object.defineProperty,ee=Object.defineProperties,te=Object.getOwnPropertyDescriptors,C=Object.getOwnPropertySymbols,ae=Object.prototype.hasOwnProperty,re=Object.prototype.propertyIsEnumerable,H=i((e,t,a)=>t in e?R(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,"u$1"),y=i((e,t)=>{for(var a in t||(t={}))ae.call(t,a)&&H(e,a,t[a]);if(C)for(var a of C(t))re.call(t,a)&&H(e,a,t[a]);return e},"a$1"),_=i((e,t)=>ee(e,te(t)),"d"),ne=i((e,t)=>R(e,"name",{value:t,configurable:!0}),"m$2");function D({mode:e,inputStateRef:t,setInputState:a}){const{importData:l}=t.current;if(!l||!l.post_types){console.warn("Import data not found",l);return}const s=_(y({},l),{post_types:{},handle_duplicates:e});for(const{id:m,title:n,post_type:r}of t.current.duplicatesFound){const g=l.post_types[r].filter(p=>p.id===m)[0];if(!g){console.warn("Corresponding post not found",m,r,n);continue}s.post_types[r]||(s.post_types[r]=[]),s.post_types[r].push(g)}a(_(y({},t.current),{importData:{},importedData:{},duplicatesFound:[],duplicatesHandledMessage:"",message:""})),P(T+"import",s).then(m=>{const n=_(y({},s),{old_to_new_id:y(y({},t.current.old_to_new_id||{}),m.old_to_new_id||{})});console.log("Imported duplicates",n),a(_(y({},t.current),{importing:!1,importData:{},importedData:n,duplicatesFound:[],duplicatesHandledMessage:"",message:m.post_count+" template"+(m.post_count!==1?"s":"")+" imported"}))}).catch(m=>{a(_(y({},t.current),{duplicatesHandledMessage:"Error: "+m.message}))})}i(D,"F"),ne(D,"handleDuplicates");var M=Object.defineProperty,le=Object.defineProperties,oe=Object.getOwnPropertyDescriptors,q=Object.getOwnPropertySymbols,ce=Object.prototype.hasOwnProperty,ie=Object.prototype.propertyIsEnumerable,L=i((e,t,a)=>t in e?M(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,"I"),E=i((e,t)=>{for(var a in t||(t={}))ce.call(t,a)&&L(e,a,t[a]);if(q)for(var a of q(t))ie.call(t,a)&&L(e,a,t[a]);return e},"l$1"),O=i((e,t)=>le(e,oe(t)),"u"),h=i((e,t)=>M(e,"name",{value:t,configurable:!0}),"c$1");const $=h((...e)=>console.log("[Importer]",...e),"log"),{FileReader:se}=window,k={tangible_template:"Templates",tangible_style:"Styles",tangible_script:"Scripts",tangible_layout:"Layouts",tangible_block:"Blocks"},pe=h(({useInput:e=!0,directImportData:t})=>{const[a,l]=Tangible.Preact.useState({importing:!1,importData:{},importedData:{},message:"",duplicatesFound:[],duplicatesHandledMessage:""}),s=h(()=>{l(O(E({},r.current),{importing:!0,importData:{},importedData:{},duplicatesFound:[],duplicatesHandledMessage:"",message:"Importing.."}))},"preImport"),m=h(p=>l(O(E({},r.current),{importing:!1,importData:{},importedData:{},duplicatesFound:[],duplicatesHandledMessage:"",message:"Error: "+p})),"onError"),n=h(p=>{l(O(E({},r.current),{importData:p})),P(T+"import",p).then(o=>{$("Import success",o);const{importData:u}=r.current,b={post_types:Object.keys(u.post_types).reduce((c,d)=>{const f=o.duplicates_found.filter(v=>v.post_type===d).map(v=>v.id);return c[d]=u.post_types[d].filter(v=>f.indexOf(v.id)<0),c},{}),old_to_new_id:o.old_to_new_id||{}};$("Imported minus duplicates",b),l(O(E({},r.current),{importing:!1,duplicatesFound:o.duplicates_found,importData:o.duplicates_found.length?u:{},importedData:b,message:o.post_count+" template"+(o.post_count!==1?"s":"")+" imported"+(o.failed_post_count?" - "+o.failed_post_count+" template"+(o.failed_post_count!==1?"s":"")+" failed":"")}))}).catch(o=>{console.error(o),m(o.message)})},"importJSON");Tangible.Preact.useEffect(()=>{!t||(s(),n(t))},[]);const r=Tangible.Preact.useRef();r.current=a;const g=Tangible.Preact.useRef();return Tangible.Preact.createElement("div",{id:"importer"},e&&Tangible.Preact.createElement("p",null,Tangible.Preact.createElement("input",{type:"file",hidden:!0,ref:g,accept:".json,text/json",onChange:({target:{files:p}})=>{const o=p[0],u=new se;s(),u.onload=function(b){const c=b.target.result;try{const d=JSON.parse(c);$("Import data",d),n(d)}catch(d){$("Invalid JSON",c),m("Invalid JSON")}},u.onerror=function(b){m(b.message)},u.readAsText(o)}}),Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",disabled:a.importing,onClick:()=>{g.current&&g.current.click()}},"Import")),a.message&&Tangible.Preact.createElement("p",null,a.message),Object.keys(a.importedData.post_types||{}).map(p=>a.importedData.post_types[p]&&a.importedData.post_types[p].length>0&&Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("div",null,Tangible.Preact.createElement("b",null,k[p]||"Templates")),Tangible.Preact.createElement("ul",null,a.importedData.post_types[p].map((o,u)=>Tangible.Preact.createElement("li",{key:`post-${u}`},a.importedData.old_to_new_id&&a.importedData.old_to_new_id[o.id]?Tangible.Preact.createElement("a",{href:`post.php?post=${a.importedData.old_to_new_id[o.id]}&action=edit`},o.title):o.title))))),a.duplicatesFound.length>0&&Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("p",{style:{fontWeight:"bold",color:"red"}},a.duplicatesFound.length," duplicate template",a.duplicatesFound!==1?"s":""," found"),Object.keys(k).map(p=>{const o=a.duplicatesFound.filter(u=>u.post_type===p);if(o.length)return Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("div",null,Tangible.Preact.createElement("b",null,k[p]||"Templates")),Tangible.Preact.createElement("ul",null,o.map((u,b)=>Tangible.Preact.createElement("li",{key:`duplicate-post-${b}`},u.title))))}),Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",onClick:()=>{D({mode:"overwrite",inputStateRef:r,setInputState:l})}},"Overwrite"),"\xA0",Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",onClick:()=>{D({mode:"keep_both",inputStateRef:r,setInputState:l})}},"Keep both"),"\xA0",Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",onClick:()=>{l(O(E({},r.current),{importing:!1,importData:{},importedData:{},duplicatesFound:[],duplicatesHandledMessage:"",message:""}))}},"Skip"),a.duplicatesHandledMessage&&Tangible.Preact.createElement("p",null,a.duplicatesHandledMessage)))},"Importer");var J=Object.defineProperty,A=Object.getOwnPropertySymbols,ue=Object.prototype.hasOwnProperty,me=Object.prototype.propertyIsEnumerable,B=i((e,t,a)=>t in e?J(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,"o$1"),de=i((e,t)=>{for(var a in t||(t={}))ue.call(t,a)&&B(e,a,t[a]);if(A)for(var a of A(t))me.call(t,a)&&B(e,a,t[a]);return e},"f$1"),ge=i((e,t)=>J(e,"name",{value:t,configurable:!0}),"g$1");const{jQuery:be}=window,N=ge(({labelForEmptyValue:e="",options:t=[],value:a="",onChange:l,multiSelect:s,style:m})=>{const n=Tangible.Preact.useRef();if(Tangible.Preact.useEffect(()=>{const r=be(n.current);n.current.$el=r,l(a),r.tangibleSelect({minimumResultsForSearch:5}),s&&(r.val(a),r.trigger("change")),r.on("change",function(p){if(!s){l(p.target.value);return}if(!n.current)return;const o=r.select2("data").map(u=>u.id);l(o)});const g=n.current.select2=r.data("select2");return()=>{g&&g.destroy()}},[]),n.current&&n.current.$el)if(s){const r=n.current.$el.val();a.length!==r.length&&t.length&&setImmediate(function(){n.current.$el.val(a),n.current.$el.trigger("change")})}else n.current.value!==a&&(n.current.$el.val(a),n.current.$el.trigger("change"));return Tangible.Preact.createElement("select",{ref:n,autoComplete:"off",multiple:s,style:de({display:"none",width:"160px"},m)},e&&Tangible.Preact.createElement("option",{value:"",disabled:!0,selected:a==null},e),t.map((r,g)=>Tangible.Preact.createElement("option",{key:`option-${g}`,value:r.value,selected:r.value===a},r.label)))},"Select");var fe=Object.defineProperty,ye=i((e,t)=>fe(e,"name",{value:t,configurable:!0}),"v$1");const{templateSystemHasPlugin:F={}}=window.Tangible,ve=ye(({rule:e,ruleIndex:t,exportRulesRef:a,setExportRules:l,templateTypeItemOptionsRef:s,ensureTemplateTypeItemOptions:m})=>Tangible.Preact.createElement("div",{className:"export-rule"},Tangible.Preact.createElement("div",{className:"export-rule-part"},Tangible.Preact.createElement(N,{labelForEmptyValue:"Select template type",options:[...F.blocks&&F.blocks_editor?[{label:"Block",value:"tangible_block"}]:[],...F.loops?[{label:"Template",value:"tangible_template"},{label:"Style",value:"tangible_style"},{label:"Script",value:"tangible_script"},{label:"Layout",value:"tangible_layout"}]:[]],value:e.field,onChange(n){e.field=n,a.current[t]=e,l(a.current)}})),e.field&&Tangible.Preact.createElement("div",{className:"export-rule-part"},Tangible.Preact.createElement(N,{options:[{label:"All",value:"all"},{label:"Include",value:"include"},{label:"Exclude",value:"exclude"}],value:e.operator,onChange(n){e.operator=n,n==="all"&&(e.values=[]),a.current[t]=e,l(a.current),n!=="all"&&m(e.field)},style:{width:"auto"}})),e.field&&e.operator!=="all"&&s.current[e.field]&&Tangible.Preact.createElement("div",{className:"export-rule-part"},Tangible.Preact.createElement(N,{options:s.current[e.field]instanceof Promise?[]:s.current[e.field],value:e.values,onChange(n){e.values=n,a.current[t]=e,l(a.current)},multiSelect:!0})),Tangible.Preact.createElement("div",{className:"export-rule-part export-rule-part--remove-rule"},Tangible.Preact.createElement("div",{className:"icon",onClick:()=>{a.current.splice(t,1),l(a.current)}},Tangible.Preact.createElement("svg",{viewBox:"0 0 1792 1792",xmlns:"http://www.w3.org/2000/svg"},Tangible.Preact.createElement("path",{d:"M1490 1322q0 40-28 68l-136 136q-28 28-68 28t-68-28l-294-294-294 294q-28 28-68 28t-68-28l-136-136q-28-28-28-68t28-68l294-294-294-294q-28-28-28-68t28-68l136-136q28-28 68-28t68 28l294 294 294-294q28-28 68-28t68 28l136 136q28 28 28 68t-28 68l-294 294 294 294q28 28 28 68z"}))))),"ExportRule");var Pe=Object.defineProperty,V=i((e,t)=>Pe(e,"name",{value:t,configurable:!0}),"e$1");function U(e){!window.localStorage||window.localStorage.setItem("exporterState",JSON.stringify(e))}i(U,"saveStateToLocalStorage"),V(U,"saveStateToLocalStorage");function z(){if(!window.localStorage)return;let e=window.localStorage.getItem("exporterState");if(e)try{return e=JSON.parse(e),e}catch(t){}}i(z,"getSavedStateFromLocalStorage"),V(z,"getSavedStateFromLocalStorage");var K=Object.defineProperty,Te=Object.defineProperties,_e=Object.getOwnPropertyDescriptors,Q=Object.getOwnPropertySymbols,Ee=Object.prototype.hasOwnProperty,Oe=Object.prototype.propertyIsEnumerable,W=i((e,t,a)=>t in e?K(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,"R"),w=i((e,t)=>{for(var a in t||(t={}))Ee.call(t,a)&&W(e,a,t[a]);if(Q)for(var a of Q(t))Oe.call(t,a)&&W(e,a,t[a]);return e},"c"),G=i((e,t)=>Te(e,_e(t)),"f"),S=i((e,t)=>K(e,"name",{value:t,configurable:!0}),"l");const he=!1,I=S((...e)=>he,"log"),j=z(),X=j&&j.name||"tangible-templates",we=j&&j.rules||[{field:"tangible_template",operator:"all",values:[]}],Se=S(()=>{const e=Tangible.Preact.useRef(),[t,a]=Tangible.Preact.useState(we),l=Tangible.Preact.useRef();l.current=t;const s=S(c=>{a([...c])},"setExportRules"),[m,n]=Tangible.Preact.useState({}),r=Tangible.Preact.useRef();r.current=m;const[g,p]=Tangible.Preact.useState({exporting:!1,message:"",json:"",packageName:""}),o=Tangible.Preact.useRef();o.current=g;const u=S(c=>{p(w(w({},o.current),c))},"setExportState"),b=S(async c=>{if(r.current[c])return;I("ensureTemplateTypeItemOptions",c,r.current);const d=P(T+"get_template_type_item_options",{post_type:c}).then(f=>{I("ensureTemplateTypeItemOptions Success",f),n(G(w({},r.current),{[c]:f}))}).catch(f=>{I("ensureTemplateTypeItemOptions Fail",f)});n(G(w({},r.current),{[c]:d}))},"ensureTemplateTypeItemOptions");return Tangible.Preact.createElement("div",{id:"exporter"},Tangible.Preact.createElement("div",{className:"export-name"},"Package name:"," ",Tangible.Preact.createElement("input",{type:"text",name:"name",defaultValue:X,ref:e})),Tangible.Preact.createElement("div",{className:"export-rules"},t.map((c,d)=>Tangible.Preact.createElement(ve,{key:`export-rule-${d}`,rule:c,ruleIndex:d,exportRulesRef:l,setExportRules:s,templateTypeItemOptionsRef:r,ensureTemplateTypeItemOptions:b}))),Tangible.Preact.createElement("p",null,Tangible.Preact.createElement("button",{type:"button",className:"button button-secondary",onClick:()=>{l.current.push({field:"tangible_template",operator:"all",values:[]}),s(l.current)}},"Add export rule")),l.current.length>0&&Tangible.Preact.createElement("p",null,Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",disabled:g.exporting,onClick:()=>{const c=e.current&&e.current.value||X;U({name:c,rules:l.current}),I("Export start",l.current),u({exporting:!0,message:"Exporting.."}),P(T+"export",{export_rules:l.current}).then(d=>{console.log("Export success",d),u({exporting:!1,message:""});const f=w({package_name:c},d),v=new Date().toISOString().slice(0,10).replace(/-/g,""),x=document.createElement("a");x.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(f,null,2)),x.download=`${c}-${v}.json`,x.style.display="none",document.body.appendChild(x),x.click()}).catch(d=>{console.error(d),u({exporting:!1,message:"Error: "+d.message})})}},"Export"),g.message&&Tangible.Preact.createElement("span",{style:{paddingLeft:"1rem"}},g.message)))},"Exporter"),{Tangible:{Preact:xe,templateSystemHasPlugin:Y={}}}=window,Z=document.getElementById("tangible_template_import_export_form");Z.addEventListener("submit",function(e){e.preventDefault()});const $e=Y.loops||Y.blocks_editor;xe.render(Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("h1",{className:"wp-heading-inline"},"Import"),Tangible.Preact.createElement(pe,null),$e&&Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("hr",null),Tangible.Preact.createElement("h1",{className:"wp-heading-inline"},"Export"),Tangible.Preact.createElement(Se,null))),Z)})();
//# sourceMappingURL=template-import-export.min.js.map
