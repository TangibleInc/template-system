var Fe=Object.defineProperty;var c=(P,T)=>Fe(P,"name",{value:T,configurable:!0});(function(){"use strict";(function(){const e={env:{NODE_ENV:"production"}};try{if(process){process.env=Object.assign({},process.env),Object.assign(process.env,e);return}}catch(t){}globalThis.process={env:e}})();const{Tangible:{ajax:P}}=window,T="tangible_template_import_export__";var C=Object.defineProperty,ne=Object.defineProperties,le=Object.getOwnPropertyDescriptors,H=Object.getOwnPropertySymbols,oe=Object.prototype.hasOwnProperty,ce=Object.prototype.propertyIsEnumerable,M=c((e,t,a)=>t in e?C(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,"u$1"),y=c((e,t)=>{for(var a in t||(t={}))oe.call(t,a)&&M(e,a,t[a]);if(H)for(var a of H(t))ce.call(t,a)&&M(e,a,t[a]);return e},"a$1"),E=c((e,t)=>ne(e,le(t)),"d$1"),ie=c((e,t)=>C(e,"name",{value:t,configurable:!0}),"m$3");function D({mode:e,inputStateRef:t,setInputState:a}){const{importData:l}=t.current;if(!l||!l.post_types){console.warn("Import data not found",l);return}const s=E(y({},l),{post_types:{},handle_duplicates:e});for(const{id:m,title:n,post_type:r}of t.current.duplicatesFound){const g=l.post_types[r].filter(p=>p.id===m)[0];if(!g){console.warn("Corresponding post not found",m,r,n);continue}s.post_types[r]||(s.post_types[r]=[]),s.post_types[r].push(g)}a(E(y({},t.current),{importData:{},importedData:{},duplicatesFound:[],duplicatesHandledMessage:"",message:""})),P(T+"import",s).then(m=>{const n=E(y({},s),{old_to_new_id:y(y({},t.current.old_to_new_id||{}),m.old_to_new_id||{})});console.log("Imported duplicates",n),a(E(y({},t.current),{importing:!1,importData:{},importedData:n,duplicatesFound:[],duplicatesHandledMessage:"",message:m.post_count+" template"+(m.post_count!==1?"s":"")+" imported"}))}).catch(m=>{a(E(y({},t.current),{duplicatesHandledMessage:"Error: "+m.message}))})}c(D,"F"),ie(D,"handleDuplicates");var q=Object.defineProperty,se=Object.defineProperties,pe=Object.getOwnPropertyDescriptors,L=Object.getOwnPropertySymbols,ue=Object.prototype.hasOwnProperty,me=Object.prototype.propertyIsEnumerable,J=c((e,t,a)=>t in e?q(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,"I"),O=c((e,t)=>{for(var a in t||(t={}))ue.call(t,a)&&J(e,a,t[a]);if(L)for(var a of L(t))me.call(t,a)&&J(e,a,t[a]);return e},"l$1"),h=c((e,t)=>se(e,pe(t)),"u"),w=c((e,t)=>q(e,"name",{value:t,configurable:!0}),"c$1");const $=w((...e)=>console.log("[Importer]",...e),"log"),{FileReader:de}=window,k={tangible_template:"Templates",tangible_style:"Styles",tangible_script:"Scripts",tangible_layout:"Layouts",tangible_block:"Blocks"},ge=w(({useInput:e=!0,directImportData:t})=>{const[a,l]=Tangible.Preact.useState({importing:!1,importData:{},importedData:{},message:"",duplicatesFound:[],duplicatesHandledMessage:""}),s=w(()=>{l(h(O({},r.current),{importing:!0,importData:{},importedData:{},duplicatesFound:[],duplicatesHandledMessage:"",message:"Importing.."}))},"preImport"),m=w(p=>l(h(O({},r.current),{importing:!1,importData:{},importedData:{},duplicatesFound:[],duplicatesHandledMessage:"",message:"Error: "+p})),"onError"),n=w(p=>{l(h(O({},r.current),{importData:p})),P(T+"import",p).then(o=>{$("Import success",o);const{importData:u}=r.current,b={post_types:Object.keys(u.post_types).reduce((i,d)=>{const f=o.duplicates_found.filter(v=>v.post_type===d).map(v=>v.id);return i[d]=u.post_types[d].filter(v=>f.indexOf(v.id)<0),i},{}),old_to_new_id:o.old_to_new_id||{}};$("Imported minus duplicates",b),l(h(O({},r.current),{importing:!1,duplicatesFound:o.duplicates_found,importData:o.duplicates_found.length?u:{},importedData:b,message:o.post_count+" template"+(o.post_count!==1?"s":"")+" imported"+(o.failed_post_count?" - "+o.failed_post_count+" template"+(o.failed_post_count!==1?"s":"")+" failed":"")}))}).catch(o=>{console.error(o),m(o.message)})},"importJSON");Tangible.Preact.useEffect(()=>{!t||(s(),n(t))},[]);const r=Tangible.Preact.useRef();r.current=a;const g=Tangible.Preact.useRef();return Tangible.Preact.createElement("div",{id:"importer"},e&&Tangible.Preact.createElement("p",null,Tangible.Preact.createElement("input",{type:"file",hidden:!0,ref:g,accept:".json,text/json",onChange:({target:{files:p}})=>{const o=p[0],u=new de;s(),u.onload=function(b){const i=b.target.result;try{const d=JSON.parse(i);$("Import data",d),n(d)}catch(d){$("Invalid JSON",i),m("Invalid JSON")}},u.onerror=function(b){m(b.message)},u.readAsText(o)}}),Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",disabled:a.importing,onClick:()=>{g.current&&g.current.click()}},"Import")),a.message&&Tangible.Preact.createElement("p",null,a.message),Object.keys(a.importedData.post_types||{}).map(p=>a.importedData.post_types[p]&&a.importedData.post_types[p].length>0&&Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("div",null,Tangible.Preact.createElement("b",null,k[p]||"Templates")),Tangible.Preact.createElement("ul",null,a.importedData.post_types[p].map((o,u)=>Tangible.Preact.createElement("li",{key:`post-${u}`},a.importedData.old_to_new_id&&a.importedData.old_to_new_id[o.id]?Tangible.Preact.createElement("a",{href:`post.php?post=${a.importedData.old_to_new_id[o.id]}&action=edit`},o.title):o.title))))),a.duplicatesFound.length>0&&Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("p",{style:{fontWeight:"bold",color:"red"}},a.duplicatesFound.length," duplicate template",a.duplicatesFound!==1?"s":""," found"),Object.keys(k).map(p=>{const o=a.duplicatesFound.filter(u=>u.post_type===p);if(o.length)return Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("div",null,Tangible.Preact.createElement("b",null,k[p]||"Templates")),Tangible.Preact.createElement("ul",null,o.map((u,b)=>Tangible.Preact.createElement("li",{key:`duplicate-post-${b}`},u.title))))}),Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",onClick:()=>{D({mode:"overwrite",inputStateRef:r,setInputState:l})}},"Overwrite"),"\xA0",Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",onClick:()=>{D({mode:"keep_both",inputStateRef:r,setInputState:l})}},"Keep both"),"\xA0",Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",onClick:()=>{l(h(O({},r.current),{importing:!1,importData:{},importedData:{},duplicatesFound:[],duplicatesHandledMessage:"",message:""}))}},"Skip"),a.duplicatesHandledMessage&&Tangible.Preact.createElement("p",null,a.duplicatesHandledMessage)))},"Importer");var A=Object.defineProperty,B=Object.getOwnPropertySymbols,be=Object.prototype.hasOwnProperty,fe=Object.prototype.propertyIsEnumerable,V=c((e,t,a)=>t in e?A(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,"o"),ye=c((e,t)=>{for(var a in t||(t={}))be.call(t,a)&&V(e,a,t[a]);if(B)for(var a of B(t))fe.call(t,a)&&V(e,a,t[a]);return e},"f$1"),ve=c((e,t)=>A(e,"name",{value:t,configurable:!0}),"g$2");const{jQuery:Pe}=window,N=ve(({labelForEmptyValue:e="",options:t=[],value:a="",onChange:l,multiSelect:s,style:m})=>{const n=Tangible.Preact.useRef();if(Tangible.Preact.useEffect(()=>{const r=Pe(n.current);n.current.$el=r,l(a),r.tangibleSelect({minimumResultsForSearch:5}),s&&(r.val(a),r.trigger("change")),r.on("change",function(p){if(!s){l(p.target.value);return}if(!n.current)return;const o=r.select2("data").map(u=>u.id);l(o)});const g=n.current.select2=r.data("select2");return()=>{g&&g.destroy()}},[]),n.current&&n.current.$el)if(s){const r=n.current.$el.val();a.length!==r.length&&t.length&&setImmediate(function(){n.current.$el.val(a),n.current.$el.trigger("change")})}else n.current.value!==a&&(n.current.$el.val(a),n.current.$el.trigger("change"));return Tangible.Preact.createElement("select",{ref:n,autoComplete:"off",multiple:s,style:ye({display:"none",width:"160px"},m)},e&&Tangible.Preact.createElement("option",{value:"",disabled:!0,selected:a==null},e),t.map((r,g)=>Tangible.Preact.createElement("option",{key:`option-${g}`,value:r.value,selected:r.value===a},r.label)))},"Select");var U=Object.defineProperty,z=Object.getOwnPropertySymbols,Te=Object.prototype.hasOwnProperty,_e=Object.prototype.propertyIsEnumerable,K=c((e,t,a)=>t in e?U(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,"r$1"),F=c((e,t)=>{for(var a in t||(t={}))Te.call(t,a)&&K(e,a,t[a]);if(z)for(var a of z(t))_e.call(t,a)&&K(e,a,t[a]);return e},"c"),Ee=c((e,t)=>U(e,"name",{value:t,configurable:!0}),"b");const{templateSystemHasPlugin:R={}}=window.Tangible,Oe=Ee(({rule:e,ruleIndex:t,exportRulesRef:a,setExportRules:l,templateTypeItemOptionsRef:s,ensureTemplateTypeItemOptions:m})=>Tangible.Preact.createElement("div",{className:"export-rule"},Tangible.Preact.createElement("div",{className:"export-rule-part"},Tangible.Preact.createElement(N,F({},{labelForEmptyValue:"Select template type",options:[...R.blocks&&R.blocks_editor?[{label:"Block",value:"tangible_block"}]:[],...R.loops?[{label:"Template",value:"tangible_template"},{label:"Style",value:"tangible_style"},{label:"Script",value:"tangible_script"},{label:"Layout",value:"tangible_layout"}]:[]],value:e.field,onChange(n){e.field=n,a.current[t]=e,l(a.current)}}))),e.field&&Tangible.Preact.createElement("div",{className:"export-rule-part"},Tangible.Preact.createElement(N,F({},{options:[{label:"All",value:"all"},{label:"Include",value:"include"},{label:"Exclude",value:"exclude"}],value:e.operator,onChange(n){e.operator=n,n==="all"&&(e.values=[]),a.current[t]=e,l(a.current),n!=="all"&&m(e.field)},style:{width:"auto"}}))),e.field&&e.operator!=="all"&&s.current[e.field]&&Tangible.Preact.createElement("div",{className:"export-rule-part"},Tangible.Preact.createElement(N,F({},{options:s.current[e.field]instanceof Promise?[]:s.current[e.field],value:e.values,onChange(n){e.values=n,a.current[t]=e,l(a.current)},multiSelect:!0}))),Tangible.Preact.createElement("div",{className:"export-rule-part export-rule-part--remove-rule"},Tangible.Preact.createElement("div",{className:"icon",onClick:()=>{a.current.splice(t,1),l(a.current)}},Tangible.Preact.createElement("svg",{viewBox:"0 0 1792 1792",xmlns:"http://www.w3.org/2000/svg"},Tangible.Preact.createElement("path",{d:"M1490 1322q0 40-28 68l-136 136q-28 28-68 28t-68-28l-294-294-294 294q-28 28-68 28t-68-28l-136-136q-28-28-28-68t28-68l294-294-294-294q-28-28-28-68t28-68l136-136q28-28 68-28t68 28l294 294 294-294q28-28 68-28t68 28l136 136q28 28 28 68t-28 68l-294 294 294 294q28 28 28 68z"}))))),"ExportRule");var he=Object.defineProperty,Q=c((e,t)=>he(e,"name",{value:t,configurable:!0}),"e$1");function W(e){!window.localStorage||window.localStorage.setItem("exporterState",JSON.stringify(e))}c(W,"saveStateToLocalStorage"),Q(W,"saveStateToLocalStorage");function G(){if(!window.localStorage)return;let e=window.localStorage.getItem("exporterState");if(e)try{return e=JSON.parse(e),e}catch(t){}}c(G,"getSavedStateFromLocalStorage"),Q(G,"getSavedStateFromLocalStorage");var X=Object.defineProperty,we=Object.defineProperties,Se=Object.getOwnPropertyDescriptors,Y=Object.getOwnPropertySymbols,xe=Object.prototype.hasOwnProperty,$e=Object.prototype.propertyIsEnumerable,Z=c((e,t,a)=>t in e?X(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,"R"),_=c((e,t)=>{for(var a in t||(t={}))xe.call(t,a)&&Z(e,a,t[a]);if(Y)for(var a of Y(t))$e.call(t,a)&&Z(e,a,t[a]);return e},"s"),ee=c((e,t)=>we(e,Se(t)),"f"),S=c((e,t)=>X(e,"name",{value:t,configurable:!0}),"l");const Ie=!1,I=S((...e)=>Ie,"log"),j=G(),te=j&&j.name||"tangible-templates",je=j&&j.rules||[{field:"tangible_template",operator:"all",values:[]}],De=S(()=>{const e=Tangible.Preact.useRef(),[t,a]=Tangible.Preact.useState(je),l=Tangible.Preact.useRef();l.current=t;const s=S(i=>{a([...i])},"setExportRules"),[m,n]=Tangible.Preact.useState({}),r=Tangible.Preact.useRef();r.current=m;const[g,p]=Tangible.Preact.useState({exporting:!1,message:"",json:"",packageName:""}),o=Tangible.Preact.useRef();o.current=g;const u=S(i=>{p(_(_({},o.current),i))},"setExportState"),b=S(async i=>{if(r.current[i])return;I("ensureTemplateTypeItemOptions",i,r.current);const d=P(T+"get_template_type_item_options",{post_type:i}).then(f=>{I("ensureTemplateTypeItemOptions Success",f),n(ee(_({},r.current),{[i]:f}))}).catch(f=>{I("ensureTemplateTypeItemOptions Fail",f)});n(ee(_({},r.current),{[i]:d}))},"ensureTemplateTypeItemOptions");return Tangible.Preact.createElement("div",{id:"exporter"},Tangible.Preact.createElement("div",{className:"export-name"},"Package name:"," ",Tangible.Preact.createElement("input",{type:"text",name:"name",defaultValue:te,ref:e})),Tangible.Preact.createElement("div",{className:"export-rules"},t.map((i,d)=>Tangible.Preact.createElement(Oe,_({key:`export-rule-${d}`},{rule:i,ruleIndex:d,exportRulesRef:l,setExportRules:s,templateTypeItemOptionsRef:r,ensureTemplateTypeItemOptions:b})))),Tangible.Preact.createElement("p",null,Tangible.Preact.createElement("button",{type:"button",className:"button button-secondary",onClick:()=>{l.current.push({field:"tangible_template",operator:"all",values:[]}),s(l.current)}},"Add export rule")),l.current.length>0&&Tangible.Preact.createElement("p",null,Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",disabled:g.exporting,onClick:()=>{const i=e.current&&e.current.value||te;W({name:i,rules:l.current}),I("Export start",l.current),u({exporting:!0,message:"Exporting.."}),P(T+"export",{export_rules:l.current}).then(d=>{console.log("Export success",d),u({exporting:!1,message:""});const f=_({package_name:i},d),v=new Date().toISOString().slice(0,10).replace(/-/g,""),x=document.createElement("a");x.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(f,null,2)),x.download=`${i}-${v}.json`,x.style.display="none",document.body.appendChild(x),x.click()}).catch(d=>{console.error(d),u({exporting:!1,message:"Error: "+d.message})})}},"Export"),g.message&&Tangible.Preact.createElement("span",{style:{paddingLeft:"1rem"}},g.message)))},"Exporter"),{Tangible:{Preact:ke,templateSystemHasPlugin:ae={}}}=window,re=document.getElementById("tangible_template_import_export_form");re.addEventListener("submit",function(e){e.preventDefault()});const Ne=ae.loops||ae.blocks_editor;ke.render(Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("h1",{className:"wp-heading-inline"},"Import"),Tangible.Preact.createElement(ge,null),Ne&&Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("hr",null),Tangible.Preact.createElement("h1",{className:"wp-heading-inline"},"Export"),Tangible.Preact.createElement(De,null))),re)})();
//# sourceMappingURL=template-import-export.min.js.map
