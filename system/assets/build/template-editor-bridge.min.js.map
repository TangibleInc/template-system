{"version":3,"file":"template-editor-bridge.min.js","sources":["../src/template-editor-bridge/index.ts","../src/template-editor-bridge/global.js"],"sourcesContent":["/**\n * Compatibility layer to help with transition of CodeMirror 5 to 6\n */\n\ndeclare global {\n  interface Window {\n    wp: any\n    Tangible: {\n      ajax: any\n      TemplateSystem: any\n      // Legacy\n      createCodeEditor: typeof createTemplateEditor\n    }\n  }\n}\n\nexport type CodeEditorLegacyInterface = {\n  getValue: () => string\n  focus: () => void\n  refresh: () => void\n  setSize: (width: string | null, height: string | null) => void\n  on: (eventName: string, callback: Function) => void\n  off: (eventName: string, callback: Function) => void\n}\n\nexport type CodeEditorLegacyOptions = {\n  language?: string\n  onSave?: () => void\n}\n\nexport type CodeEditorInterface = CodeEditorLegacyInterface & {\n  updateTextarea: () => void\n}\n\nexport async function createTemplateEditor(\n  textarea: HTMLTextAreaElement,\n  options: CodeEditorLegacyOptions = {}\n): Promise<CodeEditorInterface> {\n  const { CodeEditor } = window.Tangible.TemplateSystem || {}\n\n  if (!CodeEditor) {\n    throw new Error('CodeEditor not found')\n  }\n\n  // console.log('createTemplateEditor', textarea, CodeEditor, options)\n\n  const { language = 'html', onSave } = options\n\n  const listeners = {}\n  let editor\n  \n  const api = {\n    getValue() {\n      if (!editor) return ''\n      return editor.view.state.doc.toString()\n    },\n    focus() {\n      editor && editor.view.focus()\n    },\n    refresh() {},\n    setSize(width: string | null, height: string | null) {},\n\n    on(eventName, callback) {\n      if (!listeners[eventName]) {\n        listeners[eventName] = []\n      }\n      listeners[eventName].push(callback)\n    },\n    emit(eventName, ...args) {\n      if (listeners[eventName]) {\n        for (const listener of listeners[eventName]) {\n          listener(...args)\n        }\n      }\n    },\n    off(eventName, callback) {\n      if (listeners[eventName]) {\n        listeners[eventName] = listeners[eventName].filter(\n          (f) => f !== callback\n        )\n      }\n    },\n\n    // New editor\n    updateTextarea,\n  }\n  \n  // const el = document.createElement('div')\n  const containterClass = 'tangible-template-editor-container'\n\n  if (!textarea.parentNode?.classList.contains(containterClass)) {\n    // el.classList.add(containterClass)\n    textarea.parentNode?.classList.add(containterClass)\n  }\n\n  editor = await CodeEditor.create({\n    // el,\n    lang: language,\n    content: textarea.value,\n    onUpdate(doc) {\n      if (listeners['change']) {\n        api.emit('change') // Caller gets value from editor\n      }\n    },\n    onSave() {\n      if (!onSave) return\n      updateTextarea()\n      onSave()\n    },\n  })\n\n  function updateTextarea() {\n    textarea.value = editor.view.state.doc.toString()\n  }\n\n  /**\n   * Support legacy method of passing textarea instead of div container\n   * @see https://codemirror.net/docs/migration/#codemirror.fromtextarea\n   */\n  textarea.parentNode?.insertBefore(editor.view.dom, textarea)\n\n  if (textarea.form) {\n    textarea.form.addEventListener('submit', () => updateTextarea())\n  }\n\n  return api\n}\n","import { createTemplateEditor } from './index'\n\nwindow.Tangible = window.Tangible || {}\nwindow.Tangible.createCodeEditor = createTemplateEditor\n"],"names":["createTemplateEditor","textarea","options","CodeEditor","language","onSave","listeners","editor","api","width","height","eventName","callback","args","listener","f","updateTextarea","containterClass","doc","__name"],"mappings":"0XAkCsBA,EACpBC,EACAC,EAAmC,CAAA,EACL,CAC9B,KAAM,CAAE,WAAAC,CAAW,EAAI,OAAO,SAAS,gBAAkB,GAEzD,GAAI,CAACA,EACH,MAAM,IAAI,MAAM,sBAAsB,EAKxC,KAAM,CAAE,SAAAC,EAAW,OAAQ,OAAAC,CAAO,EAAIH,EAEhCI,EAAY,GAClB,IAAIC,EAEJ,MAAMC,EAAM,CACV,UAAW,CACT,OAAKD,EACEA,EAAO,KAAK,MAAM,IAAI,WADT,EAEtB,EACA,OAAQ,CACNA,GAAUA,EAAO,KAAK,OACxB,EACA,SAAU,CAAA,EACV,QAAQE,EAAsBC,EAAuB,CAAC,EAEtD,GAAGC,EAAWC,EAAU,CACjBN,EAAUK,CAAS,IACtBL,EAAUK,CAAS,EAAI,CAAA,GAEzBL,EAAUK,CAAS,EAAE,KAAKC,CAAQ,CACpC,EACA,KAAKD,KAAcE,EAAM,CACvB,GAAIP,EAAUK,CAAS,EACrB,UAAWG,KAAYR,EAAUK,CAAS,EACxCG,EAAS,GAAGD,CAAI,CAGtB,EACA,IAAIF,EAAWC,EAAU,CACnBN,EAAUK,CAAS,IACrBL,EAAUK,CAAS,EAAIL,EAAUK,CAAS,EAAE,OACzCI,GAAMA,IAAMH,CACf,EAEJ,EAGA,eAAAI,CACF,EAGMC,EAAkB,qCAEnBhB,EAAS,YAAY,UAAU,SAASgB,CAAe,GAE1DhB,EAAS,YAAY,UAAU,IAAIgB,CAAe,EAGpDV,EAAS,MAAMJ,EAAW,OAAO,CAE/B,KAAMC,EACN,QAASH,EAAS,MAClB,SAASiB,EAAK,CACRZ,EAAU,QACZE,EAAI,KAAK,QAAQ,CAErB,EACA,QAAS,CACFH,IACLW,EAAe,EACfX,EAAO,EACT,CACF,CAAC,EAED,SAASW,GAAiB,CACxBf,EAAS,MAAQM,EAAO,KAAK,MAAM,IAAI,UACzC,CAFSS,OAAAA,EAAAA,EAAAA,KAAAG,EAAAH,EAAA,gBAQTf,EAAAA,EAAS,YAAY,aAAaM,EAAO,KAAK,IAAKN,CAAQ,EAEvDA,EAAS,MACXA,EAAS,KAAK,iBAAiB,SAAU,IAAMe,GAAgB,EAG1DR,CACT,CA5FsBW,EAAAnB,EAAA,wBAAAmB,EAAAnB,EAAA,sBAAA,EChCtB,OAAO,SAAW,OAAO,UAAY,CACrC,EAAA,OAAO,SAAS,iBAAmBA"}