var Ye=Object.defineProperty;var c=(D,F)=>Ye(D,"name",{value:F,configurable:!0});(function(){"use strict";(function(){const t={env:{NODE_ENV:"production"}};try{if(process){process.env=Object.assign({},process.env),Object.assign(process.env,t);return}}catch(e){}globalThis.process={env:t}})();var D=Object.defineProperty,F=Object.getOwnPropertySymbols,ue=Object.prototype.hasOwnProperty,se=Object.prototype.propertyIsEnumerable,B=c((t,e,r)=>e in t?D(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,"o$1"),pe=c((t,e)=>{for(var r in e||(e={}))ue.call(e,r)&&B(t,r,e[r]);if(F)for(var r of F(e))se.call(e,r)&&B(t,r,e[r]);return t},"f$2"),fe=c((t,e)=>D(t,"name",{value:e,configurable:!0}),"g$1");const{jQuery:be}=window,K=fe(({labelForEmptyValue:t="",options:e=[],value:r="",onChange:f,multiSelect:a,style:g})=>{const n=Tangible.Preact.useRef();if(Tangible.Preact.useEffect(()=>{const i=be(n.current);n.current.$el=i,f(r),i.tangibleSelect({minimumResultsForSearch:5}),a&&(i.val(r),i.trigger("change")),i.on("change",function(y){if(!a){f(y.target.value);return}if(!n.current)return;const b=i.select2("data").map(j=>j.id);f(b)});const m=n.current.select2=i.data("select2");return()=>{m&&m.destroy()}},[]),n.current&&n.current.$el)if(a){const i=n.current.$el.val();r.length!==i.length&&e.length&&setImmediate(function(){n.current.$el.val(r),n.current.$el.trigger("change")})}else n.current.value!==r&&(n.current.$el.val(r),n.current.$el.trigger("change"));return Tangible.Preact.createElement("select",{ref:n,autoComplete:"off",multiple:a,style:pe({display:"none",width:"160px"},g)},t&&Tangible.Preact.createElement("option",{value:"",disabled:!0,selected:r==null},t),e.map((i,m)=>Tangible.Preact.createElement("option",{key:`option-${m}`,value:i.value,selected:i.value===r},i.label)))},"Select");var M=Object.defineProperty,J=Object.getOwnPropertySymbols,ge=Object.prototype.hasOwnProperty,ve=Object.prototype.propertyIsEnumerable,Q=c((t,e,r)=>e in t?M(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,"i$3"),de=c((t,e)=>{for(var r in e||(e={}))ge.call(e,r)&&Q(t,r,e[r]);if(J)for(var r of J(e))ve.call(e,r)&&Q(t,r,e[r]);return t},"r$2"),me=c((t,e)=>M(t,"name",{value:e,configurable:!0}),"n$2");const ye=me(({rule:t,setRule:e,ruleProps:r,ensureData:f})=>{const{fieldOptions:a}=r;return Tangible.Preact.createElement("div",{className:"rule-part rule-field"},Tangible.Preact.createElement(K,de({},{labelForEmptyValue:"Select location..",options:a,value:t.field,onChange(g){e({field:g})}})))},"Field");var V=Object.defineProperty,L=Object.getOwnPropertySymbols,Pe=Object.prototype.hasOwnProperty,Oe=Object.prototype.propertyIsEnumerable,z=c((t,e,r)=>e in t?V(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,"g"),je=c((t,e)=>{for(var r in e||(e={}))Pe.call(e,r)&&z(t,r,e[r]);if(L)for(var r of L(e))Oe.call(e,r)&&z(t,r,e[r]);return t},"A$2"),G=c((t,e)=>V(t,"name",{value:e,configurable:!0}),"u$3");const $e=!1,O=G((...t)=>$e,"log"),{ajax:Ee}=window.Tangible,Te="tangible_template_location__",_e=G(({rule:t,ruleDefinitionByField:e,ajaxStateRef:r,setAjaxState:f})=>{if(!t.field)return;const a=e[t.field];if(a)for(const g of["field_2","values"]){if(!a[g])continue;let n=a[g][0];if(!n||n.type!=="select_ajax")continue;if(g==="values"){for(const u of a.values){if(!u.operators||u.operators.indexOf(t.operator)>=0){n=u;break}n=null}if(!n){O("No values select for operator",t.operator);return}}const i=r.current,m=n.ajax_action,y={};if(n.rule_properties_to_ajax){const u=n.rule_properties_to_ajax;for(const l in u){if(!t[l]){O("Missing request key",l);return}y[u[l]]=t[l]}}if(n.ajax_properties){const u=n.ajax_properties;for(const l in u)y[l]=u[l];O("Mapped AJAX properties to values",y)}n.getAjaxActionCacheKey||(n.getAjaxActionCacheKey=function(u){let l=m;if(n.rule_properties_to_ajax){const v=n.rule_properties_to_ajax;for(const o in v)l+="__"+v[o]+"__"+u[o]}return l},n.getOptionsForRule=function(u){const l=n.getAjaxActionCacheKey(u),v=r.current;if(v[l]&&!(v[l]instanceof Promise))return O("Got options for key",l,v[l]),v[l];O("Options not ready for key",l,v)});const b=n.getAjaxActionCacheKey(t),j=G(u=>{O("updatePartDefinition",r.current),f(je({},r.current))},"updatePartDefinition");if(!i[b]){const u=Te+m;O("Getting data..",u,y),i[b]=Ee(u,y).then(l=>(r.current[b]=l,O("Got data",b,r.current[b]),j(l),l)).catch(l=>{O("Failed to get data",b,l)});return}if(i[b]instanceof Promise){O("Fetch in progress",b);return}}},"ensureDataForRule");var H=Object.defineProperty,he=Object.defineProperties,we=Object.getOwnPropertyDescriptors,X=Object.getOwnPropertySymbols,xe=Object.prototype.hasOwnProperty,Se=Object.prototype.propertyIsEnumerable,U=c((t,e,r)=>e in t?H(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,"F"),h=c((t,e)=>{for(var r in e||(e={}))xe.call(e,r)&&U(t,r,e[r]);if(X)for(var r of X(e))Se.call(e,r)&&U(t,r,e[r]);return t},"r$1"),W=c((t,e)=>he(t,we(e)),"q"),A=c((t,e)=>H(t,"name",{value:e,configurable:!0}),"p");const Re=!1,_=A((...t)=>Re,"log"),De=A(({ruleGroups:t,setRuleGroups:e,group:r,groupIndex:f,rule:a,ruleIndex:g,ruleProps:n})=>{_("--- Rule ---",a);const i=Tangible.Preact.useRef();i.current=a;const{ruleDefinitionByField:m,ajaxStateRef:y,setAjaxState:b}=n,j=A((o={})=>{r[g]=h(h({},a),o),t[f]=r,e()},"setRule"),u=Tangible.Preact.useCallback(()=>{_e({rule:a,ruleDefinitionByField:m,ajaxStateRef:y,setAjaxState:b})},[a]);u();const l=a.field&&m[a.field],v=A(o=>{if(!l||!l[o])return;let s=l[o][0];if(!(o==="operators"||s&&(s.type==="select"||s.type==="select_ajax"))){const{type:p,placeholder:S,description:T}=s||{};if(p==="input"){let R=a[o];return Tangible.Preact.createElement("div",{className:`rule-part rule-${o}`},Tangible.Preact.createElement("input",{type:"text",placeholder:S,value:R,onChange:k=>{const w=i.current;j(W(h({},w),{[o]:k.target.value}))}}),T&&Tangible.Preact.createElement("small",{style:{display:"block"}},T))}return}if(o==="values"){for(const p of l.values){if(!p.operators||p.operators.indexOf(a.operator)>=0){s=p;break}s=null}if(!s){_("No values select for operator",a.operator);return}}const d=o==="operators",P=d?"operator":o.replace(/values/,"value"),N=d||a.operator==="exclude"?"":s.label_for_empty_value,$=d?l[o].filter(p=>!p.field_2||p.field_2.indexOf(a.field_2)>=0).map(p=>({value:p.name,label:p.label})):s.getOptionsForRule?s.getOptionsForRule(a):s.options;if(!$){_("Options not available yet");return}d&&_("Operator options",$);let E=a[P];return!s.multi_select&&!E&&!N&&$[0]&&$[0].value&&(E=a[P]=$[0].value,_("Select first option by default",P,E),j(a)),_("partSelect",P,a[P]),Tangible.Preact.createElement("div",{className:`rule-part rule-${o}`},Tangible.Preact.createElement(K,h({},{labelForEmptyValue:N,options:$,value:E,onChange(p){const S=i.current,T=W(h({},S),{[P]:p});_("Next rule",T),j(T)},multiSelect:!d&&s.multi_select,style:d?{width:"auto"}:{}})))},"partSelect");return Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("div",{className:"rule"},Tangible.Preact.createElement("div",{className:"rule-parts"},Tangible.Preact.createElement(ye,h({},{rule:a,setRule:j,ruleProps:n,ensureData:u})),v("field_2"),l&&(!l.field_2||a.field_2)&&v("operators"),l&&(!l.field_2||a.field_2)&&v("values")),Tangible.Preact.createElement("div",{className:"rule-actions"},Tangible.Preact.createElement("div",{className:"rule-action rule-action--remove-rule"},Tangible.Preact.createElement("div",{className:"icon",onClick:()=>{r.splice(g,1),r.length?t[f]=r:t.splice(f,1),e()}},Tangible.Preact.createElement("svg",{viewBox:"0 0 1792 1792",xmlns:"http://www.w3.org/2000/svg"},Tangible.Preact.createElement("path",{d:"M1490 1322q0 40-28 68l-136 136q-28 28-68 28t-68-28l-294-294-294 294q-28 28-68 28t-68-28l-136-136q-28-28-28-68t28-68l294-294-294-294q-28-28-28-68t28-68l136-136q28-28 68-28t68 28l294 294 294-294q28-28 68-28t68 28l136 136q28 28 28 68t-28 68l-294 294 294 294q28 28 28 68z"})))))),l&&l.description&&Tangible.Preact.createElement("p",{dangerouslySetInnerHTML:{__html:l.description}}))},"Rule");var Y=Object.defineProperty,Z=Object.getOwnPropertySymbols,Fe=Object.prototype.hasOwnProperty,Ae=Object.prototype.propertyIsEnumerable,ee=c((t,e,r)=>e in t?Y(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,"i$1"),Ne=c((t,e)=>{for(var r in e||(e={}))Fe.call(e,r)&&ee(t,r,e[r]);if(Z)for(var r of Z(e))Ae.call(e,r)&&ee(t,r,e[r]);return t},"n$1"),re=c((t,e)=>Y(t,"name",{value:e,configurable:!0}),"u$2");const ke=re(()=>[{}],"createNewRuleGroup"),Ge=re(({ruleGroups:t,setRuleGroups:e,ruleProps:r})=>Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("div",{className:"rule-groups"},t.map((f,a)=>Tangible.Preact.createElement("div",{key:`rule-group-${a}`,className:"rule-group"},f.map((g,n)=>Tangible.Preact.createElement(De,Ne({key:`rule-group-${a}-rule-${n}`},{ruleGroups:t,setRuleGroups:e,group:f,groupIndex:a,rule:g,ruleIndex:n,ruleProps:r})))))),Tangible.Preact.createElement("button",{type:"button",className:"button button--add-rule-group",onClick:()=>{t.push(ke()),e(t)}},"Add location")),"RuleGroups");var te=Object.defineProperty,Ce=Object.defineProperties,Ie=Object.getOwnPropertyDescriptors,ae=Object.getOwnPropertySymbols,qe=Object.prototype.hasOwnProperty,Be=Object.prototype.propertyIsEnumerable,ne=c((t,e,r)=>e in t?te(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,"E"),le=c((t,e)=>{for(var r in e||(e={}))qe.call(e,r)&&ne(t,r,e[r]);if(ae)for(var r of ae(e))Be.call(e,r)&&ne(t,r,e[r]);return t},"d$1"),Ke=c((t,e)=>Ce(t,Ie(e)),"D"),C=c((t,e)=>te(t,"name",{value:e,configurable:!0}),"u$1");const{jQuery:I}=window,Me=!1,oe=C((...t)=>Me,"log"),Je=C(({data:t,ruleDefinitions:e})=>{const[r,f]=Tangible.Preact.useState(t),a=Tangible.Preact.useRef();a.current=r;const[g,n]=Tangible.Preact.useState({}),i=Tangible.Preact.useRef();i.current=g;const m=Tangible.Preact.useRef(),y=Tangible.Preact.useRef(),{rule_groups:b=[]}=r,j=C(()=>f(o=>Ke(le({},o),{rule_groups:b})),"setRuleGroups"),{fieldOptions:u,ruleDefinitionByField:l}=Tangible.Preact.useMemo(()=>{const o=[],s={};return e.forEach(d=>{o.push({value:d.name,label:d.label}),s[d.name]=d}),oe("ruleDefinitionByField",s),{fieldOptions:o,ruleDefinitionByField:s}},[]),v={ruleDefinitions:e,fieldOptions:u,ruleDefinitionByField:l,ajaxStateRef:i,setAjaxState:n};return Tangible.Preact.useEffect(()=>{let o="";const s=I(m.current).find(".rule");for(let P=0,N=s.length;P<N;P++){const $=I(s[P]).find(".rule-part");let E="";for(let p=0,S=$.length;p<S;p++){const T=I($[p]),R=T.find("select");if(!R[0]){const w=T.find("input");w&&(E+=(p>0?" ":"")+w.val());continue}if(!R[0].select2)continue;const k=R.select2("data");!Array.isArray(k)||(E+=(p>0?" ":"")+k.map(w=>w.text).join(", "))}o+=(P>0?"<br>":"")+E}oe("Description:",o);const d=a.current;d.description=o,y.current.value=JSON.stringify(d)}),Tangible.Preact.createElement("div",{ref:m},Tangible.Preact.createElement("input",{type:"hidden",name:"location",ref:y,value:JSON.stringify(r)}),Tangible.Preact.createElement(Ge,le({},{ruleGroups:b,setRuleGroups:j,ruleProps:v})))},"LocationEditor");var Qe=Object.defineProperty,ie=Object.getOwnPropertySymbols,Ve=Object.prototype.hasOwnProperty,Le=Object.prototype.propertyIsEnumerable,ce=c((t,e,r)=>e in t?Qe(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,"n"),ze=c((t,e)=>{for(var r in e||(e={}))Ve.call(e,r)&&ce(t,r,e[r]);if(ie)for(var r of ie(e))Le.call(e,r)&&ce(t,r,e[r]);return t},"c");const{jQuery:He,Tangible:{Preact:Xe}}=window,q=He("#post .template-location-editor"),Ue=q[0];let x=q.data("location");x=typeof x=="object"&&!Array.isArray(x)?x:{};const We=q.data("ruleDefinitions")||[];Xe.render(Tangible.Preact.createElement(Je,ze({},{data:x,ruleDefinitions:We})),Ue)})();
//# sourceMappingURL=template-location-editor.min.js.map
