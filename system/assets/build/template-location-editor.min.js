var se=Object.defineProperty;var j=(N,w)=>se(N,"name",{value:w,configurable:!0});(function(){"use strict";(function(){const e={NODE_ENV:"production"};try{if(process){process.env=Object.assign({},process.env),Object.assign(process.env,e);return}}catch{}globalThis.process={env:e}})();var N=Object.defineProperty,w=j((e,n)=>N(e,"name",{value:n,configurable:!0}),"o$1");const{jQuery:K}=window,B=w(({labelForEmptyValue:e="",options:n=[],value:l="",onChange:p,multiSelect:t,style:g})=>{const r=Tangible.Preact.useRef();if(Tangible.Preact.useEffect(()=>{const i=K(r.current);r.current.$el=i,p(l),i.tangibleSelect({minimumResultsForSearch:5}),t&&(i.val(l),i.trigger("change")),i.on("change",function(v){if(!t){p(v.target.value);return}if(!r.current)return;const f=i.select2("data").map(T=>T.id);p(f)});const m=r.current.select2=i.data("select2");return()=>{m&&m.destroy()}},[]),r.current&&r.current.$el)if(t){const i=r.current.$el.val();l.length!==i.length&&n.length&&setTimeout(function(){r.current.$el.val(l),r.current.$el.trigger("change")},0)}else r.current.value!==l&&(r.current.$el.val(l),r.current.$el.trigger("change"));return Tangible.Preact.createElement("select",{ref:r,autoComplete:"off",multiple:t,style:{display:"none",width:"160px",...g}},e&&Tangible.Preact.createElement("option",{value:"",disabled:!0,selected:l==null},e),n.map((i,m)=>Tangible.Preact.createElement("option",{key:`option-${m}`,value:i.value,selected:i.value===l},i.label)))},"Select");var V=Object.defineProperty,J=j((e,n)=>V(e,"name",{value:n,configurable:!0}),"t$1");const L=J(({rule:e,setRule:n,ruleProps:l,ensureData:p})=>{const{fieldOptions:t}=l;return Tangible.Preact.createElement("div",{className:"rule-part rule-field"},Tangible.Preact.createElement(B,{labelForEmptyValue:"Select location..",options:t,value:e.field,onChange(g){n({field:g})}}))},"Field");var Q=Object.defineProperty,G=j((e,n)=>Q(e,"name",{value:n,configurable:!0}),"f");const z=!1,y=G((...e)=>z,"log"),{ajax:H}=window.Tangible,X="tangible_template_location__",U=G(({rule:e,ruleDefinitionByField:n,ajaxStateRef:l,setAjaxState:p})=>{if(!e.field)return;const t=n[e.field];if(t)for(const g of["field_2","values"]){if(!t[g])continue;let r=t[g][0];if(!r||r.type!=="select_ajax")continue;if(g==="values"){for(const c of t.values){if(!c.operators||c.operators.indexOf(e.operator)>=0){r=c;break}r=null}if(!r){y("No values select for operator",e.operator);return}}const i=l.current,m=r.ajax_action,v={};if(r.rule_properties_to_ajax){const c=r.rule_properties_to_ajax;for(const a in c){if(!e[a]){y("Missing request key",a);return}v[c[a]]=e[a]}}if(r.ajax_properties){const c=r.ajax_properties;for(const a in c)v[a]=c[a];y("Mapped AJAX properties to values",v)}r.getAjaxActionCacheKey||(r.getAjaxActionCacheKey=function(c){let a=m;if(r.rule_properties_to_ajax){const d=r.rule_properties_to_ajax;for(const o in d)a+="__"+d[o]+"__"+c[o]}return a},r.getOptionsForRule=function(c){const a=r.getAjaxActionCacheKey(c),d=l.current;if(d[a]&&!(d[a]instanceof Promise))return y("Got options for key",a,d[a]),d[a];y("Options not ready for key",a,d)});const f=r.getAjaxActionCacheKey(e),T=G(c=>{y("updatePartDefinition",l.current),p({...l.current})},"updatePartDefinition");if(!i[f]){const c=X+m;y("Getting data..",c,v),i[f]=H(c,v).then(a=>(l.current[f]=a,y("Got data",f,l.current[f]),T(a),a)).catch(a=>{y("Failed to get data",f,a)});return}if(i[f]instanceof Promise){y("Fetch in progress",f);return}}},"ensureDataForRule");var W=Object.defineProperty,A=j((e,n)=>W(e,"name",{value:n,configurable:!0}),"u");const Y=!1,E=A((...e)=>Y,"log"),Z=A(({ruleGroups:e,setRuleGroups:n,group:l,groupIndex:p,rule:t,ruleIndex:g,ruleProps:r})=>{E("--- Rule ---",t);const i=Tangible.Preact.useRef();i.current=t;const{ruleDefinitionByField:m,ajaxStateRef:v,setAjaxState:f}=r,T=A((o={})=>{l[g]={...t,...o},e[p]=l,n()},"setRule"),c=Tangible.Preact.useCallback(()=>{U({rule:t,ruleDefinitionByField:m,ajaxStateRef:v,setAjaxState:f})},[t]);c();const a=t.field&&m[t.field],d=A(o=>{if(!a||!a[o])return;let u=a[o][0];if(!(o==="operators"||u&&(u.type==="select"||u.type==="select_ajax"))){const{type:s,placeholder:h,description:$}=u||{};if(s==="input"){let S=t[o];return Tangible.Preact.createElement("div",{className:`rule-part rule-${o}`},Tangible.Preact.createElement("input",{type:"text",placeholder:h,value:S,onChange:F=>{const R=i.current;T({...R,[o]:F.target.value})}}),$&&Tangible.Preact.createElement("small",{style:{display:"block"}},$))}return}if(o==="values"){for(const s of a.values){if(!s.operators||s.operators.indexOf(t.operator)>=0){u=s;break}u=null}if(!u){E("No values select for operator",t.operator);return}}const b=o==="operators",P=b?"operator":o.replace(/values/,"value"),D=b||t.operator==="exclude"?"":u.label_for_empty_value,_=b?a[o].filter(s=>!s.field_2||s.field_2.indexOf(t.field_2)>=0).map(s=>({value:s.name,label:s.label})):u.getOptionsForRule?u.getOptionsForRule(t):u.options;if(!_){E("Options not available yet");return}b&&E("Operator options",_);let x=t[P];return!u.multi_select&&!x&&!D&&_[0]&&_[0].value&&(x=t[P]=_[0].value,E("Select first option by default",P,x),T(t)),E("partSelect",P,t[P]),Tangible.Preact.createElement("div",{className:`rule-part rule-${o}`},Tangible.Preact.createElement(B,{labelForEmptyValue:D,options:_,value:x,onChange(s){const h={...i.current,[P]:s};E("Next rule",h),T(h)},multiSelect:!b&&u.multi_select,style:b?{width:"auto"}:{}}))},"partSelect");return Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("div",{className:"rule"},Tangible.Preact.createElement("div",{className:"rule-parts"},Tangible.Preact.createElement(L,{rule:t,setRule:T,ruleProps:r,ensureData:c}),d("field_2"),a&&(!a.field_2||t.field_2)&&d("operators"),a&&(!a.field_2||t.field_2)&&d("values")),Tangible.Preact.createElement("div",{className:"rule-actions"},Tangible.Preact.createElement("div",{className:"rule-action rule-action--remove-rule"},Tangible.Preact.createElement("div",{className:"icon",onClick:()=>{l.splice(g,1),l.length?e[p]=l:e.splice(p,1),n()}},Tangible.Preact.createElement("svg",{viewBox:"0 0 1792 1792",xmlns:"http://www.w3.org/2000/svg"},Tangible.Preact.createElement("path",{d:"M1490 1322q0 40-28 68l-136 136q-28 28-68 28t-68-28l-294-294-294 294q-28 28-68 28t-68-28l-136-136q-28-28-28-68t28-68l294-294-294-294q-28-28-28-68t28-68l136-136q28-28 68-28t68 28l294 294 294-294q28-28 68-28t68 28l136 136q28 28 28 68t-28 68l-294 294 294 294q28 28 28 68z"})))))),a&&a.description&&Tangible.Preact.createElement("p",{dangerouslySetInnerHTML:{__html:a.description}}))},"Rule");var ee=Object.defineProperty,I=j((e,n)=>ee(e,"name",{value:n,configurable:!0}),"e");const te=I(()=>[{}],"createNewRuleGroup"),re=I(({ruleGroups:e,setRuleGroups:n,ruleProps:l})=>Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("div",{className:"rule-groups"},e.map((p,t)=>Tangible.Preact.createElement("div",{key:`rule-group-${t}`,className:"rule-group"},p.map((g,r)=>Tangible.Preact.createElement(Z,{key:`rule-group-${t}-rule-${r}`,ruleGroups:e,setRuleGroups:n,group:p,groupIndex:t,rule:g,ruleIndex:r,ruleProps:l}))))),Tangible.Preact.createElement("button",{type:"button",className:"button button--add-rule-group",onClick:()=>{e.push(te()),n(e)}},"Add location")),"RuleGroups");var ae=Object.defineProperty,k=j((e,n)=>ae(e,"name",{value:n,configurable:!0}),"l");const{jQuery:C}=window,le=!1,M=k((...e)=>le,"log"),ne=k(({data:e,ruleDefinitions:n})=>{const[l,p]=Tangible.Preact.useState(e),t=Tangible.Preact.useRef();t.current=l;const[g,r]=Tangible.Preact.useState({}),i=Tangible.Preact.useRef();i.current=g;const m=Tangible.Preact.useRef(),v=Tangible.Preact.useRef(),{rule_groups:f=[]}=l,T=k(()=>p(o=>({...o,rule_groups:f})),"setRuleGroups"),{fieldOptions:c,ruleDefinitionByField:a}=Tangible.Preact.useMemo(()=>{const o=[],u={};return n.forEach(b=>{o.push({value:b.name,label:b.label}),u[b.name]=b}),M("ruleDefinitionByField",u),{fieldOptions:o,ruleDefinitionByField:u}},[]),d={ruleDefinitions:n,fieldOptions:c,ruleDefinitionByField:a,ajaxStateRef:i,setAjaxState:r};return Tangible.Preact.useEffect(()=>{let o="";const u=C(m.current).find(".rule");for(let P=0,D=u.length;P<D;P++){const _=C(u[P]).find(".rule-part");let x="";for(let s=0,h=_.length;s<h;s++){const $=C(_[s]),S=$.find("select");if(!S[0]){const R=$.find("input");R&&(x+=(s>0?" ":"")+R.val());continue}if(!S[0].select2)continue;const F=S.select2("data");Array.isArray(F)&&(x+=(s>0?" ":"")+F.map(R=>R.text).join(", "))}o+=(P>0?"<br>":"")+x}M("Description:",o);const b=t.current;b.description=o,v.current.value=JSON.stringify(b)}),Tangible.Preact.createElement("div",{ref:m},Tangible.Preact.createElement("input",{type:"hidden",name:"location",ref:v,value:JSON.stringify(l)}),Tangible.Preact.createElement(re,{ruleGroups:f,setRuleGroups:T,ruleProps:d}))},"LocationEditor"),{jQuery:oe,Tangible:{Preact:ie}}=window,q=oe("#post .template-location-editor"),ce=q[0];let O=q.data("location");O=typeof O=="object"&&!Array.isArray(O)?O:{};const ue=q.data("ruleDefinitions")||[];ie.render(Tangible.Preact.createElement(ne,{data:O,ruleDefinitions:ue}),ce)})();
//# sourceMappingURL=template-location-editor.min.js.map
