var Ge=Object.defineProperty;var p=(S,D)=>Ge(S,"name",{value:D,configurable:!0});(function(){"use strict";(function(){const t={env:{NODE_ENV:"production"}};try{if(process){process.env=Object.assign({},process.env),Object.assign(process.env,t);return}}catch(e){}globalThis.process={env:t}})();var S=Object.defineProperty,D=Object.getOwnPropertySymbols,ee=Object.prototype.hasOwnProperty,te=Object.prototype.propertyIsEnumerable,B=p((t,e,r)=>e in t?S(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,"o$1"),re=p((t,e)=>{for(var r in e||(e={}))ee.call(e,r)&&B(t,r,e[r]);if(D)for(var r of D(e))te.call(e,r)&&B(t,r,e[r]);return t},"f"),ae=p((t,e)=>S(t,"name",{value:e,configurable:!0}),"g$1");const{jQuery:ne}=window,K=ae(({labelForEmptyValue:t="",options:e=[],value:r="",onChange:f,multiSelect:a,style:b})=>{const n=Tangible.Preact.useRef();if(Tangible.Preact.useEffect(()=>{const i=ne(n.current);n.current.$el=i,f(r),i.tangibleSelect({minimumResultsForSearch:5}),a&&(i.val(r),i.trigger("change")),i.on("change",function(y){if(!a){f(y.target.value);return}if(!n.current)return;const g=i.select2("data").map(O=>O.id);f(g)});const m=n.current.select2=i.data("select2");return()=>{m&&m.destroy()}},[]),n.current&&n.current.$el)if(a){const i=n.current.$el.val();r.length!==i.length&&e.length&&setImmediate(function(){n.current.$el.val(r),n.current.$el.trigger("change")})}else n.current.value!==r&&(n.current.$el.val(r),n.current.$el.trigger("change"));return Tangible.Preact.createElement("select",{ref:n,autoComplete:"off",multiple:a,style:re({display:"none",width:"160px"},b)},t&&Tangible.Preact.createElement("option",{value:"",disabled:!0,selected:r==null},t),e.map((i,m)=>Tangible.Preact.createElement("option",{key:`option-${m}`,value:i.value,selected:i.value===r},i.label)))},"Select");var le=Object.defineProperty,oe=p((t,e)=>le(t,"name",{value:e,configurable:!0}),"t$1");const ie=oe(({rule:t,setRule:e,ruleProps:r,ensureData:f})=>{const{fieldOptions:a}=r;return Tangible.Preact.createElement("div",{className:"rule-part rule-field"},Tangible.Preact.createElement(K,{labelForEmptyValue:"Select location..",options:a,value:t.field,onChange(b){e({field:b})}}))},"Field");var M=Object.defineProperty,J=Object.getOwnPropertySymbols,ce=Object.prototype.hasOwnProperty,ue=Object.prototype.propertyIsEnumerable,Q=p((t,e,r)=>e in t?M(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,"g"),se=p((t,e)=>{for(var r in e||(e={}))ce.call(e,r)&&Q(t,r,e[r]);if(J)for(var r of J(e))ue.call(e,r)&&Q(t,r,e[r]);return t},"A$2"),G=p((t,e)=>M(t,"name",{value:e,configurable:!0}),"u$2");const pe=!1,j=G((...t)=>pe,"log"),{ajax:fe}=window.Tangible,ge="tangible_template_location__",be=G(({rule:t,ruleDefinitionByField:e,ajaxStateRef:r,setAjaxState:f})=>{if(!t.field)return;const a=e[t.field];if(a)for(const b of["field_2","values"]){if(!a[b])continue;let n=a[b][0];if(!n||n.type!=="select_ajax")continue;if(b==="values"){for(const c of a.values){if(!c.operators||c.operators.indexOf(t.operator)>=0){n=c;break}n=null}if(!n){j("No values select for operator",t.operator);return}}const i=r.current,m=n.ajax_action,y={};if(n.rule_properties_to_ajax){const c=n.rule_properties_to_ajax;for(const l in c){if(!t[l]){j("Missing request key",l);return}y[c[l]]=t[l]}}if(n.ajax_properties){const c=n.ajax_properties;for(const l in c)y[l]=c[l];j("Mapped AJAX properties to values",y)}n.getAjaxActionCacheKey||(n.getAjaxActionCacheKey=function(c){let l=m;if(n.rule_properties_to_ajax){const d=n.rule_properties_to_ajax;for(const o in d)l+="__"+d[o]+"__"+c[o]}return l},n.getOptionsForRule=function(c){const l=n.getAjaxActionCacheKey(c),d=r.current;if(d[l]&&!(d[l]instanceof Promise))return j("Got options for key",l,d[l]),d[l];j("Options not ready for key",l,d)});const g=n.getAjaxActionCacheKey(t),O=G(c=>{j("updatePartDefinition",r.current),f(se({},r.current))},"updatePartDefinition");if(!i[g]){const c=ge+m;j("Getting data..",c,y),i[g]=fe(c,y).then(l=>(r.current[g]=l,j("Got data",g,r.current[g]),O(l),l)).catch(l=>{j("Failed to get data",g,l)});return}if(i[g]instanceof Promise){j("Fetch in progress",g);return}}},"ensureDataForRule");var V=Object.defineProperty,de=Object.defineProperties,ve=Object.getOwnPropertyDescriptors,L=Object.getOwnPropertySymbols,me=Object.prototype.hasOwnProperty,ye=Object.prototype.propertyIsEnumerable,z=p((t,e,r)=>e in t?V(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,"F"),F=p((t,e)=>{for(var r in e||(e={}))me.call(e,r)&&z(t,r,e[r]);if(L)for(var r of L(e))ye.call(e,r)&&z(t,r,e[r]);return t},"u$1"),H=p((t,e)=>de(t,ve(e)),"q"),A=p((t,e)=>V(t,"name",{value:e,configurable:!0}),"p$1");const Pe=!1,$=A((...t)=>Pe,"log"),je=A(({ruleGroups:t,setRuleGroups:e,group:r,groupIndex:f,rule:a,ruleIndex:b,ruleProps:n})=>{$("--- Rule ---",a);const i=Tangible.Preact.useRef();i.current=a;const{ruleDefinitionByField:m,ajaxStateRef:y,setAjaxState:g}=n,O=A((o={})=>{r[b]=F(F({},a),o),t[f]=r,e()},"setRule"),c=Tangible.Preact.useCallback(()=>{be({rule:a,ruleDefinitionByField:m,ajaxStateRef:y,setAjaxState:g})},[a]);c();const l=a.field&&m[a.field],d=A(o=>{if(!l||!l[o])return;let u=l[o][0];if(!(o==="operators"||u&&(u.type==="select"||u.type==="select_ajax"))){const{type:s,placeholder:w,description:E}=u||{};if(s==="input"){let R=a[o];return Tangible.Preact.createElement("div",{className:`rule-part rule-${o}`},Tangible.Preact.createElement("input",{type:"text",placeholder:w,value:R,onChange:k=>{const h=i.current;O(H(F({},h),{[o]:k.target.value}))}}),E&&Tangible.Preact.createElement("small",{style:{display:"block"}},E))}return}if(o==="values"){for(const s of l.values){if(!s.operators||s.operators.indexOf(a.operator)>=0){u=s;break}u=null}if(!u){$("No values select for operator",a.operator);return}}const v=o==="operators",P=v?"operator":o.replace(/values/,"value"),N=v||a.operator==="exclude"?"":u.label_for_empty_value,T=v?l[o].filter(s=>!s.field_2||s.field_2.indexOf(a.field_2)>=0).map(s=>({value:s.name,label:s.label})):u.getOptionsForRule?u.getOptionsForRule(a):u.options;if(!T){$("Options not available yet");return}v&&$("Operator options",T);let _=a[P];return!u.multi_select&&!_&&!N&&T[0]&&T[0].value&&(_=a[P]=T[0].value,$("Select first option by default",P,_),O(a)),$("partSelect",P,a[P]),Tangible.Preact.createElement("div",{className:`rule-part rule-${o}`},Tangible.Preact.createElement(K,{labelForEmptyValue:N,options:T,value:_,onChange(s){const w=i.current,E=H(F({},w),{[P]:s});$("Next rule",E),O(E)},multiSelect:!v&&u.multi_select,style:v?{width:"auto"}:{}}))},"partSelect");return Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("div",{className:"rule"},Tangible.Preact.createElement("div",{className:"rule-parts"},Tangible.Preact.createElement(ie,{rule:a,setRule:O,ruleProps:n,ensureData:c}),d("field_2"),l&&(!l.field_2||a.field_2)&&d("operators"),l&&(!l.field_2||a.field_2)&&d("values")),Tangible.Preact.createElement("div",{className:"rule-actions"},Tangible.Preact.createElement("div",{className:"rule-action rule-action--remove-rule"},Tangible.Preact.createElement("div",{className:"icon",onClick:()=>{r.splice(b,1),r.length?t[f]=r:t.splice(f,1),e()}},Tangible.Preact.createElement("svg",{viewBox:"0 0 1792 1792",xmlns:"http://www.w3.org/2000/svg"},Tangible.Preact.createElement("path",{d:"M1490 1322q0 40-28 68l-136 136q-28 28-68 28t-68-28l-294-294-294 294q-28 28-68 28t-68-28l-136-136q-28-28-28-68t28-68l294-294-294-294q-28-28-28-68t28-68l136-136q28-28 68-28t68 28l294 294 294-294q28-28 68-28t68 28l136 136q28 28 28 68t-28 68l-294 294 294 294q28 28 28 68z"})))))),l&&l.description&&Tangible.Preact.createElement("p",{dangerouslySetInnerHTML:{__html:l.description}}))},"Rule");var Oe=Object.defineProperty,X=p((t,e)=>Oe(t,"name",{value:e,configurable:!0}),"e");const Te=X(()=>[{}],"createNewRuleGroup"),_e=X(({ruleGroups:t,setRuleGroups:e,ruleProps:r})=>Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("div",{className:"rule-groups"},t.map((f,a)=>Tangible.Preact.createElement("div",{key:`rule-group-${a}`,className:"rule-group"},f.map((b,n)=>Tangible.Preact.createElement(je,{key:`rule-group-${a}-rule-${n}`,ruleGroups:t,setRuleGroups:e,group:f,groupIndex:a,rule:b,ruleIndex:n,ruleProps:r}))))),Tangible.Preact.createElement("button",{type:"button",className:"button button--add-rule-group",onClick:()=>{t.push(Te()),e(t)}},"Add location")),"RuleGroups");var U=Object.defineProperty,Ee=Object.defineProperties,$e=Object.getOwnPropertyDescriptors,W=Object.getOwnPropertySymbols,he=Object.prototype.hasOwnProperty,xe=Object.prototype.propertyIsEnumerable,Y=p((t,e,r)=>e in t?U(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,"x"),we=p((t,e)=>{for(var r in e||(e={}))he.call(e,r)&&Y(t,r,e[r]);if(W)for(var r of W(e))xe.call(e,r)&&Y(t,r,e[r]);return t},"b"),Re=p((t,e)=>Ee(t,$e(e)),"D"),C=p((t,e)=>U(t,"name",{value:e,configurable:!0}),"u");const{jQuery:q}=window,Se=!1,Z=C((...t)=>Se,"log"),De=C(({data:t,ruleDefinitions:e})=>{const[r,f]=Tangible.Preact.useState(t),a=Tangible.Preact.useRef();a.current=r;const[b,n]=Tangible.Preact.useState({}),i=Tangible.Preact.useRef();i.current=b;const m=Tangible.Preact.useRef(),y=Tangible.Preact.useRef(),{rule_groups:g=[]}=r,O=C(()=>f(o=>Re(we({},o),{rule_groups:g})),"setRuleGroups"),{fieldOptions:c,ruleDefinitionByField:l}=Tangible.Preact.useMemo(()=>{const o=[],u={};return e.forEach(v=>{o.push({value:v.name,label:v.label}),u[v.name]=v}),Z("ruleDefinitionByField",u),{fieldOptions:o,ruleDefinitionByField:u}},[]),d={ruleDefinitions:e,fieldOptions:c,ruleDefinitionByField:l,ajaxStateRef:i,setAjaxState:n};return Tangible.Preact.useEffect(()=>{let o="";const u=q(m.current).find(".rule");for(let P=0,N=u.length;P<N;P++){const T=q(u[P]).find(".rule-part");let _="";for(let s=0,w=T.length;s<w;s++){const E=q(T[s]),R=E.find("select");if(!R[0]){const h=E.find("input");h&&(_+=(s>0?" ":"")+h.val());continue}if(!R[0].select2)continue;const k=R.select2("data");Array.isArray(k)&&(_+=(s>0?" ":"")+k.map(h=>h.text).join(", "))}o+=(P>0?"<br>":"")+_}Z("Description:",o);const v=a.current;v.description=o,y.current.value=JSON.stringify(v)}),Tangible.Preact.createElement("div",{ref:m},Tangible.Preact.createElement("input",{type:"hidden",name:"location",ref:y,value:JSON.stringify(r)}),Tangible.Preact.createElement(_e,{ruleGroups:g,setRuleGroups:O,ruleProps:d}))},"LocationEditor"),{jQuery:Fe,Tangible:{Preact:Ae}}=window,I=Fe("#post .template-location-editor"),Ne=I[0];let x=I.data("location");x=typeof x=="object"&&!Array.isArray(x)?x:{};const ke=I.data("ruleDefinitions")||[];Ae.render(Tangible.Preact.createElement(De,{data:x,ruleDefinitions:ke}),Ne)})();
//# sourceMappingURL=template-location-editor.min.js.map
