{"version":3,"file":"template-editor-bridge.min.js","sources":["../editor/template-editor-bridge/index.ts","../editor/template-editor-bridge/global.ts"],"sourcesContent":["/**\n * Compatibility layer to help with transition of CodeMirror 5 to 6\n */\n\ndeclare global {\n  interface Window {\n    wp: any\n    Tangible: {\n      ajax: any\n      TemplateSystem: any\n      // Legacy\n      createCodeEditor: typeof createTemplateEditor\n    }\n  }\n}\n\nexport type CodeEditorLegacyInterface = {\n  getValue: () => string\n  focus: () => void\n  refresh: () => void\n  setSize: (width: string | null, height: string | null) => void\n  on: (eventName: string, callback: Function) => void\n  off: (eventName: string, callback: Function) => void\n}\n\nexport type CodeEditorLegacyOptions = {\n  language?: string\n  onSave?: () => void\n}\n\nexport type CodeEditorInterface = CodeEditorLegacyInterface & {\n  updateTextarea: () => void\n}\n\nexport async function createTemplateEditor(\n  textarea: HTMLTextAreaElement,\n  options: CodeEditorLegacyOptions = {}\n): Promise<CodeEditorInterface> {\n  const { CodeEditor } = window.Tangible.TemplateSystem || {}\n\n  if (!CodeEditor) {\n    throw new Error('CodeEditor not found')\n  }\n\n  // console.log('createTemplateEditor', textarea, CodeEditor, options)\n\n  const { language = 'html', onSave } = options\n\n  const listeners = {}\n  \n  const editor = await CodeEditor.create({\n    // el,\n    lang: language,\n    content: textarea.value,\n    onUpdate(doc) {\n      if (listeners['change']) {\n        api.emit('change') // Caller gets value from editor\n      }\n    },\n    onSave() {\n      if (!onSave) return\n      updateTextarea()\n      onSave()\n    },\n    editorActionsPanel: options.editorActionsPanel\n  })\n  \n  const api = {\n\n    // New editor\n    \n    codeMirror6: editor,\n    updateTextarea,\n\n    // Legacy editor\n\n    getValue() {\n      if (!editor) return ''\n      return editor.view.state.doc.toString()\n    },\n    setValue(value) {\n      if (!editor) return\n      const content = editor.view.state.doc.toString()\n      // Replace content\n      editor.view.dispatch({\n        changes: {\n          from: 0,\n          to: content.length,\n          insert: value,\n        },\n      })\n    },\n    focus() {\n      editor && editor.view.focus()\n    },\n    refresh() {},\n    setSize(width: string | null, height: string | null) {},\n\n    on(eventName, callback) {\n      if (!listeners[eventName]) {\n        listeners[eventName] = []\n      }\n      listeners[eventName].push(callback)\n    },\n    emit(eventName, ...args) {\n      if (listeners[eventName]) {\n        for (const listener of listeners[eventName]) {\n          listener(...args)\n        }\n      }\n    },\n    off(eventName, callback) {\n      if (listeners[eventName]) {\n        listeners[eventName] = listeners[eventName].filter(\n          (f) => f !== callback\n        )\n      }\n    },\n  }\n  \n  // const el = document.createElement('div')\n  const containterClass = 'tangible-template-editor-container'\n\n  if (!textarea.parentNode?.classList.contains(containterClass)) {\n    // el.classList.add(containterClass)\n    textarea.parentNode?.classList.add(containterClass)\n  }\n\n  function updateTextarea() {\n    textarea.value = editor.view.state.doc.toString()\n  }\n\n  /**\n   * Support legacy method of passing textarea instead of div container\n   * @see https://codemirror.net/docs/migration/#codemirror.fromtextarea\n   */\n  textarea.parentNode?.insertBefore(editor.view.dom, textarea)\n\n  if (textarea.form) {\n    textarea.form.addEventListener('submit', () => updateTextarea())\n  }\n\n  return api\n}\n","import { createTemplateEditor } from './index'\n\nwindow.Tangible = window.Tangible || {}\nwindow.Tangible.createCodeEditor = createTemplateEditor\n"],"names":["createTemplateEditor","textarea","options","CodeEditor","language","onSave","listeners","editor","doc","api","updateTextarea","value","content","width","height","eventName","callback","args","listener","f","containterClass","__name"],"mappings":"2WAkCsB,eAAAA,EACpBC,EACAC,EAAmC,GACL,CAC9B,KAAM,CAAE,WAAAC,CAAW,EAAI,OAAO,SAAS,gBAAkB,CAAA,EAEzD,GAAI,CAACA,EACH,MAAM,IAAI,MAAM,sBAAsB,EAKxC,KAAM,CAAE,SAAAC,EAAW,OAAQ,OAAAC,CAAO,EAAIH,EAEhCI,EAAY,CAAC,EAEbC,EAAS,MAAMJ,EAAW,OAAO,CAErC,KAAMC,EACN,QAASH,EAAS,MAClB,SAASO,EAAK,CACRF,EAAU,QACZG,EAAI,KAAK,QAAQ,CAErB,EACA,QAAS,CACFJ,IACLK,IACAL,EAAO,EACT,EACA,mBAAoBH,EAAQ,kBAC9B,CAAC,EAEKO,EAAM,CAIV,YAAaF,EACb,eAAAG,EAIA,UAAW,CACT,OAAKH,EACEA,EAAO,KAAK,MAAM,IAAI,SAAS,EADlB,EAEtB,EACA,SAASI,EAAO,CACd,GAAI,CAACJ,EAAQ,OACb,MAAMK,EAAUL,EAAO,KAAK,MAAM,IAAI,SAAS,EAE/CA,EAAO,KAAK,SAAS,CACnB,QAAS,CACP,KAAM,EACN,GAAIK,EAAQ,OACZ,OAAQD,CACV,CACF,CAAC,CACH,EACA,OAAQ,CACNJ,GAAUA,EAAO,KAAK,MAAA,CACxB,EACA,SAAU,CAAA,EACV,QAAQM,EAAsBC,EAAuB,CAAC,EAEtD,GAAGC,EAAWC,EAAU,CACjBV,EAAUS,CAAS,IACtBT,EAAUS,CAAS,EAAI,CAAC,GAE1BT,EAAUS,CAAS,EAAE,KAAKC,CAAQ,CACpC,EACA,KAAKD,KAAcE,EAAM,CACvB,GAAIX,EAAUS,CAAS,EACrB,UAAWG,KAAYZ,EAAUS,CAAS,EACxCG,EAAS,GAAGD,CAAI,CAGtB,EACA,IAAIF,EAAWC,EAAU,CACnBV,EAAUS,CAAS,IACrBT,EAAUS,CAAS,EAAIT,EAAUS,CAAS,EAAE,OACzCI,GAAMA,IAAMH,CACf,EAEJ,CACF,EAGMI,EAAkB,qCAEnBnB,EAAS,YAAY,UAAU,SAASmB,CAAe,GAE1DnB,EAAS,YAAY,UAAU,IAAImB,CAAe,EAGpD,SAASV,GAAiB,CACxBT,EAAS,MAAQM,EAAO,KAAK,MAAM,IAAI,SACzC,CAAA,CAFSG,OAAAA,EAAAA,EAAAA,KAAAW,EAAAX,EAAA,gBAAA,EAQTT,EAAS,YAAY,aAAaM,EAAO,KAAK,IAAKN,CAAQ,EAEvDA,EAAS,MACXA,EAAS,KAAK,iBAAiB,SAAU,IAAMS,EAAAA,CAAgB,EAG1DD,CACT,CA7GsBY,EAAArB,EAAA,wBAAAqB,EAAArB,EAAA,sBAAA,EChCtB,OAAO,SAAW,OAAO,UAAY,CACrC,EAAA,OAAO,SAAS,iBAAmBA"}