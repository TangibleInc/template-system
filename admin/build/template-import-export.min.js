var xe=Object.defineProperty;var c=(k,R)=>xe(k,"name",{value:R,configurable:!0});(function(){"use strict";(function(){const e={NODE_ENV:"production"};try{if(process){process.env=Object.assign({},process.env),Object.assign(process.env,e);return}}catch{}globalThis.process={env:e}})();async function k(e,n=document.createElement("img")){return new Promise((t,a)=>{const l=c(()=>{URL.revokeObjectURL(n.src),n.removeEventListener("load",l),t(n)},"listener");n.addEventListener("load",l),n.src=URL.createObjectURL(e)})}c(k,"blobToImageElement");function R(e){const{context:n,width:t,height:a}=J(e);return n.getImageData(0,0,t,a).data}c(R,"getImageData");function J(e){const n=document.createElement("canvas"),t=n.getContext("2d"),a=n.width=e.naturalWidth,l=n.height=e.naturalHeight;return t?.drawImage(e,0,0),{canvas:n,context:t,width:a,height:l}}c(J,"imageElementToCanvas");function q(e,n){for(let t=0,a=e.length;t<3;t++)n[t]=a/Math.pow(256,t)%256|0;n[3]=255;for(let t=4,a=0,l=n.length;t<l;t+=4,a+=3)n[t]=e[a]||0,n[t+1]=e[a+1]||0,n[t+2]=e[a+2]||0,n[t+3]=255;return n}c(q,"encodeDataIntoImage");function V(e){let n=0;for(let a=0;a<3;a++)n+=e[a]*Math.pow(256,a);const t=new Uint8Array(n);e:for(let a=4,l=0,i=e.length;l<i;a+=4,l+=3)for(let r=0;r<3;r++){if(l+r>=n)break e;t[l+r]=e[a+r]}return t.buffer}c(V,"decodeDataFromImage");async function z(e){const n=new Uint8Array(e);return new Promise((t,a)=>{const l=document.createElement("canvas"),i=l.getContext("2d"),r=Math.ceil(Math.sqrt(n.length/3+1));l.width=r,l.height=r;const o=i?.getImageData(0,0,r,r);q(n,o.data),i?.putImageData(o,0,0),l.toBlob(u=>{u?t(u):a(new Error("Canvas failed to create blob"))},"image/png")})}c(z,"encodeBinaryToBlob");async function W(e){if(!(e instanceof ArrayBuffer))throw new Error("Expected ArrayBuffer but got "+typeof e);const n=new Blob([e]),t=await k(n);return V(R(t))}c(W,"decodeBinaryFromPng");const{CompressionStream:K,DecompressionStream:Q,Response:x}=globalThis,N="gzip";async function G(e,n=N){const t=new K(n),a=new x(e).body?.pipeThrough(t);return await new x(a).arrayBuffer()}c(G,"compress");async function X(e,n=N){const t=new Q(n),a=new x(e).body?.pipeThrough(t);return new x(a)}c(X,"decompressAsResponse");async function Y(e,n=N){return(await X(e,n)).arrayBuffer()}c(Y,"decompressAsArrayBuffer");function Z(e){return new TextEncoder().encode(JSON.stringify(e)).buffer}c(Z,"valueToArrayBuffer");function ee(e){return JSON.parse(new TextDecoder().decode(e))}c(ee,"arrayBufferToValue");async function te(e){return await z(await G(Z(e)))}c(te,"encodeToBlob");async function ne(e){return ee(await ae(e))}c(ne,"decode");async function ae(e){return await Y(await W(e))}c(ae,"decodeBinary");function re(e,n="compressed.png"){const t=URL.createObjectURL(e),a=document.createElement("a");a.download=n,a.href=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(t)}c(re,"downloadImage");const{Tangible:{ajax:S}}=window,I="tangible_template_import_export__";var le=Object.defineProperty,oe=c((e,n)=>le(e,"name",{value:n,configurable:!0}),"c");function j({mode:e,inputStateRef:n,setInputState:t}){const{importData:a}=n.current;if(!a||!a.post_types){console.warn("Import data not found",a);return}const l={...a,post_types:{},handle_duplicates:e};for(const{id:i,title:r,post_type:o}of n.current.duplicatesFound){const u=a.post_types[o].filter(m=>m.id===i)[0];if(!u){console.warn("Corresponding post not found",i,o,r);continue}l.post_types[o]||(l.post_types[o]=[]),l.post_types[o].push(u)}t({...n.current,importData:{},importedData:{},duplicatesFound:[],duplicatesHandledMessage:"",message:""}),S(I+"import",l).then(i=>{const r={...l,old_to_new_id:{...n.current.old_to_new_id||{},...i.old_to_new_id||{}}};console.log("Imported duplicates",r),t({...n.current,importing:!1,importData:{},importedData:r,duplicatesFound:[],duplicatesHandledMessage:"",message:i.post_count+" template"+(i.post_count!==1?"s":"")+" imported"})}).catch(i=>{t({...n.current,duplicatesHandledMessage:"Error: "+i.message})})}c(j,"m$1"),oe(j,"handleDuplicates");var se=Object.defineProperty,E=c((e,n)=>se(e,"name",{value:n,configurable:!0}),"l");const D=E((...e)=>console.log("[Importer]",...e),"log"),{FileReader:ce}=window,F={tangible_template:"Templates",tangible_style:"Styles",tangible_script:"Scripts",tangible_layout:"Layouts",tangible_block:"Blocks"},pe=E(({useInput:e=!0,directImportData:n})=>{const[t,a]=wp.element.useState({importing:!1,importData:{},importedData:{},message:"",duplicatesFound:[],duplicatesHandledMessage:""}),l=wp.element.useRef();l.current=t;const i=E(()=>{a({...l.current,importing:!0,importData:{},importedData:{},duplicatesFound:[],duplicatesHandledMessage:"",message:"Importing.."})},"preImport"),r=E(m=>a({...l.current,importing:!1,importData:{},importedData:{},duplicatesFound:[],duplicatesHandledMessage:"",message:"Error: "+m}),"onError"),o=E(m=>{a({...l.current,importData:m}),S(I+"import",m).then(s=>{D("Import success",s);const{importData:g}=l.current,w={post_types:Object.keys(g.post_types).reduce((y,p)=>{const d=s.duplicates_found.filter(f=>f.post_type===p).map(f=>f.id);return y[p]=g.post_types[p].filter(f=>d.indexOf(f.id)<0),y},{}),old_to_new_id:s.old_to_new_id||{}};D("Imported minus duplicates",w),a({...l.current,importing:!1,duplicatesFound:s.duplicates_found,importData:s.duplicates_found.length?g:{},importedData:w,message:s.post_count+" template"+(s.post_count!==1?"s":"")+" imported"+(s.failed_post_count?" - "+s.failed_post_count+" template"+(s.failed_post_count!==1?"s":"")+" failed":"")})}).catch(s=>{console.error(s),r(s.message)})},"importJSON");wp.element.useEffect(()=>{n&&(i(),o(n))},[]);const u=wp.element.useRef();return wp.element.createElement("div",{id:"importer"},e&&wp.element.createElement("p",null,wp.element.createElement("input",{type:"file",hidden:!0,ref:u,accept:".json,text/json,.png,image/png",onChange:({target:{files:m}})=>{const s=m[0],g=s.name.endsWith(".png"),w=new ce;i(),w.onload=function(y){const p=y.target.result;if(g){ne(p).then(d=>{o(d)}).catch(d=>{console.error(d),r(d.message)});return}try{const d=JSON.parse(p);D("Import data",d),o(d)}catch{D("Invalid JSON",p),r("Invalid JSON")}},w.onerror=function(y){r(y.message)},g?w.readAsArrayBuffer(s):w.readAsText(s)}}),wp.element.createElement("button",{type:"button",className:"button button-primary",onClick:()=>{t.importing||u.current&&u.current.click()}},"Import")),t.message&&wp.element.createElement("p",null,t.message),Object.keys(t.importedData.post_types||{}).map(m=>t.importedData.post_types[m]&&t.importedData.post_types[m].length>0&&wp.element.createElement(wp.element.Fragment,null,wp.element.createElement("div",null,wp.element.createElement("b",null,F[m]||"Templates")),wp.element.createElement("ul",null,t.importedData.post_types[m].map((s,g)=>wp.element.createElement("li",{key:`post-${g}`},t.importedData.old_to_new_id&&t.importedData.old_to_new_id[s.id]?wp.element.createElement("a",{href:`post.php?post=${t.importedData.old_to_new_id[s.id]}&action=edit`},s.title):s.title))))),t.duplicatesFound.length>0&&wp.element.createElement(wp.element.Fragment,null,wp.element.createElement("p",{style:{fontWeight:"bold",color:"red"}},t.duplicatesFound.length," duplicate template",t.duplicatesFound!==1?"s":""," found"),Object.keys(F).map(m=>{const s=t.duplicatesFound.filter(g=>g.post_type===m);if(s.length)return wp.element.createElement(wp.element.Fragment,null,wp.element.createElement("div",null,wp.element.createElement("b",null,F[m]||"Templates")),wp.element.createElement("ul",null,s.map((g,w)=>wp.element.createElement("li",{key:`duplicate-post-${w}`},g.title))))}),wp.element.createElement("button",{type:"button",className:"button button-primary",onClick:()=>{j({mode:"overwrite",inputStateRef:l,setInputState:a})}},"Overwrite"),"\xA0",wp.element.createElement("button",{type:"button",className:"button button-primary",onClick:()=>{j({mode:"keep_both",inputStateRef:l,setInputState:a})}},"Keep both"),"\xA0",wp.element.createElement("button",{type:"button",className:"button button-primary",onClick:()=>{a({...l.current,importing:!1,importData:{},importedData:{},duplicatesFound:[],duplicatesHandledMessage:"",message:""})}},"Skip"),t.duplicatesHandledMessage&&wp.element.createElement("p",null,t.duplicatesHandledMessage)))},"Importer");var ie=Object.defineProperty,ue=c((e,n)=>ie(e,"name",{value:n,configurable:!0}),"a$1");const{jQuery:me}=window,C=ue(({labelForEmptyValue:e="",options:n=[],value:t="",onChange:a,multiSelect:l,style:i})=>{const r=wp.element.useRef();if(wp.element.useEffect(()=>{const o=me(r.current);r.current.$el=o,a(t),o.tangibleSelect({minimumResultsForSearch:5}),l&&(o.val(t),o.trigger("change")),o.on("change",function(m){if(!l){a(m.target.value);return}if(!r.current)return;const s=o.select2("data").map(g=>g.id);a(s)});const u=r.current.select2=o.data("select2");return()=>{u&&u.destroy()}},[]),r.current&&r.current.$el)if(l){const o=r.current.$el.val();t.length!==o.length&&n.length&&setTimeout(function(){r.current.$el.val(t),r.current.$el.trigger("change")},0)}else r.current.value!==t&&(r.current.$el.val(t),r.current.$el.trigger("change"));return wp.element.createElement("select",{ref:r,defaultValue:t,autoComplete:"off",multiple:l,style:{display:"none",width:"160px",...i}},e&&wp.element.createElement("option",{value:"",disabled:!0},e),n.map((o,u)=>wp.element.createElement("option",{key:`option-${u}`,value:o.value},o.label)))},"Select");var de=Object.defineProperty,ge=c((e,n)=>de(e,"name",{value:n,configurable:!0}),"v");const{templateSystemHasPlugin:h={}}=window.Tangible;console.log("hasPlugin",h);const fe=ge(({rule:e,ruleIndex:n,exportRulesRef:t,setExportRules:a,templateTypeItemOptionsRef:l,ensureTemplateTypeItemOptions:i})=>wp.element.createElement("div",{className:"export-rule"},wp.element.createElement("div",{className:"export-rule-part"},wp.element.createElement(C,{labelForEmptyValue:"Select template type",options:[...h.blocks&&h.blocks_editor?[{label:"Block",value:"tangible_block"}]:[],...h.loops||h.template_system?[{label:"Template",value:"tangible_template"},{label:"Style",value:"tangible_style"},{label:"Script",value:"tangible_script"},{label:"Layout",value:"tangible_layout"}]:[]],value:e.field,onChange(r){e.field=r,t.current[n]=e,a(t.current)}})),e.field&&wp.element.createElement("div",{className:"export-rule-part"},wp.element.createElement(C,{options:[{label:"All",value:"all"},{label:"Include",value:"include"},{label:"Exclude",value:"exclude"}],value:e.operator,onChange(r){e.operator=r,r==="all"&&(e.values=[]),t.current[n]=e,a(t.current),r!=="all"&&i(e.field)},style:{width:"auto"}})),e.field&&e.operator!=="all"&&l.current[e.field]&&wp.element.createElement("div",{className:"export-rule-part"},wp.element.createElement(C,{options:l.current[e.field]instanceof Promise?[]:l.current[e.field],value:e.values,onChange(r){e.values=r,t.current[n]=e,a(t.current)},multiSelect:!0})),wp.element.createElement("div",{className:"export-rule-part export-rule-part--remove-rule"},wp.element.createElement("div",{className:"icon",onClick:()=>{t.current.splice(n,1),a(t.current)}},wp.element.createElement("svg",{viewBox:"0 0 1792 1792",xmlns:"http://www.w3.org/2000/svg"},wp.element.createElement("path",{d:"M1490 1322q0 40-28 68l-136 136q-28 28-68 28t-68-28l-294-294-294 294q-28 28-68 28t-68-28l-136-136q-28-28-28-68t28-68l294-294-294-294q-28-28-28-68t28-68l136-136q28-28 68-28t68 28l294 294 294-294q28-28 68-28t68 28l136 136q28 28 28 68t-28 68l-294 294 294 294q28 28 28 68z"}))))),"ExportRule");var we=Object.defineProperty,B=c((e,n)=>we(e,"name",{value:n,configurable:!0}),"e$1");function L(e){window.localStorage&&window.localStorage.setItem("exporterState",JSON.stringify(e))}c(L,"saveStateToLocalStorage"),B(L,"saveStateToLocalStorage");function A(){if(!window.localStorage)return;let e=window.localStorage.getItem("exporterState");if(e)try{return e=JSON.parse(e),e}catch{}}c(A,"getSavedStateFromLocalStorage"),B(A,"getSavedStateFromLocalStorage");var ye=Object.defineProperty,b=c((e,n)=>ye(e,"name",{value:n,configurable:!0}),"a");const be=!1,O=b((...e)=>be,"log"),T=A(),M=T&&T.name||"tangible-templates",Ee=T&&T.rules||[{field:"tangible_template",operator:"all",values:[]}],he=b(()=>{const e=wp.element.useRef(),[n,t]=wp.element.useState(Ee),a=wp.element.useRef();a.current=n;const l=b(p=>{t([...p])},"setExportRules"),[i,r]=wp.element.useState({}),o=wp.element.useRef();o.current=i;const[u,m]=wp.element.useState({exporting:!1,message:"",json:"",packageName:""}),s=wp.element.useRef();s.current=u;const g=b(p=>{m({...s.current,...p})},"setExportState"),w=b(async p=>{if(o.current[p])return;O("ensureTemplateTypeItemOptions",p,o.current);const d=S(I+"get_template_type_item_options",{post_type:p}).then(f=>{O("ensureTemplateTypeItemOptions Success",f),r({...o.current,[p]:f})}).catch(f=>{O("ensureTemplateTypeItemOptions Fail",f)});r({...o.current,[p]:d})},"ensureTemplateTypeItemOptions"),y=wp.element.useCallback((p="json")=>{const d=e.current&&e.current.value||M;L({name:d,rules:a.current}),O("Export start",a.current),g({exporting:!0,message:"Exporting.."});function f(v){console.error(v),g({exporting:!1,message:"Error: "+v.message})}c(f,"n"),b(f,"handleError"),S(I+"export",{export_rules:a.current}).then(v=>{console.log("Export success",v),g({exporting:!1,message:"Export success"});const H={package_name:d,...v},U=new Date().toISOString().slice(0,10).replace(/-/g,"");if(p==="png"){te(H).then(_e=>{re(_e,`${d}-${U}.png`)}).catch(f);return}const _=document.createElement("a");_.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(H,null,2)),_.download=`${d}-${U}.json`,_.style.display="none",document.body.appendChild(_),_.click()}).catch(f)});return wp.element.createElement("div",{id:"exporter"},wp.element.createElement("div",{className:"export-name"},"Package name:"," ",wp.element.createElement("input",{type:"text",name:"name",defaultValue:M,ref:e})),wp.element.createElement("div",{className:"export-rules"},n.map((p,d)=>wp.element.createElement(fe,{key:`export-rule-${d}`,rule:p,ruleIndex:d,exportRulesRef:a,setExportRules:l,templateTypeItemOptionsRef:o,ensureTemplateTypeItemOptions:w}))),wp.element.createElement("p",null,wp.element.createElement("button",{type:"button",className:"button button-secondary",onClick:()=>{a.current.push({field:"tangible_template",operator:"all",values:[]}),l(a.current)}},"Add export rule")),a.current.length>0&&wp.element.createElement("p",null,wp.element.createElement("button",{type:"button",className:"button button-primary",onClick:p=>{p.preventDefault(),!u.exporting&&y("png")}},"Export"),wp.element.createElement("a",{href:"#",style:{margin:"0 1rem"},onClick:p=>{p.preventDefault(),!u.exporting&&y()}},"Export as JSON (Uncompressed)"),u.message&&wp.element.createElement("div",{style:{padding:".5rem 0"}},u.message)))},"Exporter"),{Tangible:{templateSystemHasPlugin:$={}}}=window,P=document.getElementById("tangible_template_import_export_form");P.addEventListener("submit",function(e){e.preventDefault()});const ve=$.loops||$.blocks_editor||$.template_system;wp.element.createRoot(P).render(wp.element.createElement(wp.element.Fragment,null,wp.element.createElement("h1",{className:"wp-heading-inline"},"Import"),wp.element.createElement(pe,null),ve&&wp.element.createElement(wp.element.Fragment,null,wp.element.createElement("hr",null),wp.element.createElement("h1",{className:"wp-heading-inline"},"Export"),wp.element.createElement(he,null))))})();
//# sourceMappingURL=template-import-export.min.js.map
