var se=Object.defineProperty;var h=(P,G)=>se(P,"name",{value:G,configurable:!0});(function(){"use strict";(function(){const e={NODE_ENV:"production"};try{if(process){process.env=Object.assign({},process.env),Object.assign(process.env,e);return}}catch{}globalThis.process={env:e}})();var P=Object.defineProperty,G=h((e,n)=>P(e,"name",{value:n,configurable:!0}),"a$2");const{jQuery:V}=window,I=G(({labelForEmptyValue:e="",options:n=[],value:a="",onChange:p,multiSelect:t,style:m})=>{const r=wp.element.useRef();if(wp.element.useEffect(()=>{const i=V(r.current);r.current.$el=i,p(a),i.tangibleSelect({minimumResultsForSearch:5}),t&&(i.val(a),i.trigger("change")),i.on("change",function(w){if(!t){p(w.target.value);return}if(!r.current)return;const f=i.select2("data").map(_=>_.id);p(f)});const g=r.current.select2=i.data("select2");return()=>{g&&g.destroy()}},[]),r.current&&r.current.$el)if(t){const i=r.current.$el.val();a.length!==i.length&&n.length&&setTimeout(function(){r.current.$el.val(a),r.current.$el.trigger("change")},0)}else r.current.value!==a&&(r.current.$el.val(a),r.current.$el.trigger("change"));return wp.element.createElement("select",{ref:r,defaultValue:a,autoComplete:"off",multiple:t,style:{display:"none",width:"160px",...m}},e&&wp.element.createElement("option",{value:"",disabled:!0},e),n.map((i,g)=>wp.element.createElement("option",{key:`option-${g}`,value:i.value},i.label)))},"Select");var K=Object.defineProperty,J=h((e,n)=>K(e,"name",{value:n,configurable:!0}),"t$1");const L=J(({rule:e,setRule:n,ruleProps:a,ensureData:p})=>{const{fieldOptions:t}=a;return wp.element.createElement("div",{className:"rule-part rule-field"},wp.element.createElement(I,{labelForEmptyValue:"Select location..",options:t,value:e.field,onChange(m){n({field:m})}}))},"Field");var Q=Object.defineProperty,k=h((e,n)=>Q(e,"name",{value:n,configurable:!0}),"f");const z=!1,b=k((...e)=>z,"log"),{ajax:H}=window.Tangible,X="tangible_template_location__",U=k(({rule:e,ruleDefinitionByField:n,ajaxStateRef:a,setAjaxState:p})=>{if(!e.field)return;const t=n[e.field];if(t)for(const m of["field_2","values"]){if(!t[m])continue;let r=t[m][0];if(!r||r.type!=="select_ajax")continue;if(m==="values"){for(const u of t.values){if(!u.operators||u.operators.indexOf(e.operator)>=0){r=u;break}r=null}if(!r){b("No values select for operator",e.operator);return}}const i=a.current,g=r.ajax_action,w={};if(r.rule_properties_to_ajax){const u=r.rule_properties_to_ajax;for(const l in u){if(!e[l]){b("Missing request key",l);return}w[u[l]]=e[l]}}if(r.ajax_properties){const u=r.ajax_properties;for(const l in u)w[l]=u[l];b("Mapped AJAX properties to values",w)}r.getAjaxActionCacheKey||(r.getAjaxActionCacheKey=function(u){let l=g;if(r.rule_properties_to_ajax){const d=r.rule_properties_to_ajax;for(const o in d)l+="__"+d[o]+"__"+u[o]}return l},r.getOptionsForRule=function(u){const l=r.getAjaxActionCacheKey(u),d=a.current;if(d[l]&&!(d[l]instanceof Promise))return b("Got options for key",l,d[l]),d[l];b("Options not ready for key",l,d)});const f=r.getAjaxActionCacheKey(e),_=k(u=>{b("updatePartDefinition",a.current),p({...a.current})},"updatePartDefinition");if(!i[f]){const u=X+g;b("Getting data..",u,w),i[f]=H(u,w).then(l=>(a.current[f]=l,b("Got data",f,a.current[f]),_(l),l)).catch(l=>{b("Failed to get data",f,l)});return}if(i[f]instanceof Promise){b("Fetch in progress",f);return}}},"ensureDataForRule");var W=Object.defineProperty,D=h((e,n)=>W(e,"name",{value:n,configurable:!0}),"u");const Y=!1,j=D((...e)=>Y,"log"),Z=D(({ruleGroups:e,setRuleGroups:n,group:a,groupIndex:p,rule:t,ruleIndex:m,ruleProps:r})=>{j("--- Rule ---",t);const i=wp.element.useRef();i.current=t;const{ruleDefinitionByField:g,ajaxStateRef:w,setAjaxState:f}=r,_=D((o={})=>{a[m]={...t,...o},e[p]=a,n()},"setRule"),u=wp.element.useCallback(()=>{U({rule:t,ruleDefinitionByField:g,ajaxStateRef:w,setAjaxState:f})},[t]);u();const l=t.field&&g[t.field],d=D(o=>{if(!l||!l[o])return;let s=l[o][0];if(!(o==="operators"||s&&(s.type==="select"||s.type==="select_ajax"))){const{type:c,placeholder:R,description:S}=s||{};if(c==="input"){let A=t[o];return wp.element.createElement("div",{className:`rule-part rule-${o}`},wp.element.createElement("input",{type:"text",placeholder:R,value:A,onChange:N=>{const O=i.current;_({...O,[o]:N.target.value})}}),S&&wp.element.createElement("small",{style:{display:"block"}},S))}return}if(o==="values"){for(const c of l.values){if(!c.operators||c.operators.indexOf(t.operator)>=0){s=c;break}s=null}if(!s){j("No values select for operator",t.operator);return}}const v=o==="operators",y=v?"operator":o.replace(/values/,"value"),F=v||t.operator==="exclude"?"":s.label_for_empty_value,x=v?l[o].filter(c=>!c.field_2||c.field_2.indexOf(t.field_2)>=0).map(c=>({value:c.name,label:c.label})):s.getOptionsForRule?s.getOptionsForRule(t):s.options;if(!x){j("Options not available yet");return}v&&j("Operator options",x);let E=t[y];return!s.multi_select&&!E&&!F&&x[0]&&x[0].value&&(E=t[y]=x[0].value,j("Select first option by default",y,E),_(t)),j("partSelect",y,t[y]),wp.element.createElement("div",{className:`rule-part rule-${o}`},wp.element.createElement(I,{labelForEmptyValue:F,options:x,value:E,onChange(c){const R={...i.current,[y]:c};j("Next rule",R),_(R)},multiSelect:!v&&s.multi_select,style:v?{width:"auto"}:{}}))},"partSelect");return wp.element.createElement(wp.element.Fragment,null,wp.element.createElement("div",{className:"rule"},wp.element.createElement("div",{className:"rule-parts"},wp.element.createElement(L,{rule:t,setRule:_,ruleProps:r,ensureData:u}),d("field_2"),l&&(!l.field_2||t.field_2)&&d("operators"),l&&(!l.field_2||t.field_2)&&d("values")),wp.element.createElement("div",{className:"rule-actions"},wp.element.createElement("div",{className:"rule-action rule-action--remove-rule"},wp.element.createElement("div",{className:"icon",onClick:()=>{a.splice(m,1),a.length?e[p]=a:e.splice(p,1),n()}},wp.element.createElement("svg",{viewBox:"0 0 1792 1792",xmlns:"http://www.w3.org/2000/svg"},wp.element.createElement("path",{d:"M1490 1322q0 40-28 68l-136 136q-28 28-68 28t-68-28l-294-294-294 294q-28 28-68 28t-68-28l-136-136q-28-28-28-68t28-68l294-294-294-294q-28-28-28-68t28-68l136-136q28-28 68-28t68 28l294 294 294-294q28-28 68-28t68 28l136 136q28 28 28 68t-28 68l-294 294 294 294q28 28 28 68z"})))))),l&&l.description&&wp.element.createElement("p",{dangerouslySetInnerHTML:{__html:l.description}}))},"Rule");var ee=Object.defineProperty,M=h((e,n)=>ee(e,"name",{value:n,configurable:!0}),"e");const te=M(()=>[{}],"createNewRuleGroup"),re=M(({ruleGroups:e,setRuleGroups:n,ruleProps:a})=>wp.element.createElement(wp.element.Fragment,null,wp.element.createElement("div",{className:"rule-groups"},e.map((p,t)=>wp.element.createElement("div",{key:`rule-group-${t}`,className:"rule-group"},p.map((m,r)=>wp.element.createElement(Z,{key:`rule-group-${t}-rule-${r}`,ruleGroups:e,setRuleGroups:n,group:p,groupIndex:t,rule:m,ruleIndex:r,ruleProps:a}))))),wp.element.createElement("button",{type:"button",className:"button button--add-rule-group",onClick:()=>{e.push(te()),n(e)}},"Add location")),"RuleGroups");var le=Object.defineProperty,C=h((e,n)=>le(e,"name",{value:n,configurable:!0}),"l");const{jQuery:q}=window,ne=!1,T=C((...e)=>ne,"log"),ae=C(({data:e,ruleDefinitions:n})=>{const[a,p]=wp.element.useState(e),t=wp.element.useRef();t.current=a;const[m,r]=wp.element.useState({}),i=wp.element.useRef();i.current=m;const g=wp.element.useRef(),w=wp.element.useRef(),{rule_groups:f=[]}=a,_=C(()=>p(o=>({...o,rule_groups:f})),"setRuleGroups"),{fieldOptions:u,ruleDefinitionByField:l}=wp.element.useMemo(()=>{const o=[],s={};return n.forEach(v=>{o.push({value:v.name,label:v.label}),s[v.name]=v}),T("ruleDefinitionByField",s),{fieldOptions:o,ruleDefinitionByField:s}},[]),d={ruleDefinitions:n,fieldOptions:u,ruleDefinitionByField:l,ajaxStateRef:i,setAjaxState:r};return wp.element.useEffect(()=>{let o="";const s=q(g.current).find(".rule");for(let y=0,F=s.length;y<F;y++){const x=q(s[y]).find(".rule-part");let E="";for(let c=0,R=x.length;c<R;c++){const S=q(x[c]),A=S.find("select");if(!A[0]){const O=S.find("input");O&&(E+=(c>0?" ":"")+O.val());continue}if(!A[0].select2)continue;const N=A.select2("data");Array.isArray(N)&&(E+=(c>0?" ":"")+N.map(O=>O.text).join(", "))}o+=(y>0?"<br>":"")+E}T("Description:",o);const v=t.current;v.description=o,w.current.value=JSON.stringify(v)}),wp.element.createElement("div",{ref:g},wp.element.createElement("input",{type:"hidden",name:"location",ref:w,value:JSON.stringify(a)}),wp.element.createElement(re,{ruleGroups:f,setRuleGroups:_,ruleProps:d}))},"LocationEditor"),{jQuery:oe,Tangible:ce}=window,B=oe("#post .template-location-editor"),ie=B[0];let $=B.data("location");$=typeof $=="object"&&!Array.isArray($)?$:{};const ue=B.data("ruleDefinitions")||[];wp.element.createRoot(ie).render(wp.element.createElement(ae,{data:$,ruleDefinitions:ue}))})();
