{"version":3,"file":"template-assets-editor.min.js","sources":["../template-assets/template-assets-editor/AssetsEditor.tsx","../template-assets/template-assets-editor/index.tsx"],"sourcesContent":["import { useEffect, useRef, useState } from 'react'\n\nconst { wp } = window\n\nlet mediaModal\nlet mediaModalCallback\nconst openMediaModal = () => {\n  // Open media library\n\n  if (mediaModal) {\n    mediaModal.open()\n    return\n  }\n\n  mediaModal = wp.media({\n    title: 'Select media attachment',\n    button: {\n      text: 'Select',\n    },\n    multiple: true,\n  })\n\n  mediaModal.on('select', mediaModalCallback)\n  mediaModal.open()\n}\n\n/**\n * Ensure valid asset name, so it can be used as variable name:\n * alphanumeric, dash, and underscore.\n *\n * This is only applied for newly added asset, because if we apply it\n * while the user is editing the input field, the cursor jumps unexpectedly.\n *\n * Same logic on server side: /includes/template/fields.php, get_template_fields()\n */\nfunction withValidName(asset) {\n  if (asset.name) {\n    asset.name = asset.name.replace(/[^\\w_\\-]/g, '')\n  }\n  return asset\n}\n\nconst AssetsEditor = ({ assets }) => {\n  const [assetsState, _setAssets] = useState(assets)\n\n  // Fresh state reference for callbacks\n  const assetsRef = useRef()\n  assetsRef.current = assetsState\n\n  /**\n   * Update assets JSON in input field on every change\n   */\n  const assetsElementRef = useRef()\n  const updateAssetsElement = () => {\n    assetsElementRef.current.value = JSON.stringify(assetsRef.current)\n  }\n\n  useEffect(() => {\n    updateAssetsElement()\n  }, [assetsElementRef.current])\n\n  // Create new assets state on change\n  const refreshAssets = () => {\n    _setAssets([...assetsRef.current])\n    updateAssetsElement()\n  }\n  const addAsset = (newAsset) => {\n    assetsRef.current.push(withValidName(newAsset))\n    refreshAssets()\n  }\n  const updateAsset = (index, newAsset) => {\n    assetsRef.current[index] = {\n      ...(assetsRef.current[index] || {}),\n      ...newAsset,\n    }\n    refreshAssets()\n  }\n  const removeAsset = (assetIndex) => {\n    assetsRef.current.splice(assetIndex, 1)\n    refreshAssets()\n  }\n\n  if (!mediaModalCallback) {\n    mediaModalCallback = () => {\n      const attachments = mediaModal.state().get('selection').toJSON()\n      // Previously accepted only one attachment\n      // const attachment = mediaModal.state().get('selection').first().toJSON()\n\n      // console.log('Got attachments', attachments)\n\n      for (const attachment of attachments) {\n        // Ensure the same attachment is added only once\n        let skip = false\n        for (const asset of assetsRef.current) {\n          if (asset.id === attachment.id) {\n            skip = true\n            break\n          }\n        }\n        if (skip) continue\n\n        /**\n         * Extract attachment fields\n         *\n         * When adding a new field, update the documentation:\n         *\n         * - Internal: /includes/templates/assets/field.php\n         * - External: https://loop.tangible.one/tags/asset\n         */\n        const newAsset = [\n          'id',\n          'name',\n          'title',\n          'filename',\n          'mime',\n          'alt',\n          'caption',\n          'description',\n        ].reduce((obj, key) => {\n          obj[key] = attachment[key]\n          return obj\n        }, {})\n\n        addAsset(newAsset)\n      }\n    }\n  }\n\n  // Map of asset names to check for duplicates\n  const assetNameMap = {} // name => true\n\n  return (\n    <>\n      <input type=\"hidden\" name=\"assets\" ref={assetsElementRef} />\n\n      <div className=\"template-assets\">\n        {assetsState.map((asset, assetIndex) => {\n          const isDuplicate = assetNameMap[asset.name] ? true : false\n\n          if (!isDuplicate) {\n            assetNameMap[asset.name] = true\n          }\n\n          return (\n            <div key={`asset-${assetIndex}`} className=\"template-asset\">\n              <div className=\"template-asset-fields\">\n                <div className=\"template-asset-field template-asset-field--name\">\n                  <label>Name</label>\n\n                  <input\n                    type=\"text\"\n                    value={asset.name}\n                    onChange={(e) => {\n                      updateAsset(assetIndex, { name: e.target.value })\n                    }}\n                  />\n                </div>\n\n                <div className=\"template-asset-field template-asset-field--attachment\">\n                  <div>\n                    {isDuplicate && (\n                      <div className=\"template-asset--duplicate-name-message\">\n                        Duplicate name exists\n                      </div>\n                    )}\n                    ID:{' '}\n                    <a\n                      href={`post.php?post=${asset.id}&action=edit`}\n                      target=\"_blank\"\n                    >\n                      {asset.id}\n                    </a>\n                    <br />\n                    Title: {asset.title}\n                    <br />\n                    File name: <code>{asset.filename}</code>\n                    <br />\n                    {/* MIME type: <code>{ asset.mime }</code> */}\n                  </div>\n                </div>\n              </div>\n              <div className=\"template-asset-actions\">\n                <div className=\"template-asset-action template-asset-action--remove-asset\">\n                  <div className=\"icon\" onClick={() => removeAsset(assetIndex)}>\n                    <svg\n                      viewBox=\"0 0 1792 1792\"\n                      xmlns=\"http://www.w3.org/2000/svg\"\n                    >\n                      <path d=\"M1490 1322q0 40-28 68l-136 136q-28 28-68 28t-68-28l-294-294-294 294q-28 28-68 28t-68-28l-136-136q-28-28-28-68t28-68l294-294-294-294q-28-28-28-68t28-68l136-136q28-28 68-28t68 28l294 294 294-294q28-28 68-28t68 28l136 136q28 28 28 68t-28 68l-294 294 294 294q28 28 28 68z\" />\n                    </svg>\n                  </div>\n                </div>\n              </div>\n            </div>\n          )\n        })}\n      </div>\n\n      <button\n        type=\"button\"\n        className=\"button button--add-rule-group\"\n        onClick={() => openMediaModal()}\n      >\n        Add asset\n      </button>\n    </>\n  )\n}\n\nexport default AssetsEditor\n","/**\n * Template assets\n *\n * @see /includes/template/assets\n */\nimport React from 'react'\nimport { createRoot } from 'react-dom'\nimport AssetsEditor from './AssetsEditor'\n\nconst { jQuery: $ } = window\n\nconst el = document.getElementById('tangible_template_assets_editor')\n\nlet assets = $(el).data('assets')\nif (!Array.isArray(assets)) assets = []\n\ncreateRoot(el).render(<AssetsEditor assets={assets} />)\n"],"names":["wp"],"mappings":"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"}