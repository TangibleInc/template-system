{"version":3,"file":"template-assets-editor.min.js","sources":["../template-assets/template-assets-editor/AssetsEditor.tsx","../template-assets/template-assets-editor/index.tsx"],"sourcesContent":["import { useEffect, useRef, useState } from 'react'\n\nconst { wp } = window\n\nlet mediaModal\nlet mediaModalCallback\nconst openMediaModal = () => {\n  // Open media library\n\n  if (mediaModal) {\n    mediaModal.open()\n    return\n  }\n\n  mediaModal = wp.media({\n    title: 'Select media attachment',\n    button: {\n      text: 'Select',\n    },\n    multiple: true,\n  })\n\n  mediaModal.on('select', mediaModalCallback)\n  mediaModal.open()\n}\n\n/**\n * Ensure valid asset name, so it can be used as variable name:\n * alphanumeric, dash, and underscore.\n *\n * This is only applied for newly added asset, because if we apply it\n * while the user is editing the input field, the cursor jumps unexpectedly.\n *\n * Same logic on server side: /includes/template/fields.php, get_template_fields()\n */\nfunction withValidName(asset) {\n  if (asset.name) {\n    asset.name = asset.name.replace(/[^\\w_\\-]/g, '')\n  }\n  return asset\n}\n\nconst AssetsEditor = ({ assets }) => {\n  const [assetsState, _setAssets] = useState(assets)\n\n  // Fresh state reference for callbacks\n  const assetsRef = useRef()\n  assetsRef.current = assetsState\n\n  /**\n   * Update assets JSON in input field on every change\n   */\n  const assetsElementRef = useRef()\n  const updateAssetsElement = () => {\n    assetsElementRef.current.value = JSON.stringify(assetsRef.current)\n  }\n\n  useEffect(() => {\n    updateAssetsElement()\n  }, [assetsElementRef.current])\n\n  // Create new assets state on change\n  const refreshAssets = () => {\n    _setAssets([...assetsRef.current])\n    updateAssetsElement()\n  }\n  const addAsset = (newAsset) => {\n    assetsRef.current.push(withValidName(newAsset))\n    refreshAssets()\n  }\n  const updateAsset = (index, newAsset) => {\n    assetsRef.current[index] = {\n      ...(assetsRef.current[index] || {}),\n      ...newAsset,\n    }\n    refreshAssets()\n  }\n  const removeAsset = (assetIndex) => {\n    assetsRef.current.splice(assetIndex, 1)\n    refreshAssets()\n  }\n\n  if (!mediaModalCallback) {\n    mediaModalCallback = () => {\n      const attachments = mediaModal.state().get('selection').toJSON()\n      // Previously accepted only one attachment\n      // const attachment = mediaModal.state().get('selection').first().toJSON()\n\n      // console.log('Got attachments', attachments)\n\n      for (const attachment of attachments) {\n        // Ensure the same attachment is added only once\n        let skip = false\n        for (const asset of assetsRef.current) {\n          if (asset.id === attachment.id) {\n            skip = true\n            break\n          }\n        }\n        if (skip) continue\n\n        /**\n         * Extract attachment fields\n         *\n         * When adding a new field, update the documentation:\n         *\n         * - Internal: /includes/templates/assets/field.php\n         * - External: https://loop.tangible.one/tags/asset\n         */\n        const newAsset = [\n          'id',\n          'name',\n          'title',\n          'filename',\n          'mime',\n          'alt',\n          'caption',\n          'description',\n        ].reduce((obj, key) => {\n          obj[key] = attachment[key]\n          return obj\n        }, {})\n\n        addAsset(newAsset)\n      }\n    }\n  }\n\n  // Map of asset names to check for duplicates\n  const assetNameMap = {} // name => true\n\n  return (\n    <>\n      <input type=\"hidden\" name=\"assets\" ref={assetsElementRef} />\n\n      <div className=\"template-assets\">\n        {assetsState.map((asset, assetIndex) => {\n          const isDuplicate = assetNameMap[asset.name] ? true : false\n\n          if (!isDuplicate) {\n            assetNameMap[asset.name] = true\n          }\n\n          return (\n            <div key={`asset-${assetIndex}`} className=\"template-asset\">\n              <div className=\"template-asset-fields\">\n                <div className=\"template-asset-field template-asset-field--name\">\n                  <label>Name</label>\n\n                  <input\n                    type=\"text\"\n                    value={asset.name}\n                    onChange={(e) => {\n                      updateAsset(assetIndex, { name: e.target.value })\n                    }}\n                  />\n                </div>\n\n                <div className=\"template-asset-field template-asset-field--attachment\">\n                  <div>\n                    {isDuplicate && (\n                      <div className=\"template-asset--duplicate-name-message\">\n                        Duplicate name exists\n                      </div>\n                    )}\n                    ID:{' '}\n                    <a\n                      href={`post.php?post=${asset.id}&action=edit`}\n                      target=\"_blank\"\n                    >\n                      {asset.id}\n                    </a>\n                    <br />\n                    Title: {asset.title}\n                    <br />\n                    File name: <code>{asset.filename}</code>\n                    <br />\n                    {/* MIME type: <code>{ asset.mime }</code> */}\n                  </div>\n                </div>\n              </div>\n              <div className=\"template-asset-actions\">\n                <div className=\"template-asset-action template-asset-action--remove-asset\">\n                  <div className=\"icon\" onClick={() => removeAsset(assetIndex)}>\n                    <svg\n                      viewBox=\"0 0 1792 1792\"\n                      xmlns=\"http://www.w3.org/2000/svg\"\n                    >\n                      <path d=\"M1490 1322q0 40-28 68l-136 136q-28 28-68 28t-68-28l-294-294-294 294q-28 28-68 28t-68-28l-136-136q-28-28-28-68t28-68l294-294-294-294q-28-28-28-68t28-68l136-136q28-28 68-28t68 28l294 294 294-294q28-28 68-28t68 28l136 136q28 28 28 68t-28 68l-294 294 294 294q28 28 28 68z\" />\n                    </svg>\n                  </div>\n                </div>\n              </div>\n            </div>\n          )\n        })}\n      </div>\n\n      <button\n        type=\"button\"\n        className=\"button button--add-rule-group\"\n        onClick={() => openMediaModal()}\n      >\n        Add asset\n      </button>\n    </>\n  )\n}\n\nexport default AssetsEditor\n","/**\n * Template assets\n *\n * @see /includes/template/assets\n */\nimport React from 'react'\nimport { createRoot } from 'react-dom'\nimport AssetsEditor from './AssetsEditor'\n\nconst { jQuery: $ } = window\n\nconst el = document.getElementById('tangible_template_assets_editor')\n\nlet assets = $(el).data('assets')\nif (!Array.isArray(assets)) assets = []\n\ncreateRoot(el).render(<AssetsEditor assets={assets} />)\n"],"names":["useState","assets","useRef","useEffect","createRoot","el"],"mappings":"2WAEA,sUAyCoCA,GAASC,QAAAA,SAAAA,CAAAA,EAAAA,EAGzBC,oBAMOA,EAAAA,QAAAA,EAAAA,MAAAA,EAAAA,GAAAA,QAAAA,oFAKzBC,2kFCzCFC,GAAWC,QAAAA,WAAAA,CAAAA,EAAAA,OAAAA,GAAAA,QAAAA,cAAAA,EAAAA,CAAAA,OAAAA,CAAAA,CAAAA,CAAAA"}