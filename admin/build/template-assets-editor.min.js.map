{"version":3,"file":"template-assets-editor.min.js","sources":["../template-assets/template-assets-editor/AssetsEditor.tsx","../template-assets/template-assets-editor/index.tsx"],"sourcesContent":["import { useEffect, useRef, useState } from 'react'\n\nconst { wp } = window\n\nlet mediaModal\nlet mediaModalCallback\nconst openMediaModal = () => {\n  // Open media library\n\n  if (mediaModal) {\n    mediaModal.open()\n    return\n  }\n\n  mediaModal = wp.media({\n    title: 'Select media attachment',\n    button: {\n      text: 'Select',\n    },\n    multiple: true,\n  })\n\n  mediaModal.on('select', mediaModalCallback)\n  mediaModal.open()\n}\n\n/**\n * Ensure valid asset name, so it can be used as variable name:\n * alphanumeric, dash, and underscore.\n *\n * This is only applied for newly added asset, because if we apply it\n * while the user is editing the input field, the cursor jumps unexpectedly.\n *\n * Same logic on server side: /admin/template-post/fields.php, get_template_fields()\n */\nfunction withValidName(asset) {\n  if (asset.name) {\n    asset.name = asset.name.replace(/[^\\w_\\-]/g, '')\n  }\n  return asset\n}\n\nconst AssetsEditor = ({ assets }) => {\n  const [assetsState, _setAssets] = useState(assets)\n\n  // Fresh state reference for callbacks\n  const assetsRef = useRef()\n  assetsRef.current = assetsState\n\n  /**\n   * Update assets JSON in input field on every change\n   */\n  const assetsElementRef = useRef()\n  const updateAssetsElement = () => {\n    assetsElementRef.current.value = JSON.stringify(assetsRef.current)\n  }\n\n  useEffect(() => {\n    updateAssetsElement()\n  }, [assetsElementRef.current])\n\n  // Create new assets state on change\n  const refreshAssets = () => {\n    _setAssets([...assetsRef.current])\n    updateAssetsElement()\n  }\n  const addAsset = (newAsset) => {\n    assetsRef.current.push(withValidName(newAsset))\n    refreshAssets()\n  }\n  const updateAsset = (index, newAsset) => {\n    assetsRef.current[index] = {\n      ...(assetsRef.current[index] || {}),\n      ...newAsset,\n    }\n    refreshAssets()\n  }\n  const removeAsset = (assetIndex) => {\n    assetsRef.current.splice(assetIndex, 1)\n    refreshAssets()\n  }\n\n  if (!mediaModalCallback) {\n    mediaModalCallback = () => {\n      const attachments = mediaModal.state().get('selection').toJSON()\n      // Previously accepted only one attachment\n      // const attachment = mediaModal.state().get('selection').first().toJSON()\n\n      console.log('Got attachments', attachments)\n\n      for (const attachment of attachments) {\n        // Ensure the same attachment is added only once\n        let skip = false\n        for (const asset of assetsRef.current) {\n          if (asset.id === attachment.id) {\n            skip = true\n            break\n          }\n        }\n        if (skip) continue\n\n        /**\n         * Extract attachment fields\n         */\n        const newAsset = [\n          'id',\n          // 'url',\n          'name',\n          'title',\n          'filename',\n          'mime',\n          'alt',\n          'caption',\n          'description',\n        ].reduce((obj, key) => {\n          obj[key] = attachment[key]\n          return obj\n        }, {})\n\n        addAsset(newAsset)\n      }\n    }\n  }\n\n  // Map of asset names to check for duplicates\n  const assetNameMap = {} // name => true\n\n  return (\n    <>\n      <input type=\"hidden\" name=\"assets\" ref={assetsElementRef} />\n\n      <div className=\"template-assets\">\n        {assetsState.map((asset, assetIndex) => {\n          const isDuplicate = assetNameMap[asset.name] ? true : false\n\n          if (!isDuplicate) {\n            assetNameMap[asset.name] = true\n          }\n\n          return (\n            <div key={`asset-${assetIndex}`} className=\"template-asset\">\n              <div className=\"template-asset-fields\">\n                <div className=\"template-asset-field template-asset-field--name\">\n                  <label>Name</label>\n\n                  <input\n                    type=\"text\"\n                    value={asset.name}\n                    onChange={(e) => {\n                      updateAsset(assetIndex, { name: e.target.value })\n                    }}\n                  />\n                </div>\n                <div className=\"template-asset-field template-asset-field--attachment\">\n                  <div>\n                    {isDuplicate && (\n                      <div className=\"template-asset--duplicate-name-message\">\n                        Duplicate name exists\n                      </div>\n                    )}\n                    ID:{' '}\n                    <a\n                      href={`post.php?post=${asset.id}&action=edit`}\n                      target=\"_blank\"\n                    >\n                      {asset.id}\n                    </a>, \n                    Title: {asset.title}, \n                    File name: <code>{asset.filename}</code>\n                    <br />\n                    {/* MIME type: <code>{ asset.mime }</code> */}\n                  </div>\n                </div>\n              </div>\n              <div className=\"template-asset-actions\">\n                <div className=\"template-asset-action template-asset-action--remove-asset\">\n                  <div className=\"icon\" onClick={() => removeAsset(assetIndex)}>\n                    <svg\n                      viewBox=\"0 0 1792 1792\"\n                      xmlns=\"http://www.w3.org/2000/svg\"\n                    >\n                      <path d=\"M1490 1322q0 40-28 68l-136 136q-28 28-68 28t-68-28l-294-294-294 294q-28 28-68 28t-68-28l-136-136q-28-28-28-68t28-68l294-294-294-294q-28-28-28-68t28-68l136-136q28-28 68-28t68 28l294 294 294-294q28-28 68-28t68 28l136 136q28 28 28 68t-28 68l-294 294 294 294q28 28 28 68z\" />\n                    </svg>\n                  </div>\n                </div>\n              </div>\n            </div>\n          )\n        })}\n      </div>\n\n      <button\n        type=\"button\"\n        className=\"button button--add-rule-group\"\n        onClick={() => openMediaModal()}\n      >\n        Add asset\n      </button>\n    </>\n  )\n}\n\nexport default AssetsEditor\n","/**\n * Template assets\n *\n * @see /includes/template/assets\n */\nimport React from 'react'\nimport { createRoot } from 'react-dom'\nimport AssetsEditor from './AssetsEditor'\n\nconst { jQuery: $ } = window\n\nconst el = document.getElementById('tangible_template_assets_editor')\n\nlet assets = $(el).data('assets')\nif (!Array.isArray(assets)) assets = []\n\ncreateRoot(el).render(<AssetsEditor assets={assets} />)\n"],"names":["useState","useRef","useEffect","v","r","d","a","g","n","b","C","q","i","A","f","l","c","m","u","N","p","e","o","createRoot","el"],"mappings":"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"}