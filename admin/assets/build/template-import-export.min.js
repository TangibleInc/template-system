(function(){"use strict";(function(){const t={env:{NODE_ENV:"production"}};try{if(process){process.env=Object.assign({},process.env),Object.assign(process.env,t);return}}catch(a){}globalThis.process={env:t}})();const{Tangible:{ajax:w}}=window,O="tangible_loops_and_logic__template_import_export__";var z=Object.defineProperty,K=Object.defineProperties,Q=Object.getOwnPropertyDescriptors,I=Object.getOwnPropertySymbols,U=Object.prototype.hasOwnProperty,W=Object.prototype.propertyIsEnumerable,D=(t,a,e)=>a in t?z(t,a,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[a]=e,b=(t,a)=>{for(var e in a||(a={}))U.call(a,e)&&D(t,e,a[e]);if(I)for(var e of I(a))W.call(a,e)&&D(t,e,a[e]);return t},P=(t,a)=>K(t,Q(a));function k({mode:t,inputStateRef:a,setInputState:e}){const{importData:l}=a.current;if(!l||!l.post_types){console.warn("Import data not found",l);return}const i=P(b({},l),{post_types:{},handle_duplicates:t});for(const{id:u,title:n,post_type:r}of a.current.duplicatesFound){const d=l.post_types[r].filter(s=>s.id===u)[0];if(!d){console.warn("Corresponding post not found",u,r,n);continue}i.post_types[r]||(i.post_types[r]=[]),i.post_types[r].push(d)}e(P(b({},a.current),{importData:{},importedData:{},duplicatesFound:[],duplicatesHandledMessage:"",message:""})),w(O+"import",i).then(u=>{const n=P(b({},i),{old_to_new_id:b(b({},a.current.old_to_new_id||{}),u.old_to_new_id||{})});console.log("Imported duplicates",n),e(P(b({},a.current),{importing:!1,importData:{},importedData:n,duplicatesFound:[],duplicatesHandledMessage:"",message:u.post_count+" template"+(u.post_count!==1?"s":"")+" imported"}))}).catch(u=>{e(P(b({},a.current),{duplicatesHandledMessage:"Error: "+u.message}))})}var G=Object.defineProperty,X=Object.defineProperties,Y=Object.getOwnPropertyDescriptors,N=Object.getOwnPropertySymbols,Z=Object.prototype.hasOwnProperty,ee=Object.prototype.propertyIsEnumerable,F=(t,a,e)=>a in t?G(t,a,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[a]=e,T=(t,a)=>{for(var e in a||(a={}))Z.call(a,e)&&F(t,e,a[e]);if(N)for(var e of N(a))ee.call(a,e)&&F(t,e,a[e]);return t},_=(t,a)=>X(t,Y(a));const h=(...t)=>console.log("[Importer]",...t),{FileReader:te}=window,S={tangible_template:"Templates",tangible_style:"Styles",tangible_script:"Scripts",tangible_layout:"Layouts",tangible_block:"Blocks"},ae=({useInput:t=!0,directImportData:a})=>{const[e,l]=Tangible.Preact.useState({importing:!1,importData:{},importedData:{},message:"",duplicatesFound:[],duplicatesHandledMessage:""}),i=()=>{l(_(T({},r.current),{importing:!0,importData:{},importedData:{},duplicatesFound:[],duplicatesHandledMessage:"",message:"Importing.."}))},u=s=>l(_(T({},r.current),{importing:!1,importData:{},importedData:{},duplicatesFound:[],duplicatesHandledMessage:"",message:"Error: "+s})),n=s=>{l(_(T({},r.current),{importData:s})),w(O+"import",s).then(o=>{h("Import success",o);const{importData:p}=r.current,g={post_types:Object.keys(p.post_types).reduce((c,m)=>{const v=o.duplicates_found.filter(f=>f.post_type===m).map(f=>f.id);return c[m]=p.post_types[m].filter(f=>v.indexOf(f.id)<0),c},{}),old_to_new_id:o.old_to_new_id||{}};h("Imported minus duplicates",g),l(_(T({},r.current),{importing:!1,duplicatesFound:o.duplicates_found,importData:o.duplicates_found.length?p:{},importedData:g,message:o.post_count+" template"+(o.post_count!==1?"s":"")+" imported"+(o.failed_post_count?" - "+o.failed_post_count+" template"+(o.failed_post_count!==1?"s":"")+" failed":"")}))}).catch(o=>{console.error(o),u(o.message)})};Tangible.Preact.useEffect(()=>{!a||(i(),n(a))},[]);const r=Tangible.Preact.useRef();r.current=e;const d=Tangible.Preact.useRef();return Tangible.Preact.createElement("div",{id:"importer"},t&&Tangible.Preact.createElement("p",null,Tangible.Preact.createElement("input",{type:"file",hidden:!0,ref:d,accept:".json,text/json",onChange:({target:{files:s}})=>{const o=s[0],p=new te;i(),p.onload=function(g){const c=g.target.result;try{const m=JSON.parse(c);h("Import data",m),n(m)}catch(m){h("Invalid JSON",c),u("Invalid JSON")}},p.onerror=function(g){u(g.message)},p.readAsText(o)}}),Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",disabled:e.importing,onClick:()=>{d.current&&d.current.click()}},"Import")),e.message&&Tangible.Preact.createElement("p",null,e.message),Object.keys(e.importedData.post_types||{}).map(s=>e.importedData.post_types[s]&&e.importedData.post_types[s].length>0&&Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("div",null,Tangible.Preact.createElement("b",null,S[s]||"Templates")),Tangible.Preact.createElement("ul",null,e.importedData.post_types[s].map((o,p)=>Tangible.Preact.createElement("li",{key:`post-${p}`},e.importedData.old_to_new_id&&e.importedData.old_to_new_id[o.id]?Tangible.Preact.createElement("a",{href:`post.php?post=${e.importedData.old_to_new_id[o.id]}&action=edit`},o.title):o.title))))),e.duplicatesFound.length>0&&Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("p",{style:{fontWeight:"bold",color:"red"}},e.duplicatesFound.length," duplicate template",e.duplicatesFound!==1?"s":""," found"),Object.keys(S).map(s=>{const o=e.duplicatesFound.filter(p=>p.post_type===s);if(o.length)return Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("div",null,Tangible.Preact.createElement("b",null,S[s]||"Templates")),Tangible.Preact.createElement("ul",null,o.map((p,g)=>Tangible.Preact.createElement("li",{key:`duplicate-post-${g}`},p.title))))}),Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",onClick:()=>{k({mode:"overwrite",inputStateRef:r,setInputState:l})}},"Overwrite"),"\xA0",Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",onClick:()=>{k({mode:"keep_both",inputStateRef:r,setInputState:l})}},"Keep both"),"\xA0",Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",onClick:()=>{l(_(T({},r.current),{importing:!1,importData:{},importedData:{},duplicatesFound:[],duplicatesHandledMessage:"",message:""}))}},"Skip"),e.duplicatesHandledMessage&&Tangible.Preact.createElement("p",null,e.duplicatesHandledMessage)))};var re=Object.defineProperty,R=Object.getOwnPropertySymbols,ne=Object.prototype.hasOwnProperty,le=Object.prototype.propertyIsEnumerable,C=(t,a,e)=>a in t?re(t,a,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[a]=e,oe=(t,a)=>{for(var e in a||(a={}))ne.call(a,e)&&C(t,e,a[e]);if(R)for(var e of R(a))le.call(a,e)&&C(t,e,a[e]);return t};const{jQuery:ce}=window,j=({labelForEmptyValue:t="",options:a=[],value:e="",onChange:l,multiSelect:i,style:u})=>{const n=Tangible.Preact.useRef();if(Tangible.Preact.useEffect(()=>{const r=ce(n.current);n.current.$el=r,l(e),r.tangibleSelect({minimumResultsForSearch:5}),i&&(r.val(e),r.trigger("change")),r.on("change",function(s){if(!i){l(s.target.value);return}if(!n.current)return;const o=r.select2("data").map(p=>p.id);l(o)});const d=n.current.select2=r.data("select2");return()=>{d&&d.destroy()}},[]),n.current&&n.current.$el)if(i){const r=n.current.$el.val();e.length!==r.length&&a.length&&setImmediate(function(){n.current.$el.val(e),n.current.$el.trigger("change")})}else n.current.value!==e&&(n.current.$el.val(e),n.current.$el.trigger("change"));return Tangible.Preact.createElement("select",{ref:n,autoComplete:"off",multiple:i,style:oe({display:"none",width:"160px"},u)},t&&Tangible.Preact.createElement("option",{value:"",disabled:!0,selected:e==null},t),a.map((r,d)=>Tangible.Preact.createElement("option",{key:`option-${d}`,value:r.value,selected:r.value===e},r.label)))};var ie=Object.defineProperty,M=Object.getOwnPropertySymbols,se=Object.prototype.hasOwnProperty,pe=Object.prototype.propertyIsEnumerable,q=(t,a,e)=>a in t?ie(t,a,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[a]=e,$=(t,a)=>{for(var e in a||(a={}))se.call(a,e)&&q(t,e,a[e]);if(M)for(var e of M(a))pe.call(a,e)&&q(t,e,a[e]);return t};const{isTangibleBlockEditorInstalled:ue=!1}=window.Tangible,me=({rule:t,ruleIndex:a,exportRulesRef:e,setExportRules:l,templateTypeItemOptionsRef:i,ensureTemplateTypeItemOptions:u})=>Tangible.Preact.createElement("div",{className:"export-rule"},Tangible.Preact.createElement("div",{className:"export-rule-part"},Tangible.Preact.createElement(j,$({},{labelForEmptyValue:"Select template type",options:[{label:"Template",value:"tangible_template"},{label:"Style",value:"tangible_style"},{label:"Script",value:"tangible_script"},{label:"Layout",value:"tangible_layout"},...ue?[{label:"Block",value:"tangible_block"}]:[]],value:t.field,onChange(n){t.field=n,e.current[a]=t,l(e.current)}}))),t.field&&Tangible.Preact.createElement("div",{className:"export-rule-part"},Tangible.Preact.createElement(j,$({},{options:[{label:"All",value:"all"},{label:"Include",value:"include"},{label:"Exclude",value:"exclude"}],value:t.operator,onChange(n){t.operator=n,n==="all"&&(t.values=[]),e.current[a]=t,l(e.current),n!=="all"&&u(t.field)},style:{width:"auto"}}))),t.field&&t.operator!=="all"&&i.current[t.field]&&Tangible.Preact.createElement("div",{className:"export-rule-part"},Tangible.Preact.createElement(j,$({},{options:i.current[t.field]instanceof Promise?[]:i.current[t.field],value:t.values,onChange(n){t.values=n,e.current[a]=t,l(e.current)},multiSelect:!0}))),Tangible.Preact.createElement("div",{className:"export-rule-part export-rule-part--remove-rule"},Tangible.Preact.createElement("div",{className:"icon",onClick:()=>{e.current.splice(a,1),l(e.current)}},Tangible.Preact.createElement("svg",{viewBox:"0 0 1792 1792",xmlns:"http://www.w3.org/2000/svg"},Tangible.Preact.createElement("path",{d:"M1490 1322q0 40-28 68l-136 136q-28 28-68 28t-68-28l-294-294-294 294q-28 28-68 28t-68-28l-136-136q-28-28-28-68t28-68l294-294-294-294q-28-28-28-68t28-68l136-136q28-28 68-28t68 28l294 294 294-294q28-28 68-28t68 28l136 136q28 28 28 68t-28 68l-294 294 294 294q28 28 28 68z"})))));function de(t){!window.localStorage||window.localStorage.setItem("exporterState",JSON.stringify(t))}function ge(){if(!window.localStorage)return;let t=window.localStorage.getItem("exporterState");if(t)try{return t=JSON.parse(t),t}catch(a){}}var be=Object.defineProperty,fe=Object.defineProperties,ye=Object.getOwnPropertyDescriptors,H=Object.getOwnPropertySymbols,ve=Object.prototype.hasOwnProperty,Pe=Object.prototype.propertyIsEnumerable,J=(t,a,e)=>a in t?be(t,a,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[a]=e,y=(t,a)=>{for(var e in a||(a={}))ve.call(a,e)&&J(t,e,a[e]);if(H)for(var e of H(a))Pe.call(a,e)&&J(t,e,a[e]);return t},L=(t,a)=>fe(t,ye(a));const Te=!1,A=(...t)=>Te,x=ge(),B=x&&x.name||"tangible-templates",_e=x&&x.rules||[{field:"tangible_template",operator:"all",values:[]}],Ee=()=>{const t=Tangible.Preact.useRef(),[a,e]=Tangible.Preact.useState(_e),l=Tangible.Preact.useRef();l.current=a;const i=c=>{e([...c])},[u,n]=Tangible.Preact.useState({}),r=Tangible.Preact.useRef();r.current=u;const[d,s]=Tangible.Preact.useState({exporting:!1,message:"",json:"",packageName:""}),o=Tangible.Preact.useRef();o.current=d;const p=c=>{s(y(y({},o.current),c))},g=async c=>{if(r.current[c])return;A("ensureTemplateTypeItemOptions",c,r.current);const m=w(O+"get_template_type_item_options",{post_type:c}).then(v=>{n(L(y({},r.current),{[c]:v}))}).catch(v=>{});n(L(y({},r.current),{[c]:m}))};return Tangible.Preact.createElement("div",{id:"exporter"},Tangible.Preact.createElement("div",{className:"export-name"},"Package name: ",Tangible.Preact.createElement("input",{type:"text",name:"name",defaultValue:B,ref:t})),Tangible.Preact.createElement("div",{className:"export-rules"},a.map((c,m)=>Tangible.Preact.createElement(me,y({key:`export-rule-${m}`},{rule:c,ruleIndex:m,exportRulesRef:l,setExportRules:i,templateTypeItemOptionsRef:r,ensureTemplateTypeItemOptions:g})))),Tangible.Preact.createElement("p",null,Tangible.Preact.createElement("button",{type:"button",className:"button button-secondary",onClick:()=>{l.current.push({field:"tangible_template",operator:"all",values:[]}),i(l.current)}},"Add export rule")),l.current.length>0&&Tangible.Preact.createElement("p",null,Tangible.Preact.createElement("button",{type:"button",className:"button button-primary",disabled:d.exporting,onClick:()=>{const c=t.current&&t.current.value||B;de({name:c,rules:l.current}),A("Export start",l.current),p({exporting:!0,message:"Exporting.."}),w(O+"export",{export_rules:l.current}).then(m=>{console.log("Export success",m),p({exporting:!1,message:""});const v=y({package_name:c},m),f=new Date().toISOString().slice(0,10).replace(/-/g,""),E=document.createElement("a");E.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(v,null,2)),E.download=`${c}-${f}.json`,E.style.display="none",document.body.appendChild(E),E.click()}).catch(m=>{console.error(m),p({exporting:!1,message:"Error: "+m.message})})}},"Export"),d.message&&Tangible.Preact.createElement("span",{style:{paddingLeft:"1rem"}},d.message)))},{Tangible:{Preact:we}}=window,V=document.getElementById("tangible_template_import_export_form");V.addEventListener("submit",function(t){t.preventDefault()}),we.render(Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("h1",{className:"wp-heading-inline"},"Import"),Tangible.Preact.createElement(ae,null),Tangible.Preact.createElement("hr",null),Tangible.Preact.createElement("h1",{className:"wp-heading-inline"},"Export"),Tangible.Preact.createElement(Ee,null)),V)})();
//# sourceMappingURL=template-import-export.min.js.map
