(function(){"use strict";(function(){const t={env:{NODE_ENV:"production"}};try{if(process){process.env=Object.assign({},process.env),Object.assign(process.env,t);return}}catch(r){}globalThis.process={env:t}})();var X=Object.defineProperty,N=Object.getOwnPropertySymbols,Y=Object.prototype.hasOwnProperty,Z=Object.prototype.propertyIsEnumerable,F=(t,r,e)=>r in t?X(t,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[r]=e,ee=(t,r)=>{for(var e in r||(r={}))Y.call(r,e)&&F(t,e,r[e]);if(N)for(var e of N(r))Z.call(r,e)&&F(t,e,r[e]);return t};const{jQuery:re}=window,C=({labelForEmptyValue:t="",options:r=[],value:e="",onChange:p,multiSelect:l,style:f})=>{const a=Tangible.Preact.useRef();if(Tangible.Preact.useEffect(()=>{const o=re(a.current);a.current.$el=o,p(e),o.tangibleSelect({minimumResultsForSearch:5}),l&&(o.val(e),o.trigger("change")),o.on("change",function(m){if(!l){p(m.target.value);return}if(!a.current)return;const g=o.select2("data").map(y=>y.id);p(g)});const b=a.current.select2=o.data("select2");return()=>{b&&b.destroy()}},[]),a.current&&a.current.$el)if(l){const o=a.current.$el.val();e.length!==o.length&&r.length&&setImmediate(function(){a.current.$el.val(e),a.current.$el.trigger("change")})}else a.current.value!==e&&(a.current.$el.val(e),a.current.$el.trigger("change"));return Tangible.Preact.createElement("select",{ref:a,autoComplete:"off",multiple:l,style:ee({display:"none",width:"160px"},f)},t&&Tangible.Preact.createElement("option",{value:"",disabled:!0,selected:e==null},t),r.map((o,b)=>Tangible.Preact.createElement("option",{key:`option-${b}`,value:o.value,selected:o.value===e},o.label)))};var te=Object.defineProperty,I=Object.getOwnPropertySymbols,ae=Object.prototype.hasOwnProperty,le=Object.prototype.propertyIsEnumerable,k=(t,r,e)=>r in t?te(t,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[r]=e,ne=(t,r)=>{for(var e in r||(r={}))ae.call(r,e)&&k(t,e,r[e]);if(I)for(var e of I(r))le.call(r,e)&&k(t,e,r[e]);return t};const oe=({rule:t,setRule:r,ruleProps:e,ensureData:p})=>{const{fieldOptions:l}=e;return Tangible.Preact.createElement("div",{className:"rule-part rule-field"},Tangible.Preact.createElement(C,ne({},{labelForEmptyValue:"Select location..",options:l,value:t.field,onChange(f){r({field:f})}})))};var ie=Object.defineProperty,G=Object.getOwnPropertySymbols,ce=Object.prototype.hasOwnProperty,ue=Object.prototype.propertyIsEnumerable,q=(t,r,e)=>r in t?ie(t,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[r]=e,se=(t,r)=>{for(var e in r||(r={}))ce.call(r,e)&&q(t,e,r[e]);if(G)for(var e of G(r))ue.call(r,e)&&q(t,e,r[e]);return t};const pe=!1,x=(...t)=>pe,{ajax:fe}=window.Tangible,be="tangible_loops_and_logic__template_location__",ge=({rule:t,ruleDefinitionByField:r,ajaxStateRef:e,setAjaxState:p})=>{if(!t.field)return;const l=r[t.field];if(l)for(const f of["field_2","values"]){if(!l[f])continue;let a=l[f][0];if(!a||a.type!=="select_ajax")continue;if(f==="values"){for(const c of l.values){if(!c.operators||c.operators.indexOf(t.operator)>=0){a=c;break}a=null}if(!a){x("No values select for operator",t.operator);return}}const o=e.current,b=a.ajax_action,m={};if(a.rule_properties_to_ajax){const c=a.rule_properties_to_ajax;for(const n in c){if(!t[n])return;m[c[n]]=t[n]}}if(a.ajax_properties){const c=a.ajax_properties;for(const n in c)m[n]=c[n]}a.getAjaxActionCacheKey||(a.getAjaxActionCacheKey=function(c){let n=b;if(a.rule_properties_to_ajax){const v=a.rule_properties_to_ajax;for(const i in v)n+="__"+v[i]+"__"+c[i]}return n},a.getOptionsForRule=function(c){const n=a.getAjaxActionCacheKey(c),v=e.current;if(v[n]&&!(v[n]instanceof Promise))return x("Got options for key",n,v[n]),v[n]});const g=a.getAjaxActionCacheKey(t),y=c=>{x("updatePartDefinition",e.current),p(se({},e.current))};if(!o[g]){const c=be+b;o[g]=fe(c,m).then(n=>(e.current[g]=n,x("Got data",g,e.current[g]),y(),n)).catch(n=>{});return}if(o[g]instanceof Promise)return}};var ve=Object.defineProperty,de=Object.defineProperties,me=Object.getOwnPropertyDescriptors,B=Object.getOwnPropertySymbols,ye=Object.prototype.hasOwnProperty,Pe=Object.prototype.propertyIsEnumerable,K=(t,r,e)=>r in t?ve(t,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[r]=e,_=(t,r)=>{for(var e in r||(r={}))ye.call(r,e)&&K(t,e,r[e]);if(B)for(var e of B(r))Pe.call(r,e)&&K(t,e,r[e]);return t},M=(t,r)=>de(t,me(r));const Oe=!1,J=(...t)=>Oe,je=({ruleGroups:t,setRuleGroups:r,group:e,groupIndex:p,rule:l,ruleIndex:f,ruleProps:a})=>{const o=Tangible.Preact.useRef();o.current=l;const{ruleDefinitionByField:b,ajaxStateRef:m,setAjaxState:g}=a,y=(i={})=>{e[f]=_(_({},l),i),t[p]=e,r()},c=Tangible.Preact.useCallback(()=>{ge({rule:l,ruleDefinitionByField:b,ajaxStateRef:m,setAjaxState:g})},[l]);c();const n=l.field&&b[l.field],v=i=>{if(!n||!n[i])return;let u=n[i][0];if(!(i==="operators"||u&&(u.type==="select"||u.type==="select_ajax"))){const{type:s,placeholder:E,description:$}=u||{};if(s==="input"){let w=l[i];return Tangible.Preact.createElement("div",{className:`rule-part rule-${i}`},Tangible.Preact.createElement("input",{type:"text",placeholder:E,value:w,onChange:R=>{const T=o.current;y(M(_({},T),{[i]:R.target.value}))}}),$&&Tangible.Preact.createElement("small",{style:{display:"block"}},$))}return}if(i==="values"){for(const s of n.values){if(!s.operators||s.operators.indexOf(l.operator)>=0){u=s;break}u=null}if(!u){J("No values select for operator",l.operator);return}}const d=i==="operators",P=d?"operator":i.replace(/values/,"value"),S=d||l.operator==="exclude"?"":u.label_for_empty_value,O=d?n[i].filter(s=>!s.field_2||s.field_2.indexOf(l.field_2)>=0).map(s=>({value:s.name,label:s.label})):u.getOptionsForRule?u.getOptionsForRule(l):u.options;if(!O)return;let j=l[P];return!u.multi_select&&!j&&!S&&O[0]&&O[0].value&&(j=l[P]=O[0].value,y(l)),J("partSelect",P,l[P]),Tangible.Preact.createElement("div",{className:`rule-part rule-${i}`},Tangible.Preact.createElement(C,_({},{labelForEmptyValue:S,options:O,value:j,onChange(s){const E=o.current,$=M(_({},E),{[P]:s});y($)},multiSelect:!d&&u.multi_select,style:d?{width:"auto"}:{}})))};return Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("div",{className:"rule"},Tangible.Preact.createElement("div",{className:"rule-parts"},Tangible.Preact.createElement(oe,_({},{rule:l,setRule:y,ruleProps:a,ensureData:c})),v("field_2"),n&&(!n.field_2||l.field_2)&&v("operators"),n&&(!n.field_2||l.field_2)&&v("values")),Tangible.Preact.createElement("div",{className:"rule-actions"},Tangible.Preact.createElement("div",{className:"rule-action rule-action--remove-rule"},Tangible.Preact.createElement("div",{className:"icon",onClick:()=>{e.splice(f,1),e.length?t[p]=e:t.splice(p,1),r()}},Tangible.Preact.createElement("svg",{viewBox:"0 0 1792 1792",xmlns:"http://www.w3.org/2000/svg"},Tangible.Preact.createElement("path",{d:"M1490 1322q0 40-28 68l-136 136q-28 28-68 28t-68-28l-294-294-294 294q-28 28-68 28t-68-28l-136-136q-28-28-28-68t28-68l294-294-294-294q-28-28-28-68t28-68l136-136q28-28 68-28t68 28l294 294 294-294q28-28 68-28t68 28l136 136q28 28 28 68t-28 68l-294 294 294 294q28 28 28 68z"})))))),n&&n.description&&Tangible.Preact.createElement("p",{dangerouslySetInnerHTML:{__html:n.description}}))};var $e=Object.defineProperty,Q=Object.getOwnPropertySymbols,_e=Object.prototype.hasOwnProperty,Te=Object.prototype.propertyIsEnumerable,V=(t,r,e)=>r in t?$e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[r]=e,he=(t,r)=>{for(var e in r||(r={}))_e.call(r,e)&&V(t,e,r[e]);if(Q)for(var e of Q(r))Te.call(r,e)&&V(t,e,r[e]);return t};const Ee=()=>[{}],we=({ruleGroups:t,setRuleGroups:r,ruleProps:e})=>Tangible.Preact.createElement(Tangible.Preact.Fragment,null,Tangible.Preact.createElement("div",{className:"rule-groups"},t.map((p,l)=>Tangible.Preact.createElement("div",{key:`rule-group-${l}`,className:"rule-group"},p.map((f,a)=>Tangible.Preact.createElement(je,he({key:`rule-group-${l}-rule-${a}`},{ruleGroups:t,setRuleGroups:r,group:p,groupIndex:l,rule:f,ruleIndex:a,ruleProps:e})))))),Tangible.Preact.createElement("button",{type:"button",className:"button button--add-rule-group",onClick:()=>{t.push(Ee()),r(t)}},"Add location"));var xe=Object.defineProperty,Se=Object.defineProperties,Re=Object.getOwnPropertyDescriptors,z=Object.getOwnPropertySymbols,Ae=Object.prototype.hasOwnProperty,De=Object.prototype.propertyIsEnumerable,H=(t,r,e)=>r in t?xe(t,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[r]=e,L=(t,r)=>{for(var e in r||(r={}))Ae.call(r,e)&&H(t,e,r[e]);if(z)for(var e of z(r))De.call(r,e)&&H(t,e,r[e]);return t},Ne=(t,r)=>Se(t,Re(r));const{jQuery:A}=window,Fe=({data:t,ruleDefinitions:r})=>{const[e,p]=Tangible.Preact.useState(t),l=Tangible.Preact.useRef();l.current=e;const[f,a]=Tangible.Preact.useState({}),o=Tangible.Preact.useRef();o.current=f;const b=Tangible.Preact.useRef(),m=Tangible.Preact.useRef(),{rule_groups:g=[]}=e,y=()=>p(i=>Ne(L({},i),{rule_groups:g})),{fieldOptions:c,ruleDefinitionByField:n}=Tangible.Preact.useMemo(()=>{const i=[],u={};return r.forEach(d=>{i.push({value:d.name,label:d.label}),u[d.name]=d}),{fieldOptions:i,ruleDefinitionByField:u}},[]),v={ruleDefinitions:r,fieldOptions:c,ruleDefinitionByField:n,ajaxStateRef:o,setAjaxState:a};return Tangible.Preact.useEffect(()=>{let i="";const u=A(b.current).find(".rule");for(let P=0,S=u.length;P<S;P++){const O=A(u[P]).find(".rule-part");let j="";for(let s=0,E=O.length;s<E;s++){const $=A(O[s]),w=$.find("select");if(!w[0]){const T=$.find("input");T&&(j+=(s>0?" ":"")+T.val());continue}if(!w[0].select2)continue;const R=w.select2("data");!Array.isArray(R)||(j+=(s>0?" ":"")+R.map(T=>T.text).join(", "))}i+=(P>0?"<br>":"")+j}const d=l.current;d.description=i,m.current.value=JSON.stringify(d)}),Tangible.Preact.createElement("div",{ref:b},Tangible.Preact.createElement("input",{type:"hidden",name:"location",ref:m,value:JSON.stringify(e)}),Tangible.Preact.createElement(we,L({},{ruleGroups:g,setRuleGroups:y,ruleProps:v})))};var Ce=Object.defineProperty,U=Object.getOwnPropertySymbols,Ie=Object.prototype.hasOwnProperty,ke=Object.prototype.propertyIsEnumerable,W=(t,r,e)=>r in t?Ce(t,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[r]=e,Ge=(t,r)=>{for(var e in r||(r={}))Ie.call(r,e)&&W(t,e,r[e]);if(U)for(var e of U(r))ke.call(r,e)&&W(t,e,r[e]);return t};const{jQuery:qe,Tangible:{Preact:Be}}=window,D=qe("#post .template-location-editor"),Ke=D[0];let h=D.data("location");h=typeof h=="object"&&!Array.isArray(h)?h:{};const Me=D.data("ruleDefinitions")||[];Be.render(Tangible.Preact.createElement(Fe,Ge({},{data:h,ruleDefinitions:Me})),Ke)})();
//# sourceMappingURL=template-location-editor.min.js.map
